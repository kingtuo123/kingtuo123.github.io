<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="翻译自 Makefile Tutorial，部分有增删或修改，仅供参考。 Makefile 语法 makefile 由一组规则组成。如下所示： 1 2 3 4 targets: prerequisites command command command targets 是文件名，以空格分隔。通常一个规"><title>Makefile基础</title><link rel=canonical href=https://kingtuo123.com/p/makefile%E5%9F%BA%E7%A1%80/><link rel=stylesheet href=/scss/style.min.98900bb61dfc6c73b10eb20270c2e3164662a9c878511f3a9cb1b8cd1cc85690.css><meta property="og:title" content="Makefile基础"><meta property="og:description" content="翻译自 Makefile Tutorial，部分有增删或修改，仅供参考。 Makefile 语法 makefile 由一组规则组成。如下所示： 1 2 3 4 targets: prerequisites command command command targets 是文件名，以空格分隔。通常一个规"><meta property="og:url" content="https://kingtuo123.com/p/makefile%E5%9F%BA%E7%A1%80/"><meta property="og:site_name" content="kingtuo123"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="makefile"><meta property="article:published_time" content="2022-05-01T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-01T00:00:00+00:00"><meta name=twitter:title content="Makefile基础"><meta name=twitter:description content="翻译自 Makefile Tutorial，部分有增删或修改，仅供参考。 Makefile 语法 makefile 由一组规则组成。如下所示： 1 2 3 4 targets: prerequisites command command command targets 是文件名，以空格分隔。通常一个规"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hud329c9971c353ea4bc5df4e784289bf9_479107_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>😐</span></figure><div class=site-meta><h1 class=site-name><a href=/>kingtuo123</a></h1><h2 class=site-description>去码头整点薯条！</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/linux/>linux</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/makefile%E5%9F%BA%E7%A1%80/>Makefile基础</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>May 01, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 11 分钟</time></div></footer></div></header><section class=article-content><blockquote><p>翻译自 <a class=link href=https://makefiletutorial.com/#getting-started target=_blank rel=noopener>Makefile Tutorial</a>，部分有增删或修改，仅供参考。</p></blockquote><h2 id=makefile-语法>Makefile 语法</h2><p>makefile 由一组规则组成。如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>targets</span><span class=o>:</span> <span class=n>prerequisites</span>
</span></span><span class=line><span class=cl>    <span class=nb>command</span>
</span></span><span class=line><span class=cl>    <span class=nb>command</span>
</span></span><span class=line><span class=cl>    <span class=nb>command</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><p>targets 是文件名，以空格分隔。通常一个规则只有一个目标。</p></li><li><p>command 通常是用于生成 targets 的一系列步骤。以 Tab 开头。</p></li><li><p>prerequisites 也是文件名，以空格分隔。这些文件也称为 <strong>依赖</strong> ，需要在执行 command 之前存在。</p></li></ul><h2 id=示例>示例</h2><p>下面的 makefile 由三个单独的规则组成。当你在终端执行 <code>make blah</code> ，会以下面步骤运行并生成 <code>blan</code> 文件：</p><ul><li>make 以 <code>blah</code> 作为目标，所以它首先搜索这个目标。</li><li><code>blah</code> 需要 <code>blah.o</code> ，make 会搜索 <code>blah.o</code> 。</li><li><code>blah.o</code> 需要 <code>blah.c</code> ，make会搜索 <code>blah.c</code> 。</li><li><code>blah.c</code> 不需要依赖，所以会执行 <code>echo</code> 命令，生成 <code>blah.c</code> 。</li><li><code>blah.o</code> 的依赖满足，会执行 <code>cc -c</code> 命令，生成 <code>blah.o</code> 。</li><li><code>blah</code> 的依赖满足，会执行 <code>cc</code> 命令，生成 <code>blah</code> 。</li><li><code>blah</code> 即编译好的C程序。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>blah</span><span class=o>:</span> <span class=n>blah</span>.<span class=n>o</span>
</span></span><span class=line><span class=cl>    cc blah.o -o blah <span class=c1># 第三个运行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>blah.o</span><span class=o>:</span> <span class=n>blah</span>.<span class=n>c</span>
</span></span><span class=line><span class=cl>    cc -c blah.c -o blah.o <span class=c1># 第二个运行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>blah.c</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;int main() { return 0; }&#34;</span> &gt; blah.c <span class=c1># 第一个运行</span>
</span></span></code></pre></td></tr></table></div></div><p>下面这个 makefile 有一个目标 <code>some_file</code> 。默认目标是第一个目标，所以将执行 <code>some_file</code> 下的 <code>echo</code> 命令。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>some_file</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;This line will always print&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>下面这个 makefile 第一次运行会生成 <code>some_file</code> 。第二次运行由于 <code>some_file</code> 已存在，会提示 <code>make: 'some_file' is up to date</code> 。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>some_file</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;This line will only print once&#34;</span>
</span></span><span class=line><span class=cl>    touch some_file
</span></span></code></pre></td></tr></table></div></div><p>下面这个 makefile 中 <code>some_file</code> 依赖 <code>other_file</code> 。当第一次执行 <code>make</code> ，默认目标是 <code>some_file</code> ，它首先会查找依赖文件 <code>other_file</code> ，只要依赖文件比目标文件 <code>some_file</code> 新，它就会执行这个依赖文件的规则，最后在执行自身的规则。所以当第二次执行时，两条规则下的命令都不会被执行，因为目标文件已存在。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>some_file</span><span class=o>:</span> <span class=n>other_file</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;This will run second, because it depends on other_file&#34;</span>
</span></span><span class=line><span class=cl>    touch some_file
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>other_file</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;This will run first&#34;</span>
</span></span><span class=line><span class=cl>    touch other_file
</span></span></code></pre></td></tr></table></div></div><p>下面这个 <code>makefile</code> 始终会执行默认目标的命令，因为它的依赖始终无法满足。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>some_file</span><span class=o>:</span> <span class=n>other_file</span>
</span></span><span class=line><span class=cl>    touch some_file
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>other_file</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;nothing&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>clean</code> 常被用来清理一些生成的文件，但它在 make 中并不是一个特殊的词。（一般都是约定俗成的，大家习惯用 clean 清理文件）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>some_file</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    touch some_file
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -f some_file
</span></span></code></pre></td></tr></table></div></div><h2 id=变量>变量</h2><p>变量只是字符串。类似C语言中的宏定义，运行make的时候会自动替换。</p><p>使用 <code>$( )</code> 调用或 <code>${ }</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>obj = a.o b.o c.o
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>test: $(obj)
</span></span><span class=line><span class=cl>    gcc -o test $(obj)
</span></span></code></pre></td></tr></table></div></div><p>变量赋值一般有如下符号：</p><div class=table-wrapper><table><thead><tr><th style=text-align:center>符号</th><th>作用</th></tr></thead><tbody><tr><td style=text-align:center>=</td><td>变量赋值，仅在使用命令时查找变量并替换，而不是在定义时查找替换。</td></tr><tr><td style=text-align:center>:=</td><td>变量赋值，与普通的编程语言中的赋值一样。</td></tr><tr><td style=text-align:center>+=</td><td>变量追加赋值</td></tr><tr><td style=text-align:center>?=</td><td>变量为空则给它赋值</td></tr></tbody></table></div><p><code>=</code> 与 <code>:=</code> 的区别：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># 这条会在下面打印出 later
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>one</span> <span class=o>=</span> one <span class=si>${</span><span class=nv>later_variable</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=c># 这条不会打印出 later
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>two</span> <span class=o>:=</span> two <span class=si>${</span><span class=nv>later_variable</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>later_variable</span> <span class=o>=</span> later
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>one<span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>two<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>:=</code> 允许你追加变量，但会导致死循环，如下。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>one</span> <span class=o>=</span> hello
</span></span><span class=line><span class=cl><span class=c># one gets defined as a simply expanded variable (:=) and thus can handle appending
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>one</span> <span class=o>:=</span> <span class=si>${</span><span class=nv>one</span><span class=si>}</span> there
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>one<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>?=</code> 仅设置尚未设置的变量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>one</span> <span class=o>=</span> hello
</span></span><span class=line><span class=cl><span class=nv>one</span> <span class=o>?=</span> will not be <span class=nb>set</span>
</span></span><span class=line><span class=cl><span class=nv>two</span> <span class=o>?=</span> will be <span class=nb>set</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>one<span class=k>)</span> <span class=c1># 打印 hello</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>two<span class=k>)</span> <span class=c1># 打印 will be set</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=目标>目标</h2><p>makefile 以第一个规则的目标为默认目标，通常只有一个。</p><p>以下 makefile 使用 <code>all</code> 可以生成多个目标。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=n>one</span> <span class=n>two</span> <span class=n>three</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>one</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch one
</span></span><span class=line><span class=cl><span class=nf>two</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch two
</span></span><span class=line><span class=cl><span class=nf>three</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch three
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -f one two three
</span></span></code></pre></td></tr></table></div></div><h2 id=通配符>通配符</h2><div class=table-wrapper><table><thead><tr><th style=text-align:center>通配符</th><th>作用</th></tr></thead><tbody><tr><td style=text-align:center>*</td><td>匹配零或多个字符</td></tr><tr><td style=text-align:center>%</td><td>匹配一个或多个字符</td></tr><tr><td style=text-align:center>?</td><td>匹配单个字符</td></tr></tbody></table></div><p><code>*</code> 和 <code>%</code> 在 makefile 中都是通配符，但它们的含义完全不同。</p><p><code>*</code> 会搜索你的文件系统来匹配文件名。个人建议调用 <code>wildcard</code> 函数来使用 <code>*</code> 。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># 打印出当前路径下所有以.c结尾的文件的信息
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>print</span><span class=o>:</span> <span class=k>$(</span><span class=nv>wildcard</span> *.<span class=nv>c</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    ls -la  <span class=nv>$?</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>危险：不要在变量定义中使用 <code>*</code> 。</p><p>危险：当 <code>*</code> 没有匹配到文件时，它会保持原样（作为一个字符串）除非使用 <code>wildcard</code> 函数。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>thing_wrong</span> <span class=o>:=</span> *.o <span class=c1># 不要这样做，&#39;*&#39; 不会被展开，会被视作 &#34;*.o&#34; 字符串</span>
</span></span><span class=line><span class=cl><span class=nv>thing_right</span> <span class=o>:=</span> <span class=k>$(</span>wildcard *.o<span class=k>)</span> <span class=c1># 正确做法</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=n>one</span> <span class=n>two</span> <span class=n>three</span> <span class=n>four</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 这里会出错，因为 $(thing_wrong) 是字符串 &#34;*.o&#34;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>one</span><span class=o>:</span> <span class=k>$(</span><span class=nv>thing_wrong</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 如果没有文件以 &#34;.o&#34; 结尾，匹配不到文件时也会被视作字符串 &#34;*.o&#34;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>two</span><span class=o>:</span> *.<span class=n>o</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 正确运行
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>three</span><span class=o>:</span> <span class=k>$(</span><span class=nv>thing_right</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 同规则 &#34;three&#34;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>four</span><span class=o>:</span> <span class=k>$(</span><span class=nv>wildcard</span> *.<span class=nv>o</span><span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=自动化变量>自动化变量</h2><div class=table-wrapper><table><thead><tr><th style=text-align:center>符号</th><th>描述</th></tr></thead><tbody><tr><td style=text-align:center>$@</td><td>当前目标名</td></tr><tr><td style=text-align:center>$^</td><td>所有依赖名，去重</td></tr><tr><td style=text-align:center>$&lt;</td><td>第一个依赖名</td></tr><tr><td style=text-align:center>$+</td><td>所有依赖名，不去重</td></tr><tr><td style=text-align:center>$?</td><td>比目标新的依赖名</td></tr><tr><td style=text-align:center>$*</td><td>目标中%匹配的部分</td></tr></tbody></table></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>hey</span><span class=o>:</span> <span class=n>one</span> <span class=n>two</span>
</span></span><span class=line><span class=cl>    <span class=c1># 输出 &#34;hey&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 输出比目标新的依赖名</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$?</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 输出所有依赖名</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> $^
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    touch hey
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>one</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch one
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>two</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch two
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -f hey one two
</span></span></code></pre></td></tr></table></div></div><h2 id=规则>规则</h2><h3 id=隐式规则>隐式规则</h3><p>隐式规则会让东西变得混乱，不推荐使用，但是要了解。</p><ul><li>编译 C 程序： <code>n.o</code> 由 <code>n.c</code> 自动生成，命令形式为 <code>$(CC) -c $(CPPFLAGS) $(CFLAGS)</code></li><li>编译 C++ 程序：<code>n.o</code> 由 <code>n.cc</code> 或 <code>n.cpp</code> 自动生成，命令形式为 <code>$(CXX) -c $(CPPFLAGS) $(CXXFLAGS)</code></li><li>链接单个目标文件： <code>n</code> 是通过运行命令 <code>$(CC) $(LDFLAGS) n.o $(LOADLIBES) $(LDLIBS)</code> 从 <code>n.o</code> 自动生成的</li></ul><p>隐式规则常用的几个变量：</p><ul><li><code>CC</code> ：C 程序编译器，默认 <code>cc</code> 。</li><li><code>CXX</code> ：C++ 程序编译器，默认 <code>g++</code> 。</li><li><code>CFLAGS</code> ：提供给 C 编译器的参数。</li><li><code>CXXFLAGS</code> ：提供给 C++ 编译器的参数。</li><li><code>CPPFLAGS</code> ：提供给 C 预处理器的参数。</li><li><code>LDFLAGS</code> ：当编译器调用链接器时提供给编译器的额外参数。</li></ul><p>下面这个例子无需明确告诉 Make 如何进行编译，就可以构建一个 C 程序。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>CC</span> <span class=o>=</span> gcc <span class=c1># 隐式规则的默认编译器</span>
</span></span><span class=line><span class=cl><span class=nv>CFLAGS</span> <span class=o>=</span> -g <span class=c1># 编译器参数，-g 启用调试信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 隐式规则 #1：blah 是通过 C 链接器隐式规则构建的
</span></span></span><span class=line><span class=cl><span class=c># 隐式规则 #2：blah.o 是通过 C 编译隐式规则构建的，因为 blah.c 存在
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>blah</span><span class=o>:</span> <span class=n>blah</span>.<span class=n>o</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>blah.c</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;int main() { return 0; }&#34;</span> &gt; blah.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -f blah*
</span></span></code></pre></td></tr></table></div></div><h3 id=静态模式规则>静态模式规则</h3><p>下面是语法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>targets...</span><span class=o>:</span> <span class=n>target</span>-<span class=n>pattern</span>: <span class=n>prereq</span>-<span class=n>patterns</span> ...
</span></span><span class=line><span class=cl>    commands
</span></span></code></pre></td></tr></table></div></div><p><code>target-pattern</code> 会匹配 <code>targets</code> 中的文件名（通过 % 通配符），如 <code>%.o</code> 匹配 <code>foo.o</code> ，匹配到的词干为 <code>foo</code> ，然后将 <code>foo</code> 替换进 <code>prereq-patterns</code> 的 <code>%</code> 中。</p><p>下面的例子是手动编写规则生成目标文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>objects</span> <span class=o>=</span> foo.o bar.o all.o
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=k>$(</span><span class=nv>objects</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 这些目标文件通过隐式规则编译
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>foo.o</span><span class=o>:</span> <span class=n>foo</span>.<span class=n>c</span>
</span></span><span class=line><span class=cl><span class=nf>bar.o</span><span class=o>:</span> <span class=n>bar</span>.<span class=n>c</span>
</span></span><span class=line><span class=cl><span class=nf>all.o</span><span class=o>:</span> <span class=n>all</span>.<span class=n>c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all.c</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;int main() { return 0; }&#34;</span> &gt; all.c
</span></span><span class=line><span class=cl><span class=c># %.c 会匹配 foo.c 和 bar.c ，没有则创建
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>%.c</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -f *.c *.o all
</span></span></code></pre></td></tr></table></div></div><p>下面的例子是通过静态模式规则生成目标文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>objects</span> <span class=o>=</span> foo.o bar.o all.o
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=k>$(</span><span class=nv>objects</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 这个例子中，%.o 会匹配 targets 中的 foo.o bar.o all.o
</span></span></span><span class=line><span class=cl><span class=c># 取出匹配到的词干 foo bar all
</span></span></span><span class=line><span class=cl><span class=c># 将词干替换进 %.c 中的 % ，即 foo.c bar.c all.c
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>$(objects)</span><span class=o>:</span> %.<span class=n>o</span>: %.<span class=n>c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all.c</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;int main() { return 0; }&#34;</span> &gt; all.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>%.c</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -f *.c *.o all
</span></span></code></pre></td></tr></table></div></div><p>静态模式规则和 filter 函数搭配使用，如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>obj_files</span> <span class=o>=</span> foo.result bar.o lose.o
</span></span><span class=line><span class=cl><span class=nv>src_files</span> <span class=o>=</span> foo.raw bar.c lose.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>all</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=k>$(</span><span class=nv>obj_files</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=c># filter 函数会匹配 obj_files 中的 bar.o lose.o
</span></span></span><span class=line><span class=cl><span class=c># bar.o lose.o 由静态模式规则替换成 bar.c lose.c
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>$(filter %.o,$(obj_files))</span><span class=o>:</span> %.<span class=n>o</span>: %.<span class=n>c</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;target: </span><span class=nv>$@</span><span class=s2> prereq: </span>$<span class=s2>&lt;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># filter 函数会匹配 obj_files 中的 foo.result
</span></span></span><span class=line><span class=cl><span class=c># foo.result 由静态模式规则替换成 foo.raw
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>$(filter %.result,$(obj_files))</span><span class=o>:</span> %.<span class=n>result</span>: %.<span class=n>raw</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;target: </span><span class=nv>$@</span><span class=s2> prereq: </span>$<span class=s2>&lt;&#34;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>%.c %.raw</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -f <span class=k>$(</span>src_files<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=模式规则>模式规则</h3><p>先看一个例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># 这个模式规则将每个 .c 文件编译为 .o 文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>%.o </span><span class=o>:</span> %.<span class=n>c</span>
</span></span><span class=line><span class=cl>    <span class=k>$(</span>CC<span class=k>)</span> -c <span class=k>$(</span>CFLAGS<span class=k>)</span> <span class=k>$(</span>CPPFLAGS<span class=k>)</span> $&lt; -o <span class=nv>$@</span>
</span></span></code></pre></td></tr></table></div></div><p>模式规则在目标中包含一个 <code>%</code> 。这个 <code>%</code> 匹配任何非空字符串，其他字符匹配它们自己。模式规则的先决条件中的 <code>%</code> 代表与目标中的 <code>%</code> 匹配的相同词干。</p><p>再看另一个例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># 定义一个没有先决条件的模式规则
</span></span></span><span class=line><span class=cl><span class=c># $@ 表示目标文件
</span></span></span><span class=line><span class=cl><span class=c># 当需要时会创建一个空的 .c 文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>%.c</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch <span class=nv>$@</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=双冒号规则>双冒号规则</h3><p>双冒号规则很少使用，但允许为同一个目标定义多个规则。如果这些是单冒号，则会打印一条警告，并且只会运行第二组命令。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=n>blah</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>blah</span><span class=o>::</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;hello&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>blah</span><span class=o>::</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;hello again&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=命令>命令</h2><h3 id=不打印命令>不打印命令</h3><p>在命令前加 <code>@</code> ，在运行时这条命令不会被打印出来。在 <code>make</code> 时加上 <code>-s</code> 参数有同样的效果。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>all: 
</span></span><span class=line><span class=cl>    @echo &#34;This make line will not be printed&#34;
</span></span><span class=line><span class=cl>    echo &#34;But this will&#34;
</span></span></code></pre></td></tr></table></div></div><h3 id=命令执行>命令执行</h3><p>每个命令都在一个新的 shell 中运行。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    <span class=nb>cd</span> ..
</span></span><span class=line><span class=cl>    <span class=c1># cd 命令不会影响下面这条命令，应为两条命令是在两个shell中运行的</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=sb>`</span><span class=nb>pwd</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 如果你想要 cd 命令影响下一条命令，可以在同一行以 ; 间隔</span>
</span></span><span class=line><span class=cl>    <span class=nb>cd</span> ..<span class=p>;</span><span class=nb>echo</span> <span class=sb>`</span><span class=nb>pwd</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 同上，这里使用 \ 换行</span>
</span></span><span class=line><span class=cl>    <span class=nb>cd</span> ..<span class=p>;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nb>echo</span> <span class=sb>`</span><span class=nb>pwd</span><span class=sb>`</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=默认-shell>默认 shell</h3><p>默认的 shell 是 <code>/bin/sh</code> ，你可以通过 <code>SHELL</code> 变量修改。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>SHELL</span><span class=o>=</span>/bin/bash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>cool</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Hello from bash&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=错误处理>错误处理</h3><p>在运行 make 时添加 <code>-k</code> 参数（&ndash;keep-going）以在遇到错误时继续运行（错误信息会被打印）。</p><p>在运行 make 时添加 <code>-i</code> 参数 （&ndash;ignore-errors），执行过程中忽略规则命令执行的错误（错误信息不会被打印）。</p><p>在命令前添加 <code>-</code> 以忽略错误 ，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>one</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 这条错误信息不会被打印，make会继续执行下去</span>
</span></span><span class=line><span class=cl>    -false
</span></span><span class=line><span class=cl>    touch one
</span></span></code></pre></td></tr></table></div></div><h3 id=中断-make>中断 make</h3><p>使用 <code>ctrl+c</code> ，它会中断 make 并删除新生成的目标文件。</p><h3 id=嵌套执行-make>嵌套执行 make</h3><p>要递归调用 makefile，请使用特殊的 $(MAKE) 而不是 make，因为它可以传递 make 的参数并且本身不会受到它们的影响。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># 双引号中的内容等同于
</span></span></span><span class=line><span class=cl><span class=c># hello: 
</span></span></span><span class=line><span class=cl><span class=c># 		touch inside_file
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>new_contents</span> <span class=o>=</span> <span class=s2>&#34;hello:\n\ttouch inside_file&#34;</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    mkdir -p subdir
</span></span><span class=line><span class=cl>    <span class=nb>printf</span> <span class=k>$(</span>new_contents<span class=k>)</span> <span class=p>|</span> sed -e <span class=s1>&#39;s/^ //&#39;</span> &gt; subdir/makefile <span class=c1>#去掉第一行的空格并写入subdir/makefile</span>
</span></span><span class=line><span class=cl>    <span class=nb>cd</span> subdir <span class=o>&amp;&amp;</span> <span class=k>$(</span>MAKE<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -rf subdir
</span></span></code></pre></td></tr></table></div></div><h3 id=使用-export-嵌套>使用 export 嵌套</h3><p>使用 make 嵌套执行的时候，变量是否传递也是我们需要注意的。如果需要变量的传递，那么可以这样来使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>new_contents</span> <span class=o>=</span> <span class=s2>&#34;hello:\n\\techo \$</span><span class=k>$(</span>cooly<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    mkdir -p subdir
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>new_contents<span class=k>)</span> <span class=p>|</span> sed -e <span class=s1>&#39;s/^ //&#39;</span> &gt; subdir/makefile
</span></span><span class=line><span class=cl>    @echo <span class=s2>&#34;---MAKEFILE CONTENTS---&#34;</span>
</span></span><span class=line><span class=cl>    @cd subdir <span class=o>&amp;&amp;</span> cat makefile
</span></span><span class=line><span class=cl>    @echo <span class=s2>&#34;---END MAKEFILE CONTENTS---&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>cd</span> subdir <span class=o>&amp;&amp;</span> <span class=k>$(</span>MAKE<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 注意输出的信息，可以看到 export 全局声明起到了作用
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>cooly</span> <span class=o>=</span> <span class=s2>&#34;The subdirectory can see me!&#34;</span>
</span></span><span class=line><span class=cl><span class=k>export</span> <span class=nv>cooly</span>
</span></span><span class=line><span class=cl><span class=c># 取消全局: unexport cooly
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -rf subdir
</span></span></code></pre></td></tr></table></div></div><p>你也可以在 shell 中使用全局变量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>one</span><span class=o>=</span>this will only work locally
</span></span><span class=line><span class=cl><span class=k>export </span><span class=nv>two</span><span class=o>=</span>we can run subcommands with this
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    @echo <span class=k>$(</span>one<span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># $$ 的意思是使用真实的 $ 符号</span>
</span></span><span class=line><span class=cl>    <span class=c1># 即 echo $one，由于one未声明全局环境变量，所以这条打印为空</span>
</span></span><span class=line><span class=cl>    @echo <span class=nv>$$</span>one
</span></span><span class=line><span class=cl>    @echo <span class=k>$(</span>two<span class=k>)</span>
</span></span><span class=line><span class=cl>    @echo <span class=nv>$$</span>two
</span></span></code></pre></td></tr></table></div></div><p>也可以使用 <code>.EXPORT_ALL_VARIABLES</code> 将所用的变量都声明为全局的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>.EXPORT_ALL_VARIABLES</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=nv>new_contents</span> <span class=o>=</span> <span class=s2>&#34;hello:\n\techo \$</span><span class=k>$(</span>cooly<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>cooly</span> <span class=o>=</span> <span class=s2>&#34;The subdirectory can see me!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    mkdir -p subdir
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>new_contents<span class=k>)</span> <span class=p>|</span> sed -e <span class=s1>&#39;s/^ //&#39;</span> &gt; subdir/makefile
</span></span><span class=line><span class=cl>    @echo <span class=s2>&#34;---MAKEFILE CONTENTS---&#34;</span>
</span></span><span class=line><span class=cl>    @cd subdir <span class=o>&amp;&amp;</span> cat makefile
</span></span><span class=line><span class=cl>    @echo <span class=s2>&#34;---END MAKEFILE CONTENTS---&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>cd</span> subdir <span class=o>&amp;&amp;</span> <span class=k>$(</span>MAKE<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -rf subdir
</span></span></code></pre></td></tr></table></div></div><h3 id=覆盖命令行参数>覆盖命令行参数</h3><p>你可以使用 <code>override</code> 覆盖来自命令行的变量。在这里，我们使用 <code>make option_one=hi</code> 运行 <code>make</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># 覆盖命令行参数
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>override</span> <span class=nv>option_one</span> <span class=o>=</span> did_override
</span></span><span class=line><span class=cl><span class=c># 不会覆盖
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>option_two</span> <span class=o>=</span> not_override
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>option_one<span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>option_two<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=define函数定义>define函数定义</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>one</span> <span class=o>=</span> <span class=nb>export</span> <span class=nv>blah</span><span class=o>=</span><span class=s2>&#34;I was set!&#34;</span><span class=p>;</span> <span class=nb>echo</span> <span class=nv>$$</span>blah
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>define</span> <span class=err>two</span>
</span></span><span class=line><span class=cl><span class=k>export </span><span class=nv>blah</span><span class=o>=</span><span class=nb>set</span>
</span></span><span class=line><span class=cl><span class=err>echo</span> <span class=k>$$</span><span class=err>blah</span>
</span></span><span class=line><span class=cl><span class=err>endef</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># One 和 two 是不一样的
</span></span></span><span class=line><span class=cl><span class=c></span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    @echo <span class=s2>&#34;这条会打印 &#39;I was set&#39;&#34;</span>
</span></span><span class=line><span class=cl>    @<span class=k>$(</span>one<span class=k>)</span>
</span></span><span class=line><span class=cl>    @echo <span class=s2>&#34;这条不会打印 &#39;I was set&#39; 因为每条命令运行在不同的shell中&#34;</span>
</span></span><span class=line><span class=cl>    @<span class=k>$(</span>two<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=指定目标变量>指定目标变量</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># 给目标 all 指定 one 变量
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>all</span><span class=o>:</span> <span class=n>one</span> = <span class=n>cool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> one is defined: <span class=k>$(</span>one<span class=k>)</span> <span class=c1># 打印 cool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>other</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> one is nothing: <span class=k>$(</span>one<span class=k>)</span> <span class=c1># 不会打印 cool</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=指定模式变量>指定模式变量</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># 给匹配 %.c 这个模式的规则指定 one 变量
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>%.c</span><span class=o>:</span> <span class=n>one</span> = <span class=n>cool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>blah.c</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> one is defined: <span class=k>$(</span>one<span class=k>)</span> <span class=c1># 打印 cool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>other</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> one is nothing: <span class=k>$(</span>one<span class=k>)</span> <span class=c1># 不会打印 cool</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=条件判断>条件判断</h2><h3 id=ifelse>if/else</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>foo</span> <span class=o>=</span> ok
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=err>ifeq</span> <span class=err>(</span><span class=k>$(</span><span class=nv>foo</span><span class=k>)</span><span class=err>,</span> <span class=err>ok)</span>
</span></span><span class=line><span class=cl>    <span class=err>echo</span> <span class=s2>&#34;foo equals ok&#34;</span>
</span></span><span class=line><span class=cl><span class=err>else</span>
</span></span><span class=line><span class=cl>    <span class=err>echo</span> <span class=s2>&#34;nope&#34;</span>
</span></span><span class=line><span class=cl><span class=err>endif</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=判断变量为空>判断变量为空</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>nullstring</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>foo</span> <span class=o>=</span> <span class=k>$(</span>nullstring<span class=k>)</span> <span class=c1># 末尾有一个空格</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=err>ifeq</span> <span class=err>(</span><span class=k>$(</span><span class=nv>strip</span> <span class=k>$(</span><span class=nv>foo</span><span class=k>))</span><span class=err>,)</span>
</span></span><span class=line><span class=cl>    <span class=err>echo</span> <span class=s2>&#34;foo is empty after being stripped&#34;</span>
</span></span><span class=line><span class=cl><span class=err>endif</span>
</span></span><span class=line><span class=cl><span class=err>ifeq</span> <span class=err>(</span><span class=k>$(</span><span class=nv>nullstring</span><span class=k>)</span><span class=err>,)</span>
</span></span><span class=line><span class=cl>    <span class=err>echo</span> <span class=s2>&#34;nullstring doesn&#39;t even have spaces&#34;</span>
</span></span><span class=line><span class=cl><span class=err>endif</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=检查变量是否定义>检查变量是否定义</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>bar</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>foo</span> <span class=o>=</span> <span class=k>$(</span>bar<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=err>ifdef</span> <span class=err>foo</span>
</span></span><span class=line><span class=cl>    <span class=err>echo</span> <span class=s2>&#34;foo is defined&#34;</span>
</span></span><span class=line><span class=cl><span class=err>endif</span>
</span></span><span class=line><span class=cl><span class=err>ifdef</span> <span class=err>bar</span>
</span></span><span class=line><span class=cl>    <span class=err>echo</span> <span class=s2>&#34;but bar is not&#34;</span>
</span></span><span class=line><span class=cl><span class=err>endif</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=命令行参数-makeflags>命令行参数 $(MAKEFLAGS)</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>bar</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=nv>foo</span> <span class=o>=</span> <span class=k>$(</span>bar<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=c># 查找 &#34;-i&#34; 参数。
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>ifneq</span> <span class=err>(,</span><span class=k>$(</span><span class=nv>findstring</span> <span class=nv>i</span>, <span class=k>$(</span><span class=nv>MAKEFLAGS</span><span class=k>))</span><span class=err>)</span>
</span></span><span class=line><span class=cl>    <span class=err>echo</span> <span class=s2>&#34;i was passed to MAKEFLAGS&#34;</span>
</span></span><span class=line><span class=cl><span class=err>endif</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=函数>函数</h2><p>函数主要只是用于文本处理。使用 <code>$(fn, arguments)</code> 或 <code>${fn, arguments}</code> 调用函数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># 字符串替换，这里 totally 替换 not
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>bar</span> <span class=o>:=</span> <span class=si>${</span><span class=nv>subst</span><span class=p> not, totally, </span><span class=s2>&#34;I am not superman&#34;</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    @echo <span class=k>$(</span>bar<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要替换空格或逗号，请使用变量</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>comma</span> <span class=o>:=</span> ,
</span></span><span class=line><span class=cl><span class=nv>empty</span><span class=o>:=</span>
</span></span><span class=line><span class=cl><span class=nv>space</span> <span class=o>:=</span> <span class=k>$(</span>empty<span class=k>)</span> <span class=k>$(</span>empty<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>foo</span> <span class=o>:=</span> a b c
</span></span><span class=line><span class=cl><span class=nv>bar</span> <span class=o>:=</span> <span class=k>$(</span>subst <span class=k>$(</span>space<span class=k>)</span>,<span class=k>$(</span>comma<span class=k>)</span>,<span class=k>$(</span>foo<span class=k>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    <span class=c1># 输出是 &#34;a,b,c&#34;</span>
</span></span><span class=line><span class=cl>    @echo <span class=k>$(</span>bar<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><p>不要在第一个参数之后包含空格。这将被视为字符串的一部分。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>comma</span> <span class=o>:=</span> ,
</span></span><span class=line><span class=cl><span class=nv>empty</span><span class=o>:=</span>
</span></span><span class=line><span class=cl><span class=nv>space</span> <span class=o>:=</span> <span class=k>$(</span>empty<span class=k>)</span> <span class=k>$(</span>empty<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>foo</span> <span class=o>:=</span> a b c
</span></span><span class=line><span class=cl><span class=nv>bar</span> <span class=o>:=</span> <span class=k>$(</span>subst <span class=k>$(</span>space<span class=k>)</span>, <span class=k>$(</span>comma<span class=k>)</span> , <span class=k>$(</span>foo<span class=k>))</span> <span class=c1># $(comma) 后面有一个空格</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> 
</span></span><span class=line><span class=cl>    <span class=c1># 输出是 &#34;, a , b , c&#34;，注意空格</span>
</span></span><span class=line><span class=cl>    @echo <span class=k>$(</span>bar<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=字符串替换>字符串替换</h3><p><code>$(patsubst pattern,replacement,text)</code> 执行以下操作：</p><p>使用 <code>pattern</code> 匹配 <code>text</code> 中的文件名，使用 <code>replacement</code> 进行替换。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>foo</span> <span class=o>:=</span> a.o b.o l.a c.o
</span></span><span class=line><span class=cl><span class=nv>one</span> <span class=o>:=</span> <span class=k>$(</span>patsubst %.o,%.c,<span class=k>$(</span>foo<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=c># 这是上面的简写
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>two</span> <span class=o>:=</span> <span class=k>$(</span>foo:%.o<span class=o>=</span>%.c<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=c># 这是仅有后缀的简写，也等价于上述
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>three</span> <span class=o>:=</span> <span class=k>$(</span>foo:.o<span class=o>=</span>.c<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 输出 a.c b.c l.a c.c
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>one<span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>two<span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>three<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=foreach-函数>foreach 函数</h3><p><code>$(foreach var,list,text)</code> ，它将一个单词列表（由空格分隔）转换为另一个单词列表。var 设置为列表中的每个单词，并为每个单词扩展文本。</p><p>这会在每个单词后附加一个感叹号：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>foo</span> <span class=o>:=</span> who are you
</span></span><span class=line><span class=cl><span class=c># 对于 foo 中的每个“单词”，输出相同的单词并在后面加上感叹号
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>bar</span> <span class=o>:=</span> <span class=k>$(</span>foreach wrd,<span class=k>$(</span>foo<span class=k>)</span>,<span class=k>$(</span>wrd<span class=k>)</span>!<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 输出是 &#34;who! are! you!&#34;</span>
</span></span><span class=line><span class=cl>    @echo <span class=k>$(</span>bar<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=if-函数>if 函数</h3><p><code>if</code> 检查第一个参数是否为非空。如果是，则运行第二个参数，否则运行第三个。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>this-is-not-empty</span> <span class=o>:=</span> hey
</span></span><span class=line><span class=cl><span class=nv>foo</span> <span class=o>:=</span> <span class=k>$(if</span> this-is-not-empty,yes,no<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>empty</span> <span class=o>:=</span>
</span></span><span class=line><span class=cl><span class=nv>bar</span> <span class=o>:=</span> <span class=k>$(if</span> <span class=k>$(</span>empty<span class=k>)</span>,yes,no<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 输出：yes
</span></span></span><span class=line><span class=cl><span class=c>#       no
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    @echo <span class=k>$(</span>foo<span class=k>)</span>
</span></span><span class=line><span class=cl>    @echo <span class=k>$(</span>bar<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=call-函数>call 函数</h3><p>Make 支持创建基本函数。语法是 <code>$(call variable,param,param)</code></p><p><code>$(0)</code> 是变量名，<code>$(1)</code> 、<code>$(2)</code> 等是参数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>sweet_new_fn</span> <span class=o>=</span> Variable Name: <span class=k>$(</span>0<span class=k>)</span> First: <span class=k>$(</span>1<span class=k>)</span> Second: <span class=k>$(</span>2<span class=k>)</span> Empty Variable: <span class=k>$(</span>3<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 输出 &#34;Variable Name: sweet_new_fn First: go Second: tigers Empty Variable:&#34;</span>
</span></span><span class=line><span class=cl>    @echo <span class=k>$(</span>call sweet_new_fn, go, tigers<span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=shell-函数>shell 函数</h3><p>这会调用 shell，但它用空格替换了换行符。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 非常难看，因为换行符不见了</span>
</span></span><span class=line><span class=cl>    @echo <span class=k>$(</span>shell ls -la<span class=k>)</span> 
</span></span></code></pre></td></tr></table></div></div><h2 id=其他特性>其他特性</h2><h3 id=应用外部makefile>应用外部makefile</h3><p><code>include</code> 的语法是</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=err>include</span> <span class=err>filenames</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=vpath-指令>vpath 指令</h3><p>语法 <code>vpath &lt;pattern> &lt;directories></code> ，<code>&lt;pattern></code> 会匹配 <code>&lt;directories></code> 中的文件名，多个目录使用 <code>空格</code> 或 <code>冒号</code> 分隔。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>vpath %.h ../headers ../other-directory
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>some_binary: ../headers blah.h
</span></span><span class=line><span class=cl>    touch some_binary
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>../headers:
</span></span><span class=line><span class=cl>    mkdir ../headers
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>blah.h:
</span></span><span class=line><span class=cl>    touch ../headers/blah.h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>clean:
</span></span><span class=line><span class=cl>    rm -rf ../headers
</span></span><span class=line><span class=cl>    rm -f some_binary
</span></span></code></pre></td></tr></table></div></div><h3 id=phony>.phony</h3><p>make 并不生成“clean”这个文件。“伪目标”并不是一个文件，只是一个 <code>标签</code> ，由于“伪目标”不是文件，所以 make 无法生成它的依赖关系和决定它是否要执行。我们只有通过显式地指明这个“目标”才能让其生效（通过 <code>make clean</code> 命令）。当然，“伪目标”的取名不能和文件名重名，不然其就失去了“伪目标”的意义了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=err>.PHONY</span> <span class=err>clean</span>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -f *.o
</span></span></code></pre></td></tr></table></div></div><h3 id=delete_on_error>.delete_on_error</h3><p>当规则执行失败，<code>.delete_on_error</code> 会删除规则已生成的所有目标文件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nf>.DELETE_ON_ERROR</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=n>one</span> <span class=n>two</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>one</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch one
</span></span><span class=line><span class=cl>    <span class=nb>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>two</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    touch two
</span></span><span class=line><span class=cl>    <span class=nb>false</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=makefile-模板>makefile 模板</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># 感谢 Job Vranish (https://spin.atomicobject.com/2016/08/26/makefile-c-projects/)
</span></span></span><span class=line><span class=cl><span class=c># 最终要生成的目标文件名
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>TARGET_EXEC</span> <span class=o>:=</span> final_program
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 编译生成文件的目录
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>BUILD_DIR</span> <span class=o>:=</span> ./build
</span></span><span class=line><span class=cl><span class=c># 源文件所在的目录
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>SRC_DIRS</span> <span class=o>:=</span> ./src
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 找到所有需要编译的 C 和 C++ 文件
</span></span></span><span class=line><span class=cl><span class=c># 注意 * 表达式周围的单引号。否则 Make 会错误地扩展这些。
</span></span></span><span class=line><span class=cl><span class=c># Note the single quotes around the * expressions. Make will incorrectly expand these otherwise.
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>SRCS</span> <span class=o>:=</span> <span class=k>$(</span>shell find <span class=k>$(</span>SRC_DIRS<span class=k>)</span> -name <span class=s1>&#39;*.cpp&#39;</span> -or -name <span class=s1>&#39;*.c&#39;</span> -or -name <span class=s1>&#39;*.s&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 给每个 C/C++ 文件名加 .o 结尾
</span></span></span><span class=line><span class=cl><span class=c># 如 hello.cpp 转换为 ./build/hello.cpp.o
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>OBJS</span> <span class=o>:=</span> <span class=k>$(</span>SRCS:%<span class=o>=</span><span class=k>$(</span>BUILD_DIR<span class=k>)</span>/%.o<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># .o 结尾替换为 .d
</span></span></span><span class=line><span class=cl><span class=c># 如 ./build/hello.cpp.o 转换为 ./build/hello.cpp.d
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>DEPS</span> <span class=o>:=</span> <span class=k>$(</span>OBJS:.o<span class=o>=</span>.d<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># ./src 中的每个文件夹都需要传递给 GCC，以便它可以找到头文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>INC_DIRS</span> <span class=o>:=</span> <span class=k>$(</span>shell find <span class=k>$(</span>SRC_DIRS<span class=k>)</span> -type d<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=c># 给 INC_DIRS 添加前缀 -I ，GCC指定头文件路径需要 -I，如 moduleA 会变成 -ImoduleA
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>INC_FLAGS</span> <span class=o>:=</span> <span class=k>$(</span>addprefix -I,<span class=k>$(</span>INC_DIRS<span class=k>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># -MMD 和 -MP 参数会生成每个 .c 文件所依赖的头文件关系
</span></span></span><span class=line><span class=cl><span class=c># 保存到 .d 结尾的文件中
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>CPPFLAGS</span> <span class=o>:=</span> <span class=k>$(</span>INC_FLAGS<span class=k>)</span> -MMD -MP
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 最终的编译步骤
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>$(BUILD_DIR)/$(TARGET_EXEC)</span><span class=o>:</span> <span class=k>$(</span><span class=nv>OBJS</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=k>$(</span>CC<span class=k>)</span> <span class=k>$(</span>OBJS<span class=k>)</span> -o <span class=nv>$@</span> <span class=k>$(</span>LDFLAGS<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 编译C源码
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>$(BUILD_DIR)/%.c.o</span><span class=o>:</span> %.<span class=n>c</span>
</span></span><span class=line><span class=cl>    mkdir -p <span class=k>$(</span>dir <span class=nv>$@</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=k>$(</span>CC<span class=k>)</span> <span class=k>$(</span>CPPFLAGS<span class=k>)</span> <span class=k>$(</span>CFLAGS<span class=k>)</span> -c $&lt; -o <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 编译C++源码
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>$(BUILD_DIR)/%.cpp.o</span><span class=o>:</span> %.<span class=n>cpp</span>
</span></span><span class=line><span class=cl>    mkdir -p <span class=k>$(</span>dir <span class=nv>$@</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=k>$(</span>CXX<span class=k>)</span> <span class=k>$(</span>CPPFLAGS<span class=k>)</span> <span class=k>$(</span>CXXFLAGS<span class=k>)</span> -c $&lt; -o <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>clean</span>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    rm -r <span class=k>$(</span>BUILD_DIR<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Include the .d makefiles. The - at the front suppresses the errors of missing
</span></span></span><span class=line><span class=cl><span class=c># Makefiles. Initially, all the .d files will be missing, and we don&#39;t want those
</span></span></span><span class=line><span class=cl><span class=c># errors to show up.
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>-include</span> <span class=k>$(</span><span class=nv>DEPS</span><span class=k>)</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/makefile/>makefile</a></section></footer><link rel=stylesheet href=/js/katex.min.css crossorigin=anonymous><script src=/js/katex.min.js crossorigin=anonymous defer></script><script src=/js/auto-render.min.js crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script></article><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 kingtuo123</section><section class=powerby>www.kingtuo123.com<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=/js/photoswipe.min.js crossorigin=anonymous defer></script><script src=/js/photoswipe-ui-default.min.js crossorigin=anonymous defer></script><link rel=stylesheet href=/js/default-skin.css crossorigin=anonymous><link rel=stylesheet href=/js/photoswipe.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#makefile-语法>Makefile 语法</a></li><li><a href=#示例>示例</a></li><li><a href=#变量>变量</a></li><li><a href=#目标>目标</a></li><li><a href=#通配符>通配符</a></li><li><a href=#自动化变量>自动化变量</a></li><li><a href=#规则>规则</a><ol><li><a href=#隐式规则>隐式规则</a></li><li><a href=#静态模式规则>静态模式规则</a></li><li><a href=#模式规则>模式规则</a></li><li><a href=#双冒号规则>双冒号规则</a></li></ol></li><li><a href=#命令>命令</a><ol><li><a href=#不打印命令>不打印命令</a></li><li><a href=#命令执行>命令执行</a></li><li><a href=#默认-shell>默认 shell</a></li><li><a href=#错误处理>错误处理</a></li><li><a href=#中断-make>中断 make</a></li><li><a href=#嵌套执行-make>嵌套执行 make</a></li><li><a href=#使用-export-嵌套>使用 export 嵌套</a></li><li><a href=#覆盖命令行参数>覆盖命令行参数</a></li><li><a href=#define函数定义>define函数定义</a></li><li><a href=#指定目标变量>指定目标变量</a></li><li><a href=#指定模式变量>指定模式变量</a></li></ol></li><li><a href=#条件判断>条件判断</a><ol><li><a href=#ifelse>if/else</a></li><li><a href=#判断变量为空>判断变量为空</a></li><li><a href=#检查变量是否定义>检查变量是否定义</a></li><li><a href=#命令行参数-makeflags>命令行参数 $(MAKEFLAGS)</a></li></ol></li><li><a href=#函数>函数</a><ol><li><a href=#字符串替换>字符串替换</a></li><li><a href=#foreach-函数>foreach 函数</a></li><li><a href=#if-函数>if 函数</a></li><li><a href=#call-函数>call 函数</a></li><li><a href=#shell-函数>shell 函数</a></li></ol></li><li><a href=#其他特性>其他特性</a><ol><li><a href=#应用外部makefile>应用外部makefile</a></li><li><a href=#vpath-指令>vpath 指令</a></li><li><a href=#phony>.phony</a></li><li><a href=#delete_on_error>.delete_on_error</a></li></ol></li><li><a href=#makefile-模板>makefile 模板</a></li></ol></nav></div></section></aside></div><script src=/js/vibrant.min.js crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script></body></html>