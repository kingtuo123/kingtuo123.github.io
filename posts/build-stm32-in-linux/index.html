<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Linux 下编译 STM32 | king's blog</title><meta name=keywords content="stm32,linux,makefile"><meta name=description content="linux 使用 make 管理 stm32 工程"><meta name=author content="kingtuo123"><link rel=canonical href=https://kingtuo123.com/posts/build-stm32-in-linux/><link crossorigin=anonymous href=/assets/css/stylesheet.1b5446f740bb6871915d4adc115699d5a22c24bc7fa8660e3bfbb6e025fb2c4d.css integrity="sha256-G1RG90C7aHGRXUrcEVaZ1aIsJLx/qGYOO/u24CX7LE0=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://kingtuo123.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kingtuo123.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kingtuo123.com/favicon-32x32.png><link rel=apple-touch-icon href=https://kingtuo123.com/apple-touch-icon.png><link rel=mask-icon href=https://kingtuo123.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Linux 下编译 STM32"><meta property="og:description" content="linux 使用 make 管理 stm32 工程"><meta property="og:type" content="article"><meta property="og:url" content="https://kingtuo123.com/posts/build-stm32-in-linux/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-13T00:00:00+00:00"><meta property="article:modified_time" content="2022-07-13T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux 下编译 STM32"><meta name=twitter:description content="linux 使用 make 管理 stm32 工程"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kingtuo123.com/posts/"},{"@type":"ListItem","position":2,"name":"Linux 下编译 STM32","item":"https://kingtuo123.com/posts/build-stm32-in-linux/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux 下编译 STM32","name":"Linux 下编译 STM32","description":"linux 使用 make 管理 stm32 工程","keywords":["stm32","linux","makefile"],"articleBody":" 参考示例： stm32f103x-template ( stm32f103zet6 ) 目录结构 $ tree -L 3 . ├── Libraries │ ├── CMSIS │ │ ├── CM3 │ │ ├── CMSIS changes.htm │ │ ├── CMSIS debug support.htm │ │ ├── Documentation │ │ └── License.doc │ └── STM32F10x_StdPeriph_Driver │ ├── inc │ ├── LICENSE.txt │ ├── Release_Notes.html │ └── src ├── Linker │ └── STM32F103R8Tx_FLASH.ld ├── makefile └── Userc ├── led │ ├── bsp_led.c │ └── bsp_led.h ├── main.c ├── stm32f10x_conf.h ├── stm32f10x_it.c └── stm32f10x_it.h 其中 Libraries 是从官方下载固件包中直接拷贝过来，内部目录未作调整。\nMakefile TARGET := LED-BLINK BUILD_DIR := ./Build TOOLCHAIN = arm-none-eabi- CC := $(TOOLCHAIN)gcc CP := $(TOOLCHAIN)objcopy AS := $(TOOLCHAIN)gcc -x assembler-with-cpp SZ := $(TOOLCHAIN)size HEX := $(CP) -O ihex BIN := $(CP) -O binary -S DEFS := -D STM32F10X_HD -D USE_STDPERIPH_DRIVER LINK_SCRIPT := ./Linker/STM32F103ZETx_FLASH.ld STARTUP_DIR := ./Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/startup/gcc_ride7/ STARTUP_ASM := $(STARTUP_DIR)/startup_stm32f10x_hd.s SRC_DIR := ./Libraries/CMSIS/ SRC_DIR += ./Libraries/CMSIS/CM3/CoreSupport/ SRC_DIR += ./Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/ SRC_DIR += ./Libraries/STM32F10x_StdPeriph_Driver/inc/ SRC_DIR += ./Libraries/STM32F10x_StdPeriph_Driver/src/ SRC_DIR += ./User/ SRC_DIR += ./User/led/ INC_DIR := $(addprefix -I,$(SRC_DIR)) C_SRC := $(wildcard $(addsuffix *.c,$(SRC_DIR))) C_OBJ := $(addprefix $(BUILD_DIR)/,$(notdir $(C_SRC:.c=.o))) ASM_SRC := $(wildcard $(addsuffix *.s,$(SRC_DIR))) ASM_SRC += $(STARTUP_ASM) ASM_OBJ := $(addprefix $(BUILD_DIR)/,$(notdir $(ASM_SRC:.s=.o))) AS_FLAGS := $(INC_DIR) -mcpu=cortex-m3 -g -gdwarf-2 -mthumb -Os -Wall -fdata-sections -ffunction-sections -MMD -MP CP_FLAGS := $(AS_FLAGS) $(DEFS) LD_FLAGS := -mcpu=cortex-m3 -specs=nano.specs -T $(LINK_SCRIPT) -Wl,-Map=$(BUILD_DIR)/$(TARGET).map,--cref,--gc-sections vpath %.c $(SRC_DIR) vpath %.s $(SRC_DIR) $(STARTUP_DIR) .PRECIOUS: $(BUILD_DIR)/%.o .PHONY: all all: $(BUILD_DIR) $(BUILD_DIR)/$(TARGET).elf $(BUILD_DIR)/$(TARGET).bin $(BUILD_DIR)/$(TARGET).hex $(SZ) $(BUILD_DIR)/$(TARGET).elf @du -sh $(BUILD_DIR)/$(TARGET).elf @du -sh $(BUILD_DIR)/$(TARGET).hex @du -sh $(BUILD_DIR)/$(TARGET).bin @echo \"!!! DONE !!!\" $(BUILD_DIR)/%.o: %.c $(CC) -c $(CP_FLAGS) $\u003c -o $@ $(BUILD_DIR)/%.o: %.s $(AS) -c $(AS_FLAGS) $\u003c -o $@ $(BUILD_DIR)/%.elf: $(C_OBJ) $(ASM_OBJ) $(CC) $(LD_FLAGS) $^ -o $@ %.hex: %.elf $(HEX) $\u003c $@ %.bin: %.elf $(BIN) $\u003c $@ $(BUILD_DIR): mkdir -p $@ clean: rm $(BUILD_DIR) -rf rebuild: make clean \u0026\u0026 make st-flash: st-flash write $(BUILD_DIR)/$(TARGET).bin 0x8000000 isp-flash: stm32flash -b 115200 -i '-dtr\u0026rts,dtr:-dtr\u0026-rts,dtr' -v -w $(BUILD_DIR)/$(TARGET).bin /dev/ttyUSB0 isp-info: stm32flash -b 115200 -i '-dtr\u0026rts,dtr:-dtr\u0026-rts,dtr' /dev/ttyUSB0 st-erase: st-flash erase isp-erase: stm32flash -b 115200 -i '-dtr\u0026rts,dtr:-dtr\u0026-rts,dtr' -o /dev/ttyUSB0 编译/链接 参数 说明 -D STM32F10X_HD 表示芯片容量（必需） -D USE_STDPERIPH_DRIVER 表示使用官方标准固件库（必需） -mcpu=cortex-m3 指定芯片内核架构（必需） -g 产生调试信息 -gdwarf-2 -mthumb 表示使用 thumb 指令集（必需） -Os 优化代码大小 -Wall 允许输出所有警告 -MMD 生成依赖关系文件（.d），依赖不包括系统头文件 -MP 依赖规则中的所有.h依赖项都会在该文件中生成一个伪目标，其不依赖任何其他依赖项 -fdata-sections 为每个 data item 分配独立的 section，方便后面链接器优化 -ffunction-sections 为每个 function 分配独立的 section，方便后面链接器优化 -specs=nano.specs 使用精简版的C库替代标准C库，可以减少最终程序映像的大小 -T 指定链接脚本 -Wl 表示后面跟的参数传递给链接器，用逗号分隔 -Map= 生成 map 映射文件 --cref Cross Reference的简写，输出交叉引用表 --gc-sections 不链接未用函数，减小可执行文件大小 参考文章：\ngcc -ffunction-sections -fdata-sections -Wl,–gc-sections 参数详解 LinkScript /* Entry Point */ ENTRY(Reset_Handler) /* Highest address of the user mode stack */ _estack = ORIGIN(RAM) + LENGTH(RAM); /* end of RAM */ /* Generate a link error if heap and stack don't fit into RAM */ _Min_Heap_Size = 0x200; /* required amount of heap */ _Min_Stack_Size = 0x400; /* required amount of stack */ /* Specify the memory areas */ MEMORY { RAM (xrw) : ORIGIN = 0x20000000, LENGTH = 64K FLASH (rx) : ORIGIN = 0x8000000, LENGTH = 512K } /* Define output sections */ SECTIONS { /* The startup code goes first into FLASH */ .isr_vector : { . = ALIGN(4); KEEP(*(.isr_vector)) /* Startup code */ . = ALIGN(4); } \u003eFLASH /* The program code and other data goes into FLASH */ .text : { . = ALIGN(4); *(.text) /* .text sections (code) */ *(.text*) /* .text* sections (code) */ *(.glue_7) /* glue arm to thumb code */ *(.glue_7t) /* glue thumb to arm code */ *(.eh_frame) KEEP (*(.init)) KEEP (*(.fini)) . = ALIGN(4); _etext = .; /* define a global symbols at end of code */ } \u003eFLASH /* Constant data goes into FLASH */ .rodata : { . = ALIGN(4); *(.rodata) /* .rodata sections (constants, strings, etc.) */ *(.rodata*) /* .rodata* sections (constants, strings, etc.) */ . = ALIGN(4); } \u003eFLASH .ARM.extab : { *(.ARM.extab* .gnu.linkonce.armextab.*) } \u003eFLASH .ARM : { __exidx_start = .; *(.ARM.exidx*) __exidx_end = .; } \u003eFLASH .preinit_array : { PROVIDE_HIDDEN (__preinit_array_start = .); KEEP (*(.preinit_array*)) PROVIDE_HIDDEN (__preinit_array_end = .); } \u003eFLASH .init_array : { PROVIDE_HIDDEN (__init_array_start = .); KEEP (*(SORT(.init_array.*))) KEEP (*(.init_array*)) PROVIDE_HIDDEN (__init_array_end = .); } \u003eFLASH .fini_array : { PROVIDE_HIDDEN (__fini_array_start = .); KEEP (*(SORT(.fini_array.*))) KEEP (*(.fini_array*)) PROVIDE_HIDDEN (__fini_array_end = .); } \u003eFLASH /* used by the startup to initialize data */ _sidata = LOADADDR(.data); /* Initialized data sections goes into RAM, load LMA copy after code */ .data : { . = ALIGN(4); _sdata = .; /* create a global symbol at data start */ *(.data) /* .data sections */ *(.data*) /* .data* sections */ . = ALIGN(4); _edata = .; /* define a global symbol at data end */ } \u003eRAM AT\u003e FLASH /* Uninitialized data section */ . = ALIGN(4); .bss : { /* This is used by the startup in order to initialize the .bss secion */ _sbss = .; /* define a global symbol at bss start */ __bss_start__ = _sbss; *(.bss) *(.bss*) *(COMMON) . = ALIGN(4); _ebss = .; /* define a global symbol at bss end */ __bss_end__ = _ebss; } \u003eRAM /* User_heap_stack section, used to check that there is enough RAM left */ ._user_heap_stack : { . = ALIGN(8); PROVIDE ( end = . ); PROVIDE ( _end = . ); . = . + _Min_Heap_Size; . = . + _Min_Stack_Size; . = ALIGN(8); } \u003eRAM /* Remove information from the standard libraries */ /DISCARD/ : { libc.a ( * ) libm.a ( * ) libgcc.a ( * ) } .ARM.attributes 0 : { *(.ARM.attributes) } } 编译出错 /tmp/cceEC3n9.s:599: Error: registers may not be the same -- `strexb r0,r0,[r1]' /tmp/cceEC3n9.s:629: Error: registers may not be the same -- `strexh r0,r0,[r1]' 修改固件库中 Libraries/CMSIS/CM4/CoreSupport/core_cm3.c 文件\n将 __STREXB 和 __STREXH 函数中的 =r 改为 =\u0026r ，一共有两处：\n__ASM volatile (\"strexb %0, %2, [%1]\" : \"=\u0026r\" (result) : \"r\" (addr), \"r\" (value) ); 貌似是 gcc 编译优化导致的问题，参考下列文章：\nError: registers may not be the same – strexb r0,r0,[r1] Fix registers may not be the same ARM GCC error gcc编译后出现与CMSIS相关的错误 ","wordCount":"946","inLanguage":"en","datePublished":"2022-07-13T00:00:00Z","dateModified":"2022-07-13T00:00:00Z","author":{"@type":"Person","name":"kingtuo123"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kingtuo123.com/posts/build-stm32-in-linux/"},"publisher":{"@type":"Organization","name":"king's blog","logo":{"@type":"ImageObject","url":"https://kingtuo123.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kingtuo123.com/ accesskey=h title="king's blog (Alt + H)">king's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kingtuo123.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://kingtuo123.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://kingtuo123.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://kingtuo123.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Linux 下编译 STM32</h1><div class=post-meta><span title='2022-07-13 00:00:00 +0000 UTC'>July 13, 2022</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84 aria-label=目录结构>目录结构</a></li><li><a href=#makefile aria-label=Makefile>Makefile</a></li><li><a href=#linkscript aria-label=LinkScript>LinkScript</a></li><li><a href=#%e7%bc%96%e8%af%91%e5%87%ba%e9%94%99 aria-label=编译出错>编译出错</a></li></ul></div></details></div><div class=post-content><ul><li>参考示例：<ul><li><a href=https://github.com/kingtuo123/stm32f103x-template>stm32f103x-template ( stm32f103zet6 )</a></li></ul></li></ul><h2 id=目录结构>目录结构<a hidden class=anchor aria-hidden=true href=#目录结构>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ tree -L 3
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Libraries
</span></span><span class=line><span class=cl>│   ├── CMSIS
</span></span><span class=line><span class=cl>│   │   ├── CM3
</span></span><span class=line><span class=cl>│   │   ├── CMSIS changes.htm
</span></span><span class=line><span class=cl>│   │   ├── CMSIS debug support.htm
</span></span><span class=line><span class=cl>│   │   ├── Documentation
</span></span><span class=line><span class=cl>│   │   └── License.doc
</span></span><span class=line><span class=cl>│   └── STM32F10x_StdPeriph_Driver
</span></span><span class=line><span class=cl>│       ├── inc
</span></span><span class=line><span class=cl>│       ├── LICENSE.txt
</span></span><span class=line><span class=cl>│       ├── Release_Notes.html
</span></span><span class=line><span class=cl>│       └── src
</span></span><span class=line><span class=cl>├── Linker
</span></span><span class=line><span class=cl>│   └── STM32F103R8Tx_FLASH.ld
</span></span><span class=line><span class=cl>├── makefile
</span></span><span class=line><span class=cl>└── Userc
</span></span><span class=line><span class=cl>    ├── led
</span></span><span class=line><span class=cl>    │   ├── bsp_led.c
</span></span><span class=line><span class=cl>    │   └── bsp_led.h
</span></span><span class=line><span class=cl>    ├── main.c
</span></span><span class=line><span class=cl>    ├── stm32f10x_conf.h
</span></span><span class=line><span class=cl>    ├── stm32f10x_it.c
</span></span><span class=line><span class=cl>    └── stm32f10x_it.h
</span></span></code></pre></div><p>其中 <code>Libraries</code> 是从官方下载固件包中直接拷贝过来，内部目录未作调整。</p><h2 id=makefile>Makefile<a hidden class=anchor aria-hidden=true href=#makefile>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>TARGET</span>    <span class=o>:=</span> LED-BLINK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>BUILD_DIR</span> <span class=o>:=</span> ./Build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>TOOLCHAIN</span>  <span class=o>=</span> arm-none-eabi-
</span></span><span class=line><span class=cl><span class=nv>CC</span>  <span class=o>:=</span> <span class=k>$(</span>TOOLCHAIN<span class=k>)</span>gcc
</span></span><span class=line><span class=cl><span class=nv>CP</span>  <span class=o>:=</span> <span class=k>$(</span>TOOLCHAIN<span class=k>)</span>objcopy
</span></span><span class=line><span class=cl><span class=nv>AS</span>  <span class=o>:=</span> <span class=k>$(</span>TOOLCHAIN<span class=k>)</span>gcc -x assembler-with-cpp
</span></span><span class=line><span class=cl><span class=nv>SZ</span>  <span class=o>:=</span> <span class=k>$(</span>TOOLCHAIN<span class=k>)</span>size
</span></span><span class=line><span class=cl><span class=nv>HEX</span> <span class=o>:=</span> <span class=k>$(</span>CP<span class=k>)</span> -O ihex
</span></span><span class=line><span class=cl><span class=nv>BIN</span> <span class=o>:=</span> <span class=k>$(</span>CP<span class=k>)</span> -O binary -S
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>DEFS</span> <span class=o>:=</span> -D STM32F10X_HD  -D USE_STDPERIPH_DRIVER
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>LINK_SCRIPT</span> <span class=o>:=</span> ./Linker/STM32F103ZETx_FLASH.ld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>STARTUP_DIR</span> <span class=o>:=</span> ./Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/startup/gcc_ride7/
</span></span><span class=line><span class=cl><span class=nv>STARTUP_ASM</span> <span class=o>:=</span> <span class=k>$(</span>STARTUP_DIR<span class=k>)</span>/startup_stm32f10x_hd.s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SRC_DIR</span> <span class=o>:=</span> ./Libraries/CMSIS/
</span></span><span class=line><span class=cl><span class=nv>SRC_DIR</span> <span class=o>+=</span> ./Libraries/CMSIS/CM3/CoreSupport/
</span></span><span class=line><span class=cl><span class=nv>SRC_DIR</span> <span class=o>+=</span> ./Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/
</span></span><span class=line><span class=cl><span class=nv>SRC_DIR</span> <span class=o>+=</span> ./Libraries/STM32F10x_StdPeriph_Driver/inc/
</span></span><span class=line><span class=cl><span class=nv>SRC_DIR</span> <span class=o>+=</span> ./Libraries/STM32F10x_StdPeriph_Driver/src/
</span></span><span class=line><span class=cl><span class=nv>SRC_DIR</span> <span class=o>+=</span> ./User/
</span></span><span class=line><span class=cl><span class=nv>SRC_DIR</span> <span class=o>+=</span> ./User/led/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>INC_DIR</span> <span class=o>:=</span> <span class=k>$(</span>addprefix -I,<span class=k>$(</span>SRC_DIR<span class=k>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>C_SRC</span> <span class=o>:=</span> <span class=k>$(</span>wildcard <span class=k>$(</span>addsuffix *.c,<span class=k>$(</span>SRC_DIR<span class=k>)))</span>
</span></span><span class=line><span class=cl><span class=nv>C_OBJ</span> <span class=o>:=</span> <span class=k>$(</span>addprefix <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/,<span class=k>$(</span>notdir <span class=k>$(</span>C_SRC:.c<span class=o>=</span>.o<span class=k>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>ASM_SRC</span> <span class=o>:=</span> <span class=k>$(</span>wildcard <span class=k>$(</span>addsuffix *.s,<span class=k>$(</span>SRC_DIR<span class=k>)))</span>
</span></span><span class=line><span class=cl><span class=nv>ASM_SRC</span> <span class=o>+=</span> <span class=k>$(</span>STARTUP_ASM<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>ASM_OBJ</span> <span class=o>:=</span> <span class=k>$(</span>addprefix <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/,<span class=k>$(</span>notdir <span class=k>$(</span>ASM_SRC:.s<span class=o>=</span>.o<span class=k>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>AS_FLAGS</span> <span class=o>:=</span> <span class=k>$(</span>INC_DIR<span class=k>)</span> -mcpu<span class=o>=</span>cortex-m3 -g -gdwarf-2 -mthumb -Os -Wall -fdata-sections -ffunction-sections -MMD -MP
</span></span><span class=line><span class=cl><span class=nv>CP_FLAGS</span> <span class=o>:=</span> <span class=k>$(</span>AS_FLAGS<span class=k>)</span> <span class=k>$(</span>DEFS<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>LD_FLAGS</span> <span class=o>:=</span> -mcpu<span class=o>=</span>cortex-m3 -specs<span class=o>=</span>nano.specs -T <span class=k>$(</span>LINK_SCRIPT<span class=k>)</span> -Wl,-Map<span class=o>=</span><span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.map,--cref,--gc-sections
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>vpath</span> <span class=err>%.c</span> <span class=k>$(</span><span class=nv>SRC_DIR</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=err>vpath</span> <span class=err>%.s</span> <span class=k>$(</span><span class=nv>SRC_DIR</span><span class=k>)</span> <span class=k>$(</span><span class=nv>STARTUP_DIR</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PRECIOUS</span><span class=o>:</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span>/%.<span class=n>o</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>all</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span>/<span class=k>$(</span><span class=nv>TARGET</span><span class=k>)</span>.<span class=n>elf</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span>/<span class=k>$(</span><span class=nv>TARGET</span><span class=k>)</span>.<span class=n>bin</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span>/<span class=k>$(</span><span class=nv>TARGET</span><span class=k>)</span>.<span class=n>hex</span>
</span></span><span class=line><span class=cl>        <span class=k>$(</span>SZ<span class=k>)</span> <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.elf
</span></span><span class=line><span class=cl>        @du -sh <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.elf
</span></span><span class=line><span class=cl>        @du -sh <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.hex
</span></span><span class=line><span class=cl>        @du -sh <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.bin
</span></span><span class=line><span class=cl>        @echo <span class=s2>&#34;!!! DONE !!!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(BUILD_DIR)/%.o</span><span class=o>:</span> %.<span class=n>c</span>
</span></span><span class=line><span class=cl>        <span class=k>$(</span>CC<span class=k>)</span> -c <span class=k>$(</span>CP_FLAGS<span class=k>)</span> $&lt; -o <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(BUILD_DIR)/%.o</span><span class=o>:</span> %.<span class=n>s</span>
</span></span><span class=line><span class=cl>        <span class=k>$(</span>AS<span class=k>)</span> -c <span class=k>$(</span>AS_FLAGS<span class=k>)</span> $&lt; -o <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(BUILD_DIR)/%.elf</span><span class=o>:</span> <span class=k>$(</span><span class=nv>C_OBJ</span><span class=k>)</span> <span class=k>$(</span><span class=nv>ASM_OBJ</span><span class=k>)</span>
</span></span><span class=line><span class=cl>        <span class=k>$(</span>CC<span class=k>)</span> <span class=k>$(</span>LD_FLAGS<span class=k>)</span> $^ -o <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>%.hex</span><span class=o>:</span> %.<span class=n>elf</span>
</span></span><span class=line><span class=cl>        <span class=k>$(</span>HEX<span class=k>)</span> $&lt; <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>%.bin</span><span class=o>:</span> %.<span class=n>elf</span>
</span></span><span class=line><span class=cl>        <span class=k>$(</span>BIN<span class=k>)</span> $&lt; <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(BUILD_DIR)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        mkdir -p <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        rm <span class=k>$(</span>BUILD_DIR<span class=k>)</span> -rf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>rebuild</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        make clean <span class=o>&amp;&amp;</span> make
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>st-flash</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        st-flash write <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.bin 0x8000000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>isp-flash</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        stm32flash -b <span class=m>115200</span> -i <span class=s1>&#39;-dtr&amp;rts,dtr:-dtr&amp;-rts,dtr&#39;</span> -v -w <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.bin /dev/ttyUSB0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>isp-info</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        stm32flash -b <span class=m>115200</span> -i <span class=s1>&#39;-dtr&amp;rts,dtr:-dtr&amp;-rts,dtr&#39;</span> /dev/ttyUSB0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>st-erase</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        st-flash erase
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>isp-erase</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        stm32flash -b <span class=m>115200</span> -i <span class=s1>&#39;-dtr&amp;rts,dtr:-dtr&amp;-rts,dtr&#39;</span> -o /dev/ttyUSB0
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>编译/链接 参数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>-D STM32F10X_HD</code></td><td style=text-align:left>表示芯片容量（必需）</td></tr><tr><td style=text-align:left><code>-D USE_STDPERIPH_DRIVER</code></td><td style=text-align:left>表示使用官方标准固件库（必需）</td></tr><tr><td style=text-align:left><code>-mcpu=cortex-m3</code></td><td style=text-align:left>指定芯片内核架构（必需）</td></tr><tr><td style=text-align:left><code>-g</code></td><td style=text-align:left>产生调试信息</td></tr><tr><td style=text-align:left><code>-gdwarf-2</code></td><td></td></tr><tr><td style=text-align:left><code>-mthumb</code></td><td style=text-align:left>表示使用 thumb 指令集（必需）</td></tr><tr><td style=text-align:left><code>-Os</code></td><td style=text-align:left>优化代码大小</td></tr><tr><td style=text-align:left><code>-Wall</code></td><td style=text-align:left>允许输出所有警告</td></tr><tr><td style=text-align:left><code>-MMD</code></td><td style=text-align:left>生成依赖关系文件（.d），依赖不包括系统头文件</td></tr><tr><td style=text-align:left><code>-MP</code></td><td style=text-align:left>依赖规则中的所有.h依赖项都会在该文件中生成一个伪目标，其不依赖任何其他依赖项</td></tr><tr><td style=text-align:left><code>-fdata-sections</code></td><td style=text-align:left>为每个 data item 分配独立的 section，方便后面链接器优化</td></tr><tr><td style=text-align:left><code>-ffunction-sections</code></td><td style=text-align:left>为每个 function 分配独立的 section，方便后面链接器优化</td></tr><tr><td style=text-align:left><code>-specs=nano.specs</code></td><td style=text-align:left>使用精简版的C库替代标准C库，可以减少最终程序映像的大小</td></tr><tr><td style=text-align:left><code>-T</code></td><td style=text-align:left>指定链接脚本</td></tr><tr><td style=text-align:left><code>-Wl</code></td><td style=text-align:left>表示后面跟的参数传递给链接器，用逗号分隔</td></tr><tr><td style=text-align:left><code>-Map=&lt;filename></code></td><td style=text-align:left>生成 map 映射文件</td></tr><tr><td style=text-align:left><code>--cref</code></td><td style=text-align:left>Cross Reference的简写，输出交叉引用表</td></tr><tr><td style=text-align:left><code>--gc-sections</code></td><td style=text-align:left>不链接未用函数，减小可执行文件大小</td></tr></tbody></table><p>参考文章：</p><ul><li><a href=https://blog.csdn.net/pengfei240/article/details/55228228>gcc -ffunction-sections -fdata-sections -Wl,–gc-sections 参数详解</a></li></ul><h2 id=linkscript>LinkScript<a hidden class=anchor aria-hidden=true href=#linkscript>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Entry Point */</span>
</span></span><span class=line><span class=cl><span class=nf>ENTRY</span><span class=p>(</span><span class=n>Reset_Handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Highest address of the user mode stack */</span>
</span></span><span class=line><span class=cl><span class=n>_estack</span> <span class=o>=</span> <span class=nf>ORIGIN</span><span class=p>(</span><span class=n>RAM</span><span class=p>)</span> <span class=o>+</span> <span class=nf>LENGTH</span><span class=p>(</span><span class=n>RAM</span><span class=p>);</span>    <span class=cm>/* end of RAM */</span>
</span></span><span class=line><span class=cl><span class=cm>/* Generate a link error if heap and stack don&#39;t fit into RAM */</span>
</span></span><span class=line><span class=cl><span class=n>_Min_Heap_Size</span> <span class=o>=</span> <span class=mh>0x200</span><span class=p>;</span>      <span class=cm>/* required amount of heap  */</span>
</span></span><span class=line><span class=cl><span class=n>_Min_Stack_Size</span> <span class=o>=</span> <span class=mh>0x400</span><span class=p>;</span> <span class=cm>/* required amount of stack */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Specify the memory areas */</span>
</span></span><span class=line><span class=cl><span class=n>MEMORY</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nf>RAM</span> <span class=p>(</span><span class=n>xrw</span><span class=p>)</span>      <span class=o>:</span> <span class=n>ORIGIN</span> <span class=o>=</span> <span class=mh>0x20000000</span><span class=p>,</span> <span class=n>LENGTH</span> <span class=o>=</span> <span class=mi>64</span><span class=n>K</span>
</span></span><span class=line><span class=cl><span class=nf>FLASH</span> <span class=p>(</span><span class=n>rx</span><span class=p>)</span>      <span class=o>:</span> <span class=n>ORIGIN</span> <span class=o>=</span> <span class=mh>0x8000000</span><span class=p>,</span> <span class=n>LENGTH</span> <span class=o>=</span> <span class=mi>512</span><span class=n>K</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Define output sections */</span>
</span></span><span class=line><span class=cl><span class=n>SECTIONS</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* The startup code goes first into FLASH */</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>isr_vector</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>KEEP</span><span class=p>(</span><span class=o>*</span><span class=p>(.</span><span class=n>isr_vector</span><span class=p>))</span> <span class=cm>/* Startup code */</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&gt;</span><span class=n>FLASH</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* The program code and other data goes into FLASH */</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>text</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>text</span><span class=p>)</span>           <span class=cm>/* .text sections (code) */</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>text</span><span class=o>*</span><span class=p>)</span>          <span class=cm>/* .text* sections (code) */</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>glue_7</span><span class=p>)</span>         <span class=cm>/* glue arm to thumb code */</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>glue_7t</span><span class=p>)</span>        <span class=cm>/* glue thumb to arm code */</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>eh_frame</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>KEEP</span> <span class=p>(</span><span class=o>*</span><span class=p>(.</span><span class=n>init</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nf>KEEP</span> <span class=p>(</span><span class=o>*</span><span class=p>(.</span><span class=n>fini</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>_etext</span> <span class=o>=</span> <span class=p>.;</span>        <span class=cm>/* define a global symbols at end of code */</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&gt;</span><span class=n>FLASH</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Constant data goes into FLASH */</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>rodata</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>rodata</span><span class=p>)</span>         <span class=cm>/* .rodata sections (constants, strings, etc.) */</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>rodata</span><span class=o>*</span><span class=p>)</span>        <span class=cm>/* .rodata* sections (constants, strings, etc.) */</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&gt;</span><span class=n>FLASH</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>ARM</span><span class=p>.</span><span class=nl>extab</span>   <span class=p>:</span> <span class=p>{</span> <span class=o>*</span><span class=p>(.</span><span class=n>ARM</span><span class=p>.</span><span class=n>extab</span><span class=o>*</span> <span class=p>.</span><span class=n>gnu</span><span class=p>.</span><span class=n>linkonce</span><span class=p>.</span><span class=n>armextab</span><span class=p>.</span><span class=o>*</span><span class=p>)</span> <span class=p>}</span> <span class=o>&gt;</span><span class=n>FLASH</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>ARM</span> <span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>__exidx_start</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>ARM</span><span class=p>.</span><span class=n>exidx</span><span class=o>*</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>__exidx_end</span> <span class=o>=</span> <span class=p>.;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&gt;</span><span class=n>FLASH</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>preinit_array</span>     <span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>PROVIDE_HIDDEN</span> <span class=p>(</span><span class=n>__preinit_array_start</span> <span class=o>=</span> <span class=p>.);</span>
</span></span><span class=line><span class=cl>    <span class=nf>KEEP</span> <span class=p>(</span><span class=o>*</span><span class=p>(.</span><span class=n>preinit_array</span><span class=o>*</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nf>PROVIDE_HIDDEN</span> <span class=p>(</span><span class=n>__preinit_array_end</span> <span class=o>=</span> <span class=p>.);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&gt;</span><span class=n>FLASH</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>init_array</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>PROVIDE_HIDDEN</span> <span class=p>(</span><span class=n>__init_array_start</span> <span class=o>=</span> <span class=p>.);</span>
</span></span><span class=line><span class=cl>    <span class=nf>KEEP</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=nf>SORT</span><span class=p>(.</span><span class=n>init_array</span><span class=p>.</span><span class=o>*</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nf>KEEP</span> <span class=p>(</span><span class=o>*</span><span class=p>(.</span><span class=n>init_array</span><span class=o>*</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nf>PROVIDE_HIDDEN</span> <span class=p>(</span><span class=n>__init_array_end</span> <span class=o>=</span> <span class=p>.);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&gt;</span><span class=n>FLASH</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>fini_array</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>PROVIDE_HIDDEN</span> <span class=p>(</span><span class=n>__fini_array_start</span> <span class=o>=</span> <span class=p>.);</span>
</span></span><span class=line><span class=cl>    <span class=nf>KEEP</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=nf>SORT</span><span class=p>(.</span><span class=n>fini_array</span><span class=p>.</span><span class=o>*</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nf>KEEP</span> <span class=p>(</span><span class=o>*</span><span class=p>(.</span><span class=n>fini_array</span><span class=o>*</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nf>PROVIDE_HIDDEN</span> <span class=p>(</span><span class=n>__fini_array_end</span> <span class=o>=</span> <span class=p>.);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&gt;</span><span class=n>FLASH</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* used by the startup to initialize data */</span>
</span></span><span class=line><span class=cl>  <span class=n>_sidata</span> <span class=o>=</span> <span class=nf>LOADADDR</span><span class=p>(.</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Initialized data sections goes into RAM, load LMA copy after code */</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>data</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>_sdata</span> <span class=o>=</span> <span class=p>.;</span>        <span class=cm>/* create a global symbol at data start */</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>data</span><span class=p>)</span>           <span class=cm>/* .data sections */</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>data</span><span class=o>*</span><span class=p>)</span>          <span class=cm>/* .data* sections */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>_edata</span> <span class=o>=</span> <span class=p>.;</span>        <span class=cm>/* define a global symbol at data end */</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&gt;</span><span class=n>RAM</span> <span class=n>AT</span><span class=o>&gt;</span> <span class=n>FLASH</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Uninitialized data section */</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>bss</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* This is used by the startup in order to initialize the .bss secion */</span>
</span></span><span class=line><span class=cl>    <span class=n>_sbss</span> <span class=o>=</span> <span class=p>.;</span>         <span class=cm>/* define a global symbol at bss start */</span>
</span></span><span class=line><span class=cl>    <span class=n>__bss_start__</span> <span class=o>=</span> <span class=n>_sbss</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>bss</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(.</span><span class=n>bss</span><span class=o>*</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>COMMON</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>_ebss</span> <span class=o>=</span> <span class=p>.;</span>         <span class=cm>/* define a global symbol at bss end */</span>
</span></span><span class=line><span class=cl>    <span class=n>__bss_end__</span> <span class=o>=</span> <span class=n>_ebss</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&gt;</span><span class=n>RAM</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* User_heap_stack section, used to check that there is enough RAM left */</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nl>_user_heap_stack</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>PROVIDE</span> <span class=p>(</span> <span class=n>end</span> <span class=o>=</span> <span class=p>.</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>PROVIDE</span> <span class=p>(</span> <span class=n>_end</span> <span class=o>=</span> <span class=p>.</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=p>.</span> <span class=o>+</span> <span class=n>_Min_Heap_Size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=p>.</span> <span class=o>+</span> <span class=n>_Min_Stack_Size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span> <span class=o>=</span> <span class=nf>ALIGN</span><span class=p>(</span><span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&gt;</span><span class=n>RAM</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Remove information from the standard libraries */</span>
</span></span><span class=line><span class=cl>  <span class=o>/</span><span class=n>DISCARD</span><span class=o>/</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span><span class=p>.</span><span class=nf>a</span> <span class=p>(</span> <span class=o>*</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libm</span><span class=p>.</span><span class=nf>a</span> <span class=p>(</span> <span class=o>*</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libgcc</span><span class=p>.</span><span class=nf>a</span> <span class=p>(</span> <span class=o>*</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>ARM</span><span class=p>.</span><span class=n>attributes</span> <span class=mi>0</span> <span class=o>:</span> <span class=p>{</span> <span class=o>*</span><span class=p>(.</span><span class=n>ARM</span><span class=p>.</span><span class=n>attributes</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=编译出错>编译出错<a hidden class=anchor aria-hidden=true href=#编译出错>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>/tmp/cceEC3n9.s:599: Error: registers may not be the same -- `strexb r0,r0,[r1]&#39;
</span></span><span class=line><span class=cl>/tmp/cceEC3n9.s:629: Error: registers may not be the same -- `strexh r0,r0,[r1]&#39;
</span></span></code></pre></div><p>修改固件库中 <code>Libraries/CMSIS/CM4/CoreSupport/core_cm3.c</code> 文件</p><p>将 <code>__STREXB</code> 和 <code>__STREXH</code> 函数中的 <code>=r</code> 改为 <code>=&amp;r</code> ，一共有两处：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>__ASM</span> <span class=no>volatile</span> <span class=p>(</span><span class=err>&#34;</span><span class=no>strexb</span> <span class=err>%</span><span class=mi>0</span><span class=p>,</span> <span class=err>%</span><span class=mi>2</span><span class=p>,</span> <span class=p>[</span><span class=err>%</span><span class=mi>1</span><span class=p>]</span><span class=err>&#34;</span> <span class=p>:</span> <span class=err>&#34;=&amp;</span><span class=no>r</span><span class=err>&#34;</span> <span class=p>(</span><span class=no>result</span><span class=p>)</span> <span class=p>:</span> <span class=err>&#34;</span><span class=no>r</span><span class=err>&#34;</span> <span class=p>(</span><span class=no>addr</span><span class=p>),</span> <span class=err>&#34;</span><span class=no>r</span><span class=err>&#34;</span> <span class=p>(</span><span class=no>value</span><span class=p>)</span> <span class=p>)</span><span class=c1>;
</span></span></span></code></pre></div><p>貌似是 <code>gcc</code> 编译优化导致的问题，参考下列文章：</p><ul><li><a href=https://github.com/stlink-org/stlink/issues/65>Error: registers may not be the same &ndash; strexb r0,r0,[r1]</a></li><li><a href=http://www.cesareriva.com/fix-registers-may-not-be-the-same-error/>Fix registers may not be the same ARM GCC error</a></li><li><a href=https://amobbs.com/thread-5465367-1-1.html>gcc编译后出现与CMSIS相关的错误</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://kingtuo123.com/tags/stm32/>stm32</a></li><li><a href=https://kingtuo123.com/tags/linux/>linux</a></li><li><a href=https://kingtuo123.com/tags/makefile/>makefile</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://kingtuo123.com/>king's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>