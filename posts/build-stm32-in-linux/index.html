<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Linux 下编译 STM32 | Notes</title>
<meta name=keywords content="stm32,linux,makefile"><meta name=description content="使用 make 管理 stm32 工程"><meta name=author content><link rel=canonical href=https://kingtuo123.com/posts/build-stm32-in-linux/><link crossorigin=anonymous href=/assets/css/stylesheet.9b631aa8f87137a40827e2ab05b95cde78080f5a6239ffe81b7ba83a771b9bde.css integrity="sha256-m2MaqPhxN6QIJ+KrBblc3ngID1piOf/oG3uoOncbm94=" rel="preload stylesheet" as=style><link rel=icon href=https://kingtuo123.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kingtuo123.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kingtuo123.com/favicon-32x32.png><link rel=apple-touch-icon href=https://kingtuo123.com/apple-touch-icon.png><link rel=mask-icon href=https://kingtuo123.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Linux 下编译 STM32"><meta property="og:description" content="使用 make 管理 stm32 工程"><meta property="og:type" content="article"><meta property="og:url" content="https://kingtuo123.com/posts/build-stm32-in-linux/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-13T00:00:00+00:00"><meta property="article:modified_time" content="2022-07-13T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux 下编译 STM32"><meta name=twitter:description content="使用 make 管理 stm32 工程"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kingtuo123.com/posts/"},{"@type":"ListItem","position":2,"name":"Linux 下编译 STM32","item":"https://kingtuo123.com/posts/build-stm32-in-linux/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Linux 下编译 STM32","name":"Linux 下编译 STM32","description":"使用 make 管理 stm32 工程","keywords":["stm32","linux","makefile"],"articleBody":" 参考文章： gcc -ffunction-sections -fdata-sections -Wl,–gc-sections 参数详解 dwarf 调试信息存储格式 GCC STM32 链接文件和启动文件分析 源码 Github 下载地址 使用标准库 目录结构 $ tree . ├── Libraries │ ├── CMSIS │ └── STM32F10x_StdPeriph_Driver │ ├── inc │ └── src ├── makefile ├── STM32F103ZETx_FLASH.ld └── User ├── led │ ├── bsp_led.c │ └── bsp_led.h ├── main.c ├── stm32f10x_conf.h ├── stm32f10x_it.c └── stm32f10x_it.h Libraries 是从官方下载固件包中直接拷贝过来，内部目录不作调整。\nUser 是存放用户代码的目录。\nmakefile 文件 TARGET := LED-BLINK # 存放编译文件的目录 BUILD_DIR := ./Build # ARM GCC 工具链 TOOLCHAIN = arm-none-eabi- CC := $(TOOLCHAIN)gcc CP := $(TOOLCHAIN)objcopy AS := $(TOOLCHAIN)gcc -x assembler-with-cpp SZ := $(TOOLCHAIN)size HEX := $(CP) -O ihex BIN := $(CP) -O binary -S # CPU 内核架构 CPU := cortex-m3 # 链接脚本 LINK_SCRIPT := ./STM32F103ZETx_FLASH.ld # gcc 预定义参数 DEFS := -D STM32F10X_HD -D USE_STDPERIPH_DRIVER # 标准库头文件路径 INC_DIR := ./Libraries/CMSIS/CM3/CoreSupport/ INC_DIR += ./Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/ INC_DIR += ./Libraries/STM32F10x_StdPeriph_Driver/inc/ # 启动文件 ASM_SRC := ./Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/startup/gcc_ride7/startup_stm32f10x_hd.s # CMSIS 内核文件 C_SRC := ./Libraries/CMSIS/CM3/CoreSupport/core_cm3.c C_SRC += ./Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/system_stm32f10x.c # 标准库外设源码 C_SRC += $(wildcard ./Libraries/STM32F10x_StdPeriph_Driver/src/*.c) # 用户头文件路径 INC_DIR += ./User/ INC_DIR += ./User/led/ # 用户代码 C_SRC += $(wildcard ./User/*.c) C_SRC += $(wildcard ./User/led/*.c) # 目标文件 C_OBJ := $(addprefix $(BUILD_DIR)/,$(notdir $(C_SRC:.c=.o))) ASM_OBJ := $(addprefix $(BUILD_DIR)/,$(notdir $(ASM_SRC:.s=.o))) # 编译参数 CP_FLAGS := $(addprefix -I,$(INC_DIR)) -mcpu=$(CPU) -g -gdwarf-2 -mthumb -Os -Wall -fdata-sections -ffunction-sections -MMD -MP $(DEFS) # 汇编参数 AS_FLAGS := $(addprefix -I,$(INC_DIR)) -mcpu=$(CPU) -g -gdwarf-2 -mthumb -Os -Wall -fdata-sections -ffunction-sections -MMD -MP # 链接参数 LD_FLAGS := -mcpu=$(CPU) -specs=nano.specs -T $(LINK_SCRIPT) -Wl,-Map=$(BUILD_DIR)/$(TARGET).map,--cref,--gc-sections # 设置 make 文件搜索路径，.h文件由 gcc -I 参数包含了 vpath %.c $(sort $(dir $(C_SRC))) vpath %.s $(sort $(dir $(ASM_SRC))) # 保留目标文件，make 默认会删除编译生成的 .o 文件 .PRECIOUS: $(BUILD_DIR)/%.o # 编译规则 .PHONY: all all: $(BUILD_DIR) $(BUILD_DIR)/$(TARGET).elf $(BUILD_DIR)/$(TARGET).bin $(BUILD_DIR)/$(TARGET).hex @echo \"-------------------------------------------------------------------------------\" $(SZ) $(BUILD_DIR)/$(TARGET).elf @echo \"-------------------------------------------------------------------------------\" @stat $(BUILD_DIR)/$(TARGET).bin | head -n2 @echo \"-------------------------------------------------------------------------------\" $(BUILD_DIR)/%.o: %.c $(CC) -c $(CP_FLAGS) $\u003c -o $@ $(BUILD_DIR)/%.o: %.s $(AS) -c $(AS_FLAGS) $\u003c -o $@ %.elf: $(C_OBJ) $(ASM_OBJ) $(CC) $(LD_FLAGS) $^ -o $@ %.hex: %.elf $(HEX) $\u003c $@ %.bin: %.elf $(BIN) $\u003c $@ $(BUILD_DIR): mkdir -p $@ # 下面是清理和烧录命令 clean: rm $(BUILD_DIR)/* -rf rebuild: make clean \u0026\u0026 make install: st-flash write $(BUILD_DIR)/$(TARGET).bin 0x8000000 st-flash: st-flash write $(BUILD_DIR)/$(TARGET).bin 0x8000000 st-erase: st-flash erase isp-flash: stm32flash -b 115200 -i '-dtr\u0026rts,dtr:-dtr\u0026-rts,dtr' -v -w $(BUILD_DIR)/$(TARGET).bin /dev/ttyUSB0 isp-erase: stm32flash -b 115200 -i '-dtr\u0026rts,dtr:-dtr\u0026-rts,dtr' -o /dev/ttyUSB0 isp-info: stm32flash -b 115200 -i '-dtr\u0026rts,dtr:-dtr\u0026-rts,dtr' /dev/ttyUSB0 # 包含由 gcc -MMD 参数生成的 .d 文件 -include $(BUILD_DIR)/*.d STM32F103ZETx_FLASH.ld 链接脚本 链接脚本使用 STM32CubeMX 生成：\n随便建个工程，按图中所示选择 Makefile 生成代码即可，如下：\n// 设置入口符号 ENTRY(Reset_Handler) // 初始栈顶地址 _estack = ORIGIN(RAM) + LENGTH(RAM); // 设置堆栈大小 _Min_Heap_Size = 0x200; _Min_Stack_Size = 0x400; MEMORY { // RAM 起始地址和大小 RAM (xrw) : ORIGIN = 0x20000000, LENGTH = 64K // FLASH 起始地址和大小 FLASH (rx) : ORIGIN = 0x8000000, LENGTH = 512K } // 后面是段的分配，一般不需要改 // 略... 编译出错解决 $ make /tmp/cceEC3n9.s:599: Error: registers may not be the same -- `strexb r0,r0,[r1]' /tmp/cceEC3n9.s:629: Error: registers may not be the same -- `strexh r0,r0,[r1]' 修改标准库中 Libraries/CMSIS/CM3/CoreSupport/core_cm3.c 文件\n将 __STREXB 和 __STREXH 函数中的 =r 改为 =\u0026r ，一共有两处：\n__ASM volatile (\"strexb %0, %2, [%1]\" : \"=\u0026r\" (result) : \"r\" (addr), \"r\" (value) ); 貌似是 gcc 编译优化导致的问题，参考下列文章：\nError: registers may not be the same – strexb r0,r0,[r1] Fix registers may not be the same ARM GCC error gcc编译后出现与CMSIS相关的错误 成功编译后如下：\n$ make ------------------------------------------------------------------------------- arm-none-eabi-size ./Build/LED-BLINK.elf text data bss dec hex filename 1812 8 5152 6972 1b3c ./Build/LED-BLINK.elf ------------------------------------------------------------------------------- File: ./Build/LED-BLINK.bin Size: 1820 Blocks: 8 IO Block: 4096 regular file ------------------------------------------------------------------------------- GCC 参数说明 参数 说明 -D STM32F10X_HD 表示芯片容量 -D USE_STDPERIPH_DRIVER 表示使用官方标准固件库 -mcpu=cortex-m3 指定芯片内核架构 -g 产生调试信息 -gdwarf-2 调试信息格式 -mthumb 表示使用 thumb 指令集 -Os 优化代码大小 -Wall 允许输出所有警告 -MMD 生成依赖关系文件 .d，依赖不包括系统头文件 -MP 依赖规则中的所有 .h 依赖项都会在该文件中生成一个伪目标，其不依赖任何其他依赖项 -fdata-sections 为每个 data item 分配独立的 section，方便后面链接器优化 -ffunction-sections 为每个 function 分配独立的 section，方便后面链接器优化 -specs=nano.specs 使用精简版的C库替代标准C库，可以减少最终程序映像的大小 -T 指定链接脚本 -Wl 表示后面跟的参数传递给链接器，用逗号分隔 -Map= 生成 map 映射文件 –cref Cross Reference 的简写，输出交叉引用表 –gc-sections 不链接未用函数，减小可执行文件大小 使用 HAL 库 目录结构 . ├── Drivers │ ├── CMSIS │ │ ├── Device │ │ └── Include │ └── STM32F1xx_HAL_Driver │ ├── Inc │ └── Src ├── makefile ├── STM32F103ZETx_FLASH.ld └── User ├── led │ ├── bsp_led.c │ └── bsp_led.h ├── main.c ├── stm32f1xx_hal_conf.h ├── stm32f1xx_it.c └── stm32f1xx_it.h Drivers 从 HAL 库包中直接拷贝，不做调整。 makefile 只列出一部分，其它部分与上面标准库的 makefile 相同 # gcc 预定义参数 DEFS := -D USE_HAL_DRIVER -D STM32F103xE # HAL 库头文件路径 INC_DIR := ./Drivers/CMSIS/Include/ INC_DIR += ./Drivers/CMSIS/Device/ST/STM32F1xx/Include/ INC_DIR += ./Drivers/STM32F1xx_HAL_Driver/Inc/ # 启动文件 ASM_SRC := ./Drivers/CMSIS/Device/ST/STM32F1xx/Source/Templates/gcc/startup_stm32f103xe.s # CMSIS 系统文件 C_SRC := ./Drivers/CMSIS/Device/ST/STM32F1xx/Source/Templates/system_stm32f1xx.c # HAL 库外设源文件，最后去掉几个 template 模板文件 C_SRC += $(wildcard ./Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal*.c) C_SRC += ./Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_ll_usb.c C_SRC += ./Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_ll_sdmmc.c C_SRC += ./Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_ll_fsmc.c C_SRC := $(filter-out %template.c, $(C_SRC)) 使用 LL 库 目录结构 . ├── Drivers │ ├── CMSIS │ │ ├── Device │ │ └── Include │ └── STM32F1xx_HAL_Driver │ ├── Inc │ └── Src ├── makefile ├── STM32F103ZETx_FLASH.ld └── User ├── led │ ├── bsp_led.c │ └── bsp_led.h ├── main.c ├── stm32f1xx_it.c └── stm32f1xx_it.h makefile # gcc 预定义参数 DEFS := -D STM32F103xE \\ -D USE_FULL_LL_DRIVER \\ -D HSE_VALUE=8000000 \\ -D HSE_STARTUP_TIMEOUT=100 \\ -D LSE_STARTUP_TIMEOUT=5000 \\ -D LSE_VALUE=32768 \\ -D HSI_VALUE=8000000 \\ -D LSI_VALUE=40000 \\ -D VDD_VALUE=3300 \\ -D PREFETCH_ENABLE=1 # LL 库头文件路径 INC_DIR := ./Drivers/CMSIS/Include/ INC_DIR += ./Drivers/CMSIS/Device/ST/STM32F1xx/Include/ INC_DIR += ./Drivers/STM32F1xx_HAL_Driver/Inc/ # 启动文件 ASM_SRC := ./Drivers/CMSIS/Device/ST/STM32F1xx/Source/Templates/gcc/startup_stm32f103xe.s # CMSIS 系统文件 C_SRC := ./Drivers/CMSIS/Device/ST/STM32F1xx/Source/Templates/system_stm32f1xx.c # LL 库外设源文件，后面 3 个依赖 HAL 库，去掉 C_SRC += $(wildcard ./Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_ll*.c) C_SRC := $(filter-out %ll_usb.c, $(C_SRC)) C_SRC := $(filter-out %ll_sdmmc.c, $(C_SRC)) C_SRC := $(filter-out %ll_fsmc.c, $(C_SRC)) ","wordCount":"831","inLanguage":"en","datePublished":"2022-07-13T00:00:00Z","dateModified":"2022-07-13T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://kingtuo123.com/posts/build-stm32-in-linux/"},"publisher":{"@type":"Organization","name":"Notes","logo":{"@type":"ImageObject","url":"https://kingtuo123.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kingtuo123.com/ accesskey=h title="Notes (Alt + H)">Notes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kingtuo123.com/archives title=Archive>&nbsp;
<span class=menu-logo><svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox=".5 1 15 15" fill="none" stroke="currentcolor" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round"><rect height="3.5" width="12.5" y="2.75" x="1.75"/><path d="m6.75 9.25h2.5m-6.5-2.5v7.5h10.5v-7.5"/></svg></span></a></li><li><a href=https://kingtuo123.com/categories/ title=Categories>&nbsp;
<span class=menu-logo><svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox=".5 .5 23 23" fill="none" stroke="currentcolor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg></span></a></li><li><a href=https://kingtuo123.com/tags/ title=Tags>&nbsp;
<span class=menu-logo><svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="1 0 15 15" fill="none" stroke="currentcolor" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round" transform="matrix(-1,0,0,1,0,0)"><polygon points="7.25 14.25,1.75 8.75,8.75 1.75,14.25 1.75,14.25 7.25"/><circle cx="11" cy="5" r=".5" fill="#000"/></svg></span></a></li><li><a href=https://kingtuo123.com/search/ title="Search (Alt + /)" accesskey=/>&nbsp;
<span class=menu-logo><svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-4.4857-4.4935M19 10.5c0 4.6944-3.8056 8.5-8.5 8.5C5.80558 19 2 15.1944 2 10.5 2 5.80558 5.80558 2 10.5 2 15.1944 2 19 5.80558 19 10.5z"/></svg></span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Linux 下编译 STM32</h1><div class=post-meta><span title='2022-07-13 00:00:00 +0000 UTC'>July 13, 2022</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e6%ba%90%e7%a0%81 aria-label=源码>源码</a></li><li><a href=#%e4%bd%bf%e7%94%a8%e6%a0%87%e5%87%86%e5%ba%93 aria-label=使用标准库>使用标准库</a><ul><li><a href=#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84 aria-label=目录结构>目录结构</a></li><li><a href=#makefile-%e6%96%87%e4%bb%b6 aria-label="makefile 文件">makefile 文件</a></li><li><a href=#stm32f103zetx_flashld-%e9%93%be%e6%8e%a5%e8%84%9a%e6%9c%ac aria-label="STM32F103ZETx_FLASH.ld 链接脚本">STM32F103ZETx_FLASH.ld 链接脚本</a></li><li><a href=#%e7%bc%96%e8%af%91%e5%87%ba%e9%94%99%e8%a7%a3%e5%86%b3 aria-label=编译出错解决>编译出错解决</a></li><li><a href=#gcc-%e5%8f%82%e6%95%b0%e8%af%b4%e6%98%8e aria-label="GCC 参数说明">GCC 参数说明</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8-hal-%e5%ba%93 aria-label="使用 HAL 库">使用 HAL 库</a><ul><li><a href=#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84-1 aria-label=目录结构>目录结构</a></li><li><a href=#makefile aria-label=makefile>makefile</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8-ll-%e5%ba%93 aria-label="使用 LL 库">使用 LL 库</a><ul><li><a href=#%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84-2 aria-label=目录结构>目录结构</a></li><li><a href=#makefile-1 aria-label=makefile>makefile</a></li></ul></li></ul></div></details></div><div class=post-content><ul><li>参考文章：<ul><li><a href=https://blog.csdn.net/pengfei240/article/details/55228228>gcc -ffunction-sections -fdata-sections -Wl,–gc-sections 参数详解</a></li><li><a href=https://zhuanlan.zhihu.com/p/419908664>dwarf 调试信息存储格式</a></li><li><a href=https://blog.csdn.net/weixin_43522787/article/details/121869803>GCC STM32 链接文件和启动文件分析</a></li></ul></li></ul><h2 id=源码>源码<a hidden class=anchor aria-hidden=true href=#源码>#</a></h2><ul><li><a href=https://github.com/kingtuo123/stm32f103x-template>Github 下载地址</a></li></ul><h2 id=使用标准库>使用标准库<a hidden class=anchor aria-hidden=true href=#使用标准库>#</a></h2><h3 id=目录结构>目录结构<a hidden class=anchor aria-hidden=true href=#目录结构>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ tree
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Libraries
</span></span><span class=line><span class=cl>│   ├── CMSIS
</span></span><span class=line><span class=cl>│   └── STM32F10x_StdPeriph_Driver
</span></span><span class=line><span class=cl>│       ├── inc
</span></span><span class=line><span class=cl>│       └── src
</span></span><span class=line><span class=cl>├── makefile
</span></span><span class=line><span class=cl>├── STM32F103ZETx_FLASH.ld
</span></span><span class=line><span class=cl>└── User
</span></span><span class=line><span class=cl>    ├── led
</span></span><span class=line><span class=cl>    │   ├── bsp_led.c
</span></span><span class=line><span class=cl>    │   └── bsp_led.h
</span></span><span class=line><span class=cl>    ├── main.c
</span></span><span class=line><span class=cl>    ├── stm32f10x_conf.h
</span></span><span class=line><span class=cl>    ├── stm32f10x_it.c
</span></span><span class=line><span class=cl>    └── stm32f10x_it.h
</span></span></code></pre></div><ul><li><p><code>Libraries</code> 是从官方下载固件包中直接拷贝过来，内部目录不作调整。</p></li><li><p><code>User</code> 是存放用户代码的目录。</p></li></ul><h3 id=makefile-文件>makefile 文件<a hidden class=anchor aria-hidden=true href=#makefile-文件>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>TARGET</span>    <span class=o>:=</span> LED-BLINK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 存放编译文件的目录
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>BUILD_DIR</span> <span class=o>:=</span> ./Build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># ARM GCC 工具链
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>TOOLCHAIN</span>  <span class=o>=</span> arm-none-eabi-
</span></span><span class=line><span class=cl><span class=nv>CC</span>  <span class=o>:=</span> <span class=k>$(</span>TOOLCHAIN<span class=k>)</span>gcc
</span></span><span class=line><span class=cl><span class=nv>CP</span>  <span class=o>:=</span> <span class=k>$(</span>TOOLCHAIN<span class=k>)</span>objcopy
</span></span><span class=line><span class=cl><span class=nv>AS</span>  <span class=o>:=</span> <span class=k>$(</span>TOOLCHAIN<span class=k>)</span>gcc -x assembler-with-cpp
</span></span><span class=line><span class=cl><span class=nv>SZ</span>  <span class=o>:=</span> <span class=k>$(</span>TOOLCHAIN<span class=k>)</span>size
</span></span><span class=line><span class=cl><span class=nv>HEX</span> <span class=o>:=</span> <span class=k>$(</span>CP<span class=k>)</span> -O ihex
</span></span><span class=line><span class=cl><span class=nv>BIN</span> <span class=o>:=</span> <span class=k>$(</span>CP<span class=k>)</span> -O binary -S
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># CPU 内核架构
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>CPU</span> <span class=o>:=</span> cortex-m3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 链接脚本
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>LINK_SCRIPT</span> <span class=o>:=</span> ./STM32F103ZETx_FLASH.ld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># gcc 预定义参数
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>DEFS</span> <span class=o>:=</span> -D STM32F10X_HD -D USE_STDPERIPH_DRIVER
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 标准库头文件路径
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>INC_DIR</span> <span class=o>:=</span> ./Libraries/CMSIS/CM3/CoreSupport/
</span></span><span class=line><span class=cl><span class=nv>INC_DIR</span> <span class=o>+=</span> ./Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/
</span></span><span class=line><span class=cl><span class=nv>INC_DIR</span> <span class=o>+=</span> ./Libraries/STM32F10x_StdPeriph_Driver/inc/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 启动文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>ASM_SRC</span> <span class=o>:=</span> ./Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/startup/gcc_ride7/startup_stm32f10x_hd.s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># CMSIS 内核文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>C_SRC</span> <span class=o>:=</span> ./Libraries/CMSIS/CM3/CoreSupport/core_cm3.c
</span></span><span class=line><span class=cl><span class=nv>C_SRC</span> <span class=o>+=</span> ./Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/system_stm32f10x.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 标准库外设源码
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>C_SRC</span> <span class=o>+=</span> <span class=k>$(</span>wildcard ./Libraries/STM32F10x_StdPeriph_Driver/src/*.c<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 用户头文件路径
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>INC_DIR</span> <span class=o>+=</span> ./User/
</span></span><span class=line><span class=cl><span class=nv>INC_DIR</span> <span class=o>+=</span> ./User/led/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 用户代码
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>C_SRC</span> <span class=o>+=</span> <span class=k>$(</span>wildcard ./User/*.c<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>C_SRC</span> <span class=o>+=</span> <span class=k>$(</span>wildcard ./User/led/*.c<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 目标文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>C_OBJ</span> <span class=o>:=</span> <span class=k>$(</span>addprefix <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/,<span class=k>$(</span>notdir <span class=k>$(</span>C_SRC:.c<span class=o>=</span>.o<span class=k>)))</span>
</span></span><span class=line><span class=cl><span class=nv>ASM_OBJ</span> <span class=o>:=</span> <span class=k>$(</span>addprefix <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/,<span class=k>$(</span>notdir <span class=k>$(</span>ASM_SRC:.s<span class=o>=</span>.o<span class=k>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 编译参数
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>CP_FLAGS</span> <span class=o>:=</span> <span class=k>$(</span>addprefix -I,<span class=k>$(</span>INC_DIR<span class=k>))</span> -mcpu<span class=o>=</span><span class=k>$(</span>CPU<span class=k>)</span> -g -gdwarf-2 -mthumb -Os -Wall -fdata-sections -ffunction-sections -MMD -MP <span class=k>$(</span>DEFS<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=c># 汇编参数
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>AS_FLAGS</span> <span class=o>:=</span> <span class=k>$(</span>addprefix -I,<span class=k>$(</span>INC_DIR<span class=k>))</span> -mcpu<span class=o>=</span><span class=k>$(</span>CPU<span class=k>)</span> -g -gdwarf-2 -mthumb -Os -Wall -fdata-sections -ffunction-sections -MMD -MP
</span></span><span class=line><span class=cl><span class=c># 链接参数
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>LD_FLAGS</span> <span class=o>:=</span> -mcpu<span class=o>=</span><span class=k>$(</span>CPU<span class=k>)</span> -specs<span class=o>=</span>nano.specs -T <span class=k>$(</span>LINK_SCRIPT<span class=k>)</span> -Wl,-Map<span class=o>=</span><span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.map,--cref,--gc-sections
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 设置 make 文件搜索路径，.h文件由 gcc -I 参数包含了
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>vpath</span> <span class=err>%.c</span> <span class=k>$(</span><span class=nv>sort</span> <span class=k>$(</span><span class=nv>dir</span> <span class=k>$(</span><span class=nv>C_SRC</span><span class=k>)))</span>
</span></span><span class=line><span class=cl><span class=err>vpath</span> <span class=err>%.s</span> <span class=k>$(</span><span class=nv>sort</span> <span class=k>$(</span><span class=nv>dir</span> <span class=k>$(</span><span class=nv>ASM_SRC</span><span class=k>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 保留目标文件，make 默认会删除编译生成的 .o 文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>.PRECIOUS</span><span class=o>:</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span>/%.<span class=n>o</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 编译规则
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>.PHONY</span><span class=o>:</span> <span class=n>all</span>
</span></span><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span>/<span class=k>$(</span><span class=nv>TARGET</span><span class=k>)</span>.<span class=n>elf</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span>/<span class=k>$(</span><span class=nv>TARGET</span><span class=k>)</span>.<span class=n>bin</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span>/<span class=k>$(</span><span class=nv>TARGET</span><span class=k>)</span>.<span class=n>hex</span>
</span></span><span class=line><span class=cl>	@echo <span class=s2>&#34;-------------------------------------------------------------------------------&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>SZ<span class=k>)</span> <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.elf
</span></span><span class=line><span class=cl>	@echo <span class=s2>&#34;-------------------------------------------------------------------------------&#34;</span>
</span></span><span class=line><span class=cl>	@stat <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.bin <span class=p>|</span> head -n2
</span></span><span class=line><span class=cl>	@echo <span class=s2>&#34;-------------------------------------------------------------------------------&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(BUILD_DIR)/%.o</span><span class=o>:</span> %.<span class=n>c</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>CC<span class=k>)</span> -c <span class=k>$(</span>CP_FLAGS<span class=k>)</span> $&lt; -o <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(BUILD_DIR)/%.o</span><span class=o>:</span> %.<span class=n>s</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>AS<span class=k>)</span> -c <span class=k>$(</span>AS_FLAGS<span class=k>)</span> $&lt; -o <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>%.elf</span><span class=o>:</span> <span class=k>$(</span><span class=nv>C_OBJ</span><span class=k>)</span> <span class=k>$(</span><span class=nv>ASM_OBJ</span><span class=k>)</span> 
</span></span><span class=line><span class=cl>	<span class=k>$(</span>CC<span class=k>)</span> <span class=k>$(</span>LD_FLAGS<span class=k>)</span> $^ -o <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>%.hex</span><span class=o>:</span> %.<span class=n>elf</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>HEX<span class=k>)</span> $&lt; <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>%.bin</span><span class=o>:</span> %.<span class=n>elf</span>
</span></span><span class=line><span class=cl>	<span class=k>$(</span>BIN<span class=k>)</span> $&lt; <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>$(BUILD_DIR)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	mkdir -p <span class=nv>$@</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 下面是清理和烧录命令
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nf>clean</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	rm <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/* -rf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>rebuild</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	make clean <span class=o>&amp;&amp;</span> make
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>install</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	st-flash write <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.bin 0x8000000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>st-flash</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	st-flash write <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.bin 0x8000000
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>st-erase</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	st-flash erase
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>isp-flash</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	stm32flash -b <span class=m>115200</span> -i <span class=s1>&#39;-dtr&amp;rts,dtr:-dtr&amp;-rts,dtr&#39;</span> -v -w <span class=k>$(</span>BUILD_DIR<span class=k>)</span>/<span class=k>$(</span>TARGET<span class=k>)</span>.bin /dev/ttyUSB0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>isp-erase</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	stm32flash -b <span class=m>115200</span> -i <span class=s1>&#39;-dtr&amp;rts,dtr:-dtr&amp;-rts,dtr&#39;</span> -o /dev/ttyUSB0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>isp-info</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	stm32flash -b <span class=m>115200</span> -i <span class=s1>&#39;-dtr&amp;rts,dtr:-dtr&amp;-rts,dtr&#39;</span> /dev/ttyUSB0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 包含由 gcc -MMD 参数生成的 .d 文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=err>-include</span> <span class=k>$(</span><span class=nv>BUILD_DIR</span><span class=k>)</span><span class=err>/*.d</span>
</span></span></code></pre></div><h3 id=stm32f103zetx_flashld-链接脚本>STM32F103ZETx_FLASH.ld 链接脚本<a hidden class=anchor aria-hidden=true href=#stm32f103zetx_flashld-链接脚本>#</a></h3><p>链接脚本使用 <code>STM32CubeMX</code> 生成：</p><div align=center><img src=1.png style=max-height:180px></img></div><p>随便建个工程，按图中所示选择 <code>Makefile</code> 生成代码即可，如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 设置入口符号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>ENTRY</span><span class=p>(</span><span class=n>Reset_Handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 初始栈顶地址
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>_estack</span> <span class=o>=</span> <span class=nf>ORIGIN</span><span class=p>(</span><span class=n>RAM</span><span class=p>)</span> <span class=o>+</span> <span class=nf>LENGTH</span><span class=p>(</span><span class=n>RAM</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 设置堆栈大小
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>_Min_Heap_Size</span> <span class=o>=</span> <span class=mh>0x200</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>_Min_Stack_Size</span> <span class=o>=</span> <span class=mh>0x400</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MEMORY</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=c1>// RAM 起始地址和大小
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>RAM</span> <span class=p>(</span><span class=n>xrw</span><span class=p>)</span>      <span class=o>:</span> <span class=n>ORIGIN</span> <span class=o>=</span> <span class=mh>0x20000000</span><span class=p>,</span> <span class=n>LENGTH</span> <span class=o>=</span> <span class=mi>64</span><span class=n>K</span>
</span></span><span class=line><span class=cl><span class=c1>// FLASH 起始地址和大小
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>FLASH</span> <span class=p>(</span><span class=n>rx</span><span class=p>)</span>      <span class=o>:</span> <span class=n>ORIGIN</span> <span class=o>=</span> <span class=mh>0x8000000</span><span class=p>,</span> <span class=n>LENGTH</span> <span class=o>=</span> <span class=mi>512</span><span class=n>K</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 后面是段的分配，一般不需要改
</span></span></span><span class=line><span class=cl><span class=c1>// 略...
</span></span></span></code></pre></div><h3 id=编译出错解决>编译出错解决<a hidden class=anchor aria-hidden=true href=#编译出错解决>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash-session data-lang=bash-session><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>/tmp/cceEC3n9.s:599: Error: registers may not be the same -- `strexb r0,r0,[r1]&#39;
</span></span></span><span class=line><span class=cl><span class=go>/tmp/cceEC3n9.s:629: Error: registers may not be the same -- `strexh r0,r0,[r1]&#39;
</span></span></span></code></pre></div><p>修改标准库中 <code>Libraries/CMSIS/CM3/CoreSupport/core_cm3.c</code> 文件</p><p>将 <code>__STREXB</code> 和 <code>__STREXH</code> 函数中的 <code>=r</code> 改为 <code>=&amp;r</code> ，一共有两处：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>__ASM</span> <span class=no>volatile</span> <span class=p>(</span><span class=err>&#34;</span><span class=no>strexb</span> <span class=err>%</span><span class=mi>0</span><span class=p>,</span> <span class=err>%</span><span class=mi>2</span><span class=p>,</span> <span class=p>[</span><span class=err>%</span><span class=mi>1</span><span class=p>]</span><span class=err>&#34;</span> <span class=p>:</span> <span class=err>&#34;=&amp;</span><span class=no>r</span><span class=err>&#34;</span> <span class=p>(</span><span class=no>result</span><span class=p>)</span> <span class=p>:</span> <span class=err>&#34;</span><span class=no>r</span><span class=err>&#34;</span> <span class=p>(</span><span class=no>addr</span><span class=p>),</span> <span class=err>&#34;</span><span class=no>r</span><span class=err>&#34;</span> <span class=p>(</span><span class=no>value</span><span class=p>)</span> <span class=p>)</span><span class=c1>;
</span></span></span></code></pre></div><p>貌似是 <code>gcc</code> 编译优化导致的问题，参考下列文章：</p><ul><li><a href=https://github.com/stlink-org/stlink/issues/65>Error: registers may not be the same &ndash; strexb r0,r0,[r1]</a></li><li><a href=http://www.cesareriva.com/fix-registers-may-not-be-the-same-error/>Fix registers may not be the same ARM GCC error</a></li><li><a href=https://amobbs.com/thread-5465367-1-1.html>gcc编译后出现与CMSIS相关的错误</a></li></ul><p>成功编译后如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash-session data-lang=bash-session><span class=line><span class=cl><span class=gp>$</span> make
</span></span><span class=line><span class=cl><span class=go>-------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=go>arm-none-eabi-size ./Build/LED-BLINK.elf
</span></span></span><span class=line><span class=cl><span class=go>   text    data     bss     dec     hex filename
</span></span></span><span class=line><span class=cl><span class=go>   1812       8    5152    6972    1b3c ./Build/LED-BLINK.elf
</span></span></span><span class=line><span class=cl><span class=go>-------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=go>  File: ./Build/LED-BLINK.bin
</span></span></span><span class=line><span class=cl><span class=go>  Size: 1820            Blocks: 8          IO Block: 4096   regular file
</span></span></span><span class=line><span class=cl><span class=go>-------------------------------------------------------------------------------
</span></span></span></code></pre></div><h3 id=gcc-参数说明>GCC 参数说明<a hidden class=anchor aria-hidden=true href=#gcc-参数说明>#</a></h3><table><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>-D STM32F10X_HD</td><td style=text-align:left>表示芯片容量</td></tr><tr><td style=text-align:left>-D USE_STDPERIPH_DRIVER</td><td style=text-align:left>表示使用官方标准固件库</td></tr><tr><td style=text-align:left>-mcpu=cortex-m3</td><td style=text-align:left>指定芯片内核架构</td></tr><tr><td style=text-align:left>-g</td><td style=text-align:left>产生调试信息</td></tr><tr><td style=text-align:left>-gdwarf-2</td><td style=text-align:left>调试信息格式</td></tr><tr><td style=text-align:left>-mthumb</td><td style=text-align:left>表示使用 thumb 指令集</td></tr><tr><td style=text-align:left>-Os</td><td style=text-align:left>优化代码大小</td></tr><tr><td style=text-align:left>-Wall</td><td style=text-align:left>允许输出所有警告</td></tr><tr><td style=text-align:left>-MMD</td><td style=text-align:left>生成依赖关系文件 .d，依赖不包括系统头文件</td></tr><tr><td style=text-align:left>-MP</td><td style=text-align:left>依赖规则中的所有 .h 依赖项都会在该文件中生成一个伪目标，其不依赖任何其他依赖项</td></tr><tr><td style=text-align:left>-fdata-sections</td><td style=text-align:left>为每个 data item 分配独立的 section，方便后面链接器优化</td></tr><tr><td style=text-align:left>-ffunction-sections</td><td style=text-align:left>为每个 function 分配独立的 section，方便后面链接器优化</td></tr><tr><td style=text-align:left>-specs=nano.specs</td><td style=text-align:left>使用精简版的C库替代标准C库，可以减少最终程序映像的大小</td></tr><tr><td style=text-align:left>-T</td><td style=text-align:left>指定链接脚本</td></tr><tr><td style=text-align:left>-Wl</td><td style=text-align:left>表示后面跟的参数传递给链接器，用逗号分隔</td></tr><tr><td style=text-align:left>-Map=&lt;filename></td><td style=text-align:left>生成 map 映射文件</td></tr><tr><td style=text-align:left>&ndash;cref</td><td style=text-align:left>Cross Reference 的简写，输出交叉引用表</td></tr><tr><td style=text-align:left>&ndash;gc-sections</td><td style=text-align:left>不链接未用函数，减小可执行文件大小</td></tr></tbody></table><h2 id=使用-hal-库>使用 HAL 库<a hidden class=anchor aria-hidden=true href=#使用-hal-库>#</a></h2><h3 id=目录结构-1>目录结构<a hidden class=anchor aria-hidden=true href=#目录结构-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Drivers
</span></span><span class=line><span class=cl>│   ├── CMSIS
</span></span><span class=line><span class=cl>│   │   ├── Device
</span></span><span class=line><span class=cl>│   │   └── Include
</span></span><span class=line><span class=cl>│   └── STM32F1xx_HAL_Driver
</span></span><span class=line><span class=cl>│       ├── Inc
</span></span><span class=line><span class=cl>│       └── Src
</span></span><span class=line><span class=cl>├── makefile
</span></span><span class=line><span class=cl>├── STM32F103ZETx_FLASH.ld
</span></span><span class=line><span class=cl>└── User
</span></span><span class=line><span class=cl>    ├── led
</span></span><span class=line><span class=cl>    │   ├── bsp_led.c
</span></span><span class=line><span class=cl>    │   └── bsp_led.h
</span></span><span class=line><span class=cl>    ├── main.c
</span></span><span class=line><span class=cl>    ├── stm32f1xx_hal_conf.h
</span></span><span class=line><span class=cl>    ├── stm32f1xx_it.c
</span></span><span class=line><span class=cl>    └── stm32f1xx_it.h
</span></span></code></pre></div><ul><li><code>Drivers</code> 从 HAL 库包中直接拷贝，不做调整。</li></ul><h3 id=makefile>makefile<a hidden class=anchor aria-hidden=true href=#makefile>#</a></h3><ul><li>只列出一部分，其它部分与上面标准库的 makefile 相同</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># gcc 预定义参数
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>DEFS</span> <span class=o>:=</span> -D USE_HAL_DRIVER -D STM32F103xE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># HAL 库头文件路径
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>INC_DIR</span> <span class=o>:=</span> ./Drivers/CMSIS/Include/
</span></span><span class=line><span class=cl><span class=nv>INC_DIR</span> <span class=o>+=</span> ./Drivers/CMSIS/Device/ST/STM32F1xx/Include/
</span></span><span class=line><span class=cl><span class=nv>INC_DIR</span> <span class=o>+=</span> ./Drivers/STM32F1xx_HAL_Driver/Inc/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 启动文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>ASM_SRC</span> <span class=o>:=</span> ./Drivers/CMSIS/Device/ST/STM32F1xx/Source/Templates/gcc/startup_stm32f103xe.s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># CMSIS 系统文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>C_SRC</span> <span class=o>:=</span> ./Drivers/CMSIS/Device/ST/STM32F1xx/Source/Templates/system_stm32f1xx.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># HAL 库外设源文件，最后去掉几个 template 模板文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>C_SRC</span> <span class=o>+=</span> <span class=k>$(</span>wildcard ./Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_hal*.c<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>C_SRC</span> <span class=o>+=</span> ./Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_ll_usb.c
</span></span><span class=line><span class=cl><span class=nv>C_SRC</span> <span class=o>+=</span> ./Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_ll_sdmmc.c
</span></span><span class=line><span class=cl><span class=nv>C_SRC</span> <span class=o>+=</span> ./Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_ll_fsmc.c
</span></span><span class=line><span class=cl><span class=nv>C_SRC</span> <span class=o>:=</span> <span class=k>$(</span>filter-out %template.c, <span class=k>$(</span>C_SRC<span class=k>))</span>
</span></span></code></pre></div><h2 id=使用-ll-库>使用 LL 库<a hidden class=anchor aria-hidden=true href=#使用-ll-库>#</a></h2><h3 id=目录结构-2>目录结构<a hidden class=anchor aria-hidden=true href=#目录结构-2>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Drivers
</span></span><span class=line><span class=cl>│   ├── CMSIS
</span></span><span class=line><span class=cl>│   │   ├── Device
</span></span><span class=line><span class=cl>│   │   └── Include
</span></span><span class=line><span class=cl>│   └── STM32F1xx_HAL_Driver
</span></span><span class=line><span class=cl>│       ├── Inc
</span></span><span class=line><span class=cl>│       └── Src
</span></span><span class=line><span class=cl>├── makefile
</span></span><span class=line><span class=cl>├── STM32F103ZETx_FLASH.ld
</span></span><span class=line><span class=cl>└── User
</span></span><span class=line><span class=cl>    ├── led
</span></span><span class=line><span class=cl>    │   ├── bsp_led.c
</span></span><span class=line><span class=cl>    │   └── bsp_led.h
</span></span><span class=line><span class=cl>    ├── main.c
</span></span><span class=line><span class=cl>    ├── stm32f1xx_it.c
</span></span><span class=line><span class=cl>    └── stm32f1xx_it.h
</span></span></code></pre></div><h3 id=makefile-1>makefile<a hidden class=anchor aria-hidden=true href=#makefile-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># gcc 预定义参数
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>DEFS</span> <span class=o>:=</span> -D STM32F103xE <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -D USE_FULL_LL_DRIVER <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -D <span class=nv>HSE_VALUE</span><span class=o>=</span><span class=m>8000000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -D <span class=nv>HSE_STARTUP_TIMEOUT</span><span class=o>=</span><span class=m>100</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -D <span class=nv>LSE_STARTUP_TIMEOUT</span><span class=o>=</span><span class=m>5000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -D <span class=nv>LSE_VALUE</span><span class=o>=</span><span class=m>32768</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -D <span class=nv>HSI_VALUE</span><span class=o>=</span><span class=m>8000000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -D <span class=nv>LSI_VALUE</span><span class=o>=</span><span class=m>40000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -D <span class=nv>VDD_VALUE</span><span class=o>=</span><span class=m>3300</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -D <span class=nv>PREFETCH_ENABLE</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># LL 库头文件路径
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>INC_DIR</span> <span class=o>:=</span> ./Drivers/CMSIS/Include/
</span></span><span class=line><span class=cl><span class=nv>INC_DIR</span> <span class=o>+=</span> ./Drivers/CMSIS/Device/ST/STM32F1xx/Include/
</span></span><span class=line><span class=cl><span class=nv>INC_DIR</span> <span class=o>+=</span> ./Drivers/STM32F1xx_HAL_Driver/Inc/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 启动文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>ASM_SRC</span> <span class=o>:=</span> ./Drivers/CMSIS/Device/ST/STM32F1xx/Source/Templates/gcc/startup_stm32f103xe.s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># CMSIS 系统文件
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>C_SRC</span> <span class=o>:=</span> ./Drivers/CMSIS/Device/ST/STM32F1xx/Source/Templates/system_stm32f1xx.c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># LL 库外设源文件，后面 3 个依赖 HAL 库，去掉
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>C_SRC</span> <span class=o>+=</span> <span class=k>$(</span>wildcard ./Drivers/STM32F1xx_HAL_Driver/Src/stm32f1xx_ll*.c<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>C_SRC</span> <span class=o>:=</span> <span class=k>$(</span>filter-out %ll_usb.c, <span class=k>$(</span>C_SRC<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nv>C_SRC</span> <span class=o>:=</span> <span class=k>$(</span>filter-out %ll_sdmmc.c, <span class=k>$(</span>C_SRC<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nv>C_SRC</span> <span class=o>:=</span> <span class=k>$(</span>filter-out %ll_fsmc.c, <span class=k>$(</span>C_SRC<span class=k>))</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://kingtuo123.com/tags/stm32/>stm32</a></li><li><a href=https://kingtuo123.com/tags/linux/>linux</a></li><li><a href=https://kingtuo123.com/tags/makefile/>makefile</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://kingtuo123.com/>Notes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><div class=footer align=center style=margin-top:-30px><a href=https://beian.miit.gov.cn/ target=_blank>浙ICP备19041170号</a></div><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>