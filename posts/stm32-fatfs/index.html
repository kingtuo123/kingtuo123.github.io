<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>STM32 移植 FatFs R0.15 | Notes</title>
<meta name=keywords content><meta name=description content="stm32 移植 FatFs 并实现基本的读写功能"><meta name=author content><link rel=canonical href=https://kingtuo123.com/posts/stm32-fatfs/><link crossorigin=anonymous href=/assets/css/stylesheet.b9aa66fb71bd2fa5b8fd0bc055063047e8c5f68136a4b2b1fd963a713b2dba25.css integrity="sha256-uapm+3G9L6W4/QvAVQYwR+jF9oE2pLKx/ZY6cTstuiU=" rel="preload stylesheet" as=style><link rel=icon href=https://kingtuo123.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kingtuo123.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kingtuo123.com/favicon-32x32.png><link rel=apple-touch-icon href=https://kingtuo123.com/apple-touch-icon.png><link rel=mask-icon href=https://kingtuo123.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="STM32 移植 FatFs R0.15"><meta property="og:description" content="stm32 移植 FatFs 并实现基本的读写功能"><meta property="og:type" content="article"><meta property="og:url" content="https://kingtuo123.com/posts/stm32-fatfs/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-07-26T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="STM32 移植 FatFs R0.15"><meta name=twitter:description content="stm32 移植 FatFs 并实现基本的读写功能"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kingtuo123.com/posts/"},{"@type":"ListItem","position":2,"name":"STM32 移植 FatFs R0.15","item":"https://kingtuo123.com/posts/stm32-fatfs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"STM32 移植 FatFs R0.15","name":"STM32 移植 FatFs R0.15","description":"stm32 移植 FatFs 并实现基本的读写功能","keywords":[""],"articleBody":" 参考文章 FatFs 串行FLASH文件系统FatFs 硬件 STM32F103ZET6 Flash芯片：W25Q64JV FatFs 源码 下载地址 解压后，源码都在 source 文件夹中\n添加到 Keil 工程，记得添加头文件路径\n配置 ffconf.h // 使能 f_mkfs 函数 #define FF_USE_MKFS 1 // 支持 U.S. 编码。中文是936，但是会大大增加烧录程序的大小 #define FF_CODE_PAGE 437 // 支持长文件名 #define FF_USE_LFN 1 // 文件名使用 utf8 编码，如果设置了这一项，则 FF_CODE_PAGE 没有意义 #define FF_LFN_UNICODE 2 // 物理设备数量 #define FF_VOLUMES 1 // 扇区大小的最小值 #define FF_MIN_SS 512 // 扇区大小的最大值 #define FF_MAX_SS 4096 // 不使用时间戳，如果设置0启用，则需要添加 get_fattime 函数 #define FF_FS_NORTC 1 编辑 diskio.c 需修改设备编号 DEV_FLASH 宏定义，及所有函数。\n/* This is an example of glue functions to attach various exsisting */ /* storage control modules to the FatFs module with a defined API. */ /*-----------------------------------------------------------------------*/ #include \"ff.h\" /* Obtains integer types */ #include \"diskio.h\" /* Declarations of disk functions */ #include \"bsp_flash.h\" /* Definitions of physical drive number for each drive */ #define DEV_FLASH 0 /*-----------------------------------------------------------------------*/ /* Get Drive Status */ /*-----------------------------------------------------------------------*/ DSTATUS disk_status ( BYTE pdrv /* Physical drive nmuber to identify the drive */ ) { switch (pdrv) { case DEV_FLASH : // 通过读 Flash id 判断 if(FLASH_JADEC_ID == FLASH_ReadJedecID()) return RES_OK; else return STA_NOINIT; default: return STA_NOINIT; } } /*-----------------------------------------------------------------------*/ /* Inidialize a Drive */ /*-----------------------------------------------------------------------*/ DSTATUS disk_initialize ( BYTE pdrv /* Physical drive nmuber to identify the drive */ ) { switch (pdrv) { case DEV_FLASH : // Flash 初始化 FLASH_Init(); return RES_OK; default: return STA_NOINIT; } } /*-----------------------------------------------------------------------*/ /* Read Sector(s) */ /*-----------------------------------------------------------------------*/ DRESULT disk_read ( BYTE pdrv, /* Physical drive nmuber to identify the drive */ BYTE *buff, /* Data buffer to store read data */ LBA_t sector, /* Start sector in LBA */ UINT count /* Number of sectors to read */ ) { switch (pdrv) { case DEV_FLASH : FLASH_Read(sector*FLASH_SECTOR_SIZE, buff, count*FLASH_SECTOR_SIZE); return RES_OK; default: return RES_PARERR; } } /*-----------------------------------------------------------------------*/ /* Write Sector(s) */ /*-----------------------------------------------------------------------*/ #if FF_FS_READONLY == 0 DRESULT disk_write ( BYTE pdrv, /* Physical drive nmuber to identify the drive */ const BYTE *buff, /* Data to be written */ LBA_t sector, /* Start sector in LBA */ UINT count /* Number of sectors to write */ ) { switch (pdrv) { case DEV_FLASH : // Flash 写入前需擦除扇区 FLASH_SectorErase(sector*FLASH_SECTOR_SIZE); FLASH_Write(sector*FLASH_SECTOR_SIZE, (uint8_t*)buff, count*FLASH_SECTOR_SIZE); return RES_OK; default: return RES_PARERR; } } #endif /*-----------------------------------------------------------------------*/ /* Miscellaneous Functions */ /*-----------------------------------------------------------------------*/ DRESULT disk_ioctl ( BYTE pdrv, /* Physical drive nmuber (0..) */ BYTE cmd, /* Control code */ void *buff /* Buffer to send/receive control data */ ) { switch (pdrv) { case DEV_FLASH: switch (cmd) { case GET_SECTOR_COUNT: // 扇区数量 2048 *(DWORD*)buff = FLASH_SECTOR_COUNT; return RES_OK; // 扇区大小 4096 case GET_SECTOR_SIZE: *(WORD*)buff = FLASH_SECTOR_SIZE; return RES_OK; // 同时擦除扇区个数 case GET_BLOCK_SIZE: *(DWORD*)buff = 1; return RES_OK; default: return RES_OK; } default: return RES_PARERR; } } 测试程序 Flash 驱动见这篇文章 Flash SPI 因为缓冲区数组较大，所以要适当修改 启动文件 中 栈 的大小，以免溢出。 uint16_t fatfs_test(void){ FATFS fs; // 文件系统对象 FIL fp; // 文件对象 FRESULT ret; // 返回值 UINT fnum; // 存储写入/读取的字节数 BYTE workbuf[FF_MAX_SS]; // 格式化缓冲区 BYTE readbuf[100]; // 读缓冲区 BYTE writebuf[] = \"你好,世界!\"; // 写缓冲区 TCHAR* dev = \"0:\"; // DEV_FLASH设备号 TCHAR* fname = \"0:hello.txt\"; // 文件名 MKFS_PARM opt; // 格式化参数 opt.fmt = FM_FAT; // 文件系统类型 opt.n_fat = 0; // 0表示默认值 opt.align = 0; // opt.n_root = 0; // opt.au_size = FF_MAX_SS; // 簇大小 // 挂载设备 ret = f_mount(\u0026fs, dev, 1); switch(ret){ case FR_OK: printf(\"挂载成功\\r\\n\"); break; case FR_NO_FILESYSTEM: ret = f_mkfs(\"0:\", \u0026opt, workbuf, FF_MAX_SS); if(!ret){ printf(\"格式化成功\\r\\n\"); }else{ printf(\"格式化失败（%d）\\r\\n\", ret); return ret; } break; default: printf(\"挂载失败（%d）\\r\\n\", ret); return ret; } // 测试打开文件写入 ret = f_open(\u0026fp, fname, FA_CREATE_ALWAYS | FA_WRITE ); if(ret){ printf(\"打开/创建文件失败（%d）\\r\\n\", ret); return ret; } ret = f_write(\u0026fp, writebuf, sizeof(writebuf), \u0026fnum); if(ret){ printf(\"文件写入失败（%d）\\r\\n\", ret); return ret; } printf(\"文件写入字节数：%d \\r\\n\", fnum); f_close(\u0026fp); // 测试打开文件读取 ret = f_open(\u0026fp, fname, FA_OPEN_EXISTING | FA_READ); if(ret){ printf(\"打开文件失败（%d）\\r\\n\", ret); return ret; } ret = f_read(\u0026fp, readbuf, sizeof(readbuf), \u0026fnum); if(ret){ printf(\"文件读取失败（%d）\\r\\n\", ret); return ret; } printf(\"文件读取字节数：%d \\r\\n\", fnum); printf(\"文件内容：\\r\\n%s\\r\\n\", readbuf); f_close(\u0026fp); // 卸载设备 f_mount(NULL, dev, 1); return 0; } ","wordCount":"623","inLanguage":"en","datePublished":"2023-07-26T00:00:00Z","dateModified":"2023-07-26T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://kingtuo123.com/posts/stm32-fatfs/"},"publisher":{"@type":"Organization","name":"Notes","logo":{"@type":"ImageObject","url":"https://kingtuo123.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kingtuo123.com/ accesskey=h title="Notes (Alt + H)">Notes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kingtuo123.com/archives title=Archive><span>Archive</span>&nbsp;
<span class=menu-logo><svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox=".5 1 15 15" fill="none" stroke="currentcolor" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round"><rect height="3.5" width="12.5" y="2.75" x="1.75"/><path d="m6.75 9.25h2.5m-6.5-2.5v7.5h10.5v-7.5"/></svg></span></a></li><li><a href=https://kingtuo123.com/categories/ title=Categories><span>Categories</span>&nbsp;
<span class=menu-logo><svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 23 23" fill="none" stroke="currentcolor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg></span></a></li><li><a href=https://kingtuo123.com/tags/ title=Tags><span>Tags</span>&nbsp;
<span class=menu-logo><svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="1 0 15 15" fill="none" stroke="currentcolor" stroke-width="1.1" stroke-linecap="round" stroke-linejoin="round" transform="matrix(-1,0,0,1,0,0)"><polygon points="7.25 14.25,1.75 8.75,8.75 1.75,14.25 1.75,14.25 7.25"/><circle cx="11" cy="5" r=".5" fill="#000"/></svg></span></a></li><li><a href=https://kingtuo123.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span>&nbsp;
<span class=menu-logo><svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-4.4857-4.4935M19 10.5c0 4.6944-3.8056 8.5-8.5 8.5C5.80558 19 2 15.1944 2 10.5 2 5.80558 5.80558 2 10.5 2 15.1944 2 19 5.80558 19 10.5z"/></svg></span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>STM32 移植 FatFs R0.15</h1><div class=post-meta><span title='2023-07-26 00:00:00 +0000 UTC'>July 26, 2023</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e7%a1%ac%e4%bb%b6 aria-label=硬件>硬件</a></li><li><a href=#fatfs-%e6%ba%90%e7%a0%81 aria-label="FatFs 源码">FatFs 源码</a></li><li><a href=#%e9%85%8d%e7%bd%ae-ffconfh aria-label="配置 ffconf.h">配置 ffconf.h</a></li><li><a href=#%e7%bc%96%e8%be%91-diskioc aria-label="编辑 diskio.c">编辑 diskio.c</a></li><li><a href=#%e6%b5%8b%e8%af%95%e7%a8%8b%e5%ba%8f aria-label=测试程序>测试程序</a></li></ul></div></details></div><div class=post-content><ul><li>参考文章<ul><li><a href=http://elm-chan.org/fsw/ff/00index_e.html>FatFs</a></li><li><a href=https://doc.embedfire.com/mcu/stm32/f103badao/std/zh/latest/book/FLASH_FatFs.html#>串行FLASH文件系统FatFs</a></li></ul></li></ul><h2 id=硬件>硬件<a hidden class=anchor aria-hidden=true href=#硬件>#</a></h2><ul><li>STM32F103ZET6</li><li>Flash芯片：W25Q64JV</li></ul><h2 id=fatfs-源码>FatFs 源码<a hidden class=anchor aria-hidden=true href=#fatfs-源码>#</a></h2><div align=left><img src=0.png style=max-height:80px></img></div><ul><li><a href=http://elm-chan.org/fsw/ff/00index_e.html>下载地址</a></li></ul><p>解压后，源码都在 source 文件夹中</p><div align=left><img src=1.png style=max-height:210px></img></div><p>添加到 Keil 工程，记得添加头文件路径</p><div align=left><img src=2.png style=max-height:90px></img></div><h2 id=配置-ffconfh>配置 ffconf.h<a hidden class=anchor aria-hidden=true href=#配置-ffconfh>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 使能 f_mkfs 函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define FF_USE_MKFS     1
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 支持 U.S. 编码。中文是936，但是会大大增加烧录程序的大小
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define FF_CODE_PAGE    437
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 支持长文件名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define FF_USE_LFN      1
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 文件名使用 utf8 编码，如果设置了这一项，则 FF_CODE_PAGE 没有意义
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define FF_LFN_UNICODE  2
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 物理设备数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define FF_VOLUMES      1
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 扇区大小的最小值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define FF_MIN_SS       512
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 扇区大小的最大值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define FF_MAX_SS       4096
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 不使用时间戳，如果设置0启用，则需要添加 get_fattime 函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define FF_FS_NORTC     1
</span></span></span></code></pre></div><h2 id=编辑-diskioc>编辑 diskio.c<a hidden class=anchor aria-hidden=true href=#编辑-diskioc>#</a></h2><p>需修改设备编号 DEV_FLASH 宏定义，及所有函数。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* This is an example of glue functions to attach various exsisting      */</span>
</span></span><span class=line><span class=cl><span class=cm>/* storage control modules to the FatFs module with a defined API.       */</span>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;ff.h&#34;                 /* Obtains integer types */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;diskio.h&#34;             /* Declarations of disk functions */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;bsp_flash.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* Definitions of physical drive number for each drive */</span>
</span></span><span class=line><span class=cl><span class=cp>#define DEV_FLASH    0
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl><span class=cm>/* Get Drive Status                                                      */</span>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DSTATUS</span> <span class=nf>disk_status</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>BYTE</span> <span class=n>pdrv</span>               <span class=cm>/* Physical drive nmuber to identify the drive */</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>pdrv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>DEV_FLASH</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 通过读 Flash id 判断
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span><span class=p>(</span><span class=n>FLASH_JADEC_ID</span> <span class=o>==</span> <span class=nf>FLASH_ReadJedecID</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>RES_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>STA_NOINIT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>STA_NOINIT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl><span class=cm>/* Inidialize a Drive                                                    */</span>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DSTATUS</span> <span class=nf>disk_initialize</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>BYTE</span> <span class=n>pdrv</span>               <span class=cm>/* Physical drive nmuber to identify the drive */</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>pdrv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>DEV_FLASH</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Flash 初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>FLASH_Init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>RES_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>STA_NOINIT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl><span class=cm>/* Read Sector(s)                                                        */</span>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DRESULT</span> <span class=nf>disk_read</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>BYTE</span> <span class=n>pdrv</span><span class=p>,</span>              <span class=cm>/* Physical drive nmuber to identify the drive */</span>
</span></span><span class=line><span class=cl>    <span class=n>BYTE</span> <span class=o>*</span><span class=n>buff</span><span class=p>,</span>             <span class=cm>/* Data buffer to store read data */</span>
</span></span><span class=line><span class=cl>    <span class=n>LBA_t</span> <span class=n>sector</span><span class=p>,</span>           <span class=cm>/* Start sector in LBA */</span>
</span></span><span class=line><span class=cl>    <span class=n>UINT</span> <span class=n>count</span>              <span class=cm>/* Number of sectors to read */</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>pdrv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>DEV_FLASH</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nf>FLASH_Read</span><span class=p>(</span><span class=n>sector</span><span class=o>*</span><span class=n>FLASH_SECTOR_SIZE</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=n>count</span><span class=o>*</span><span class=n>FLASH_SECTOR_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>RES_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>RES_PARERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl><span class=cm>/* Write Sector(s)                                                       */</span>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if FF_FS_READONLY == 0
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>DRESULT</span> <span class=nf>disk_write</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>BYTE</span> <span class=n>pdrv</span><span class=p>,</span>              <span class=cm>/* Physical drive nmuber to identify the drive */</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>BYTE</span> <span class=o>*</span><span class=n>buff</span><span class=p>,</span>       <span class=cm>/* Data to be written */</span>
</span></span><span class=line><span class=cl>    <span class=n>LBA_t</span> <span class=n>sector</span><span class=p>,</span>           <span class=cm>/* Start sector in LBA */</span>
</span></span><span class=line><span class=cl>    <span class=n>UINT</span> <span class=n>count</span>              <span class=cm>/* Number of sectors to write */</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>pdrv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>DEV_FLASH</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Flash 写入前需擦除扇区
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>FLASH_SectorErase</span><span class=p>(</span><span class=n>sector</span><span class=o>*</span><span class=n>FLASH_SECTOR_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>FLASH_Write</span><span class=p>(</span><span class=n>sector</span><span class=o>*</span><span class=n>FLASH_SECTOR_SIZE</span><span class=p>,</span> <span class=p>(</span><span class=kt>uint8_t</span><span class=o>*</span><span class=p>)</span><span class=n>buff</span><span class=p>,</span> <span class=n>count</span><span class=o>*</span><span class=n>FLASH_SECTOR_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>RES_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>RES_PARERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl><span class=cm>/* Miscellaneous Functions                                               */</span>
</span></span><span class=line><span class=cl><span class=cm>/*-----------------------------------------------------------------------*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>DRESULT</span> <span class=nf>disk_ioctl</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>BYTE</span> <span class=n>pdrv</span><span class=p>,</span>              <span class=cm>/* Physical drive nmuber (0..)</span> <span class=err>*/</span>
</span></span><span class=line><span class=cl>    <span class=n>BYTE</span> <span class=n>cmd</span><span class=p>,</span>               <span class=cm>/* Control code */</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>buff</span>              <span class=cm>/* Buffer to send/receive control data */</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>pdrv</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>DEV_FLASH</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>switch</span> <span class=p>(</span><span class=n>cmd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=nl>GET_SECTOR_COUNT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 扇区数量 2048
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=o>*</span><span class=p>(</span><span class=n>DWORD</span><span class=o>*</span><span class=p>)</span><span class=n>buff</span> <span class=o>=</span> <span class=n>FLASH_SECTOR_COUNT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>RES_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 扇区大小 4096
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>case</span> <span class=nl>GET_SECTOR_SIZE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=o>*</span><span class=p>(</span><span class=n>WORD</span><span class=o>*</span><span class=p>)</span><span class=n>buff</span> <span class=o>=</span> <span class=n>FLASH_SECTOR_SIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>RES_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// 同时擦除扇区个数
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>case</span> <span class=nl>GET_BLOCK_SIZE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=o>*</span><span class=p>(</span><span class=n>DWORD</span><span class=o>*</span><span class=p>)</span><span class=n>buff</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>RES_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>RES_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>RES_PARERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=测试程序>测试程序<a hidden class=anchor aria-hidden=true href=#测试程序>#</a></h2><ul><li>Flash 驱动见这篇文章 <a href=../stm32-spi/>Flash SPI</a></li><li>因为缓冲区数组较大，所以要适当修改 <strong>启动文件</strong> 中 <strong>栈</strong> 的大小，以免溢出。</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>uint16_t</span> <span class=nf>fatfs_test</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>FATFS</span> <span class=n>fs</span><span class=p>;</span>                        <span class=c1>// 文件系统对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>FIL</span> <span class=n>fp</span><span class=p>;</span>                          <span class=c1>// 文件对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>FRESULT</span> <span class=n>ret</span><span class=p>;</span>                     <span class=c1>// 返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>UINT</span> <span class=n>fnum</span><span class=p>;</span>                       <span class=c1>// 存储写入/读取的字节数 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>BYTE</span> <span class=n>workbuf</span><span class=p>[</span><span class=n>FF_MAX_SS</span><span class=p>];</span>         <span class=c1>// 格式化缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>BYTE</span> <span class=n>readbuf</span><span class=p>[</span><span class=mi>100</span><span class=p>];</span>               <span class=c1>// 读缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>BYTE</span> <span class=n>writebuf</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;你好,世界!&#34;</span><span class=p>;</span>   <span class=c1>// 写缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>TCHAR</span><span class=o>*</span> <span class=n>dev</span>      <span class=o>=</span> <span class=s>&#34;0:&#34;</span><span class=p>;</span>          <span class=c1>// DEV_FLASH设备号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>TCHAR</span><span class=o>*</span> <span class=n>fname</span>    <span class=o>=</span> <span class=s>&#34;0:hello.txt&#34;</span><span class=p>;</span> <span class=c1>// 文件名
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>MKFS_PARM</span> <span class=n>opt</span><span class=p>;</span>             <span class=c1>// 格式化参数               
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>opt</span><span class=p>.</span><span class=n>fmt</span>     <span class=o>=</span> <span class=n>FM_FAT</span><span class=p>;</span>      <span class=c1>// 文件系统类型
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>opt</span><span class=p>.</span><span class=n>n_fat</span>   <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>           <span class=c1>// 0表示默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>opt</span><span class=p>.</span><span class=n>align</span>   <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>           <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>opt</span><span class=p>.</span><span class=n>n_root</span>  <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>           <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>opt</span><span class=p>.</span><span class=n>au_size</span> <span class=o>=</span> <span class=n>FF_MAX_SS</span><span class=p>;</span>   <span class=c1>// 簇大小    
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// 挂载设备
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>f_mount</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fs</span><span class=p>,</span> <span class=n>dev</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span><span class=p>(</span><span class=n>ret</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>FR_OK</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;挂载成功</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>FR_NO_FILESYSTEM</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=nf>f_mkfs</span><span class=p>(</span><span class=s>&#34;0:&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>opt</span><span class=p>,</span> <span class=n>workbuf</span><span class=p>,</span> <span class=n>FF_MAX_SS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>ret</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;格式化成功</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;格式化失败（%d）</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;挂载失败（%d）</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 测试打开文件写入
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>f_open</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fp</span><span class=p>,</span> <span class=n>fname</span><span class=p>,</span> <span class=n>FA_CREATE_ALWAYS</span> <span class=o>|</span> <span class=n>FA_WRITE</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;打开/创建文件失败（%d）</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>f_write</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fp</span><span class=p>,</span> <span class=n>writebuf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>writebuf</span><span class=p>),</span> <span class=o>&amp;</span><span class=n>fnum</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;文件写入失败（%d）</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;文件写入字节数：%d </span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>fnum</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>f_close</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 测试打开文件读取
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>f_open</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fp</span><span class=p>,</span> <span class=n>fname</span><span class=p>,</span> <span class=n>FA_OPEN_EXISTING</span> <span class=o>|</span> <span class=n>FA_READ</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;打开文件失败（%d）</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>ret</span> <span class=o>=</span> <span class=nf>f_read</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fp</span><span class=p>,</span> <span class=n>readbuf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>readbuf</span><span class=p>),</span> <span class=o>&amp;</span><span class=n>fnum</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;文件读取失败（%d）</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ret</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;文件读取字节数：%d </span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>fnum</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;文件内容：</span><span class=se>\r\n</span><span class=s>%s</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>readbuf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>f_close</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 卸载设备
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>f_mount</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=n>dev</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://kingtuo123.com/>Notes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><div class=footer align=center style=margin-top:-30px><a href=https://beian.miit.gov.cn/ target=_blank>浙ICP备19041170号</a></div><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>