<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>STM32 I2C | Notes</title><meta name=keywords content="stm32"><meta name=description content="Note"><meta name=author content><link rel=canonical href=https://kingtuo123.com/posts/stm32-i2c/><link crossorigin=anonymous href=/assets/css/stylesheet.5f2a09e442c86c3d6238f084725799856505d1f9372b5b92a1c1499e5f771fc1.css integrity="sha256-XyoJ5ELIbD1iOPCEcleZhWUF0fk3K1uSocFJnl93H8E=" rel="preload stylesheet" as=style><link rel=icon href=https://kingtuo123.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kingtuo123.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kingtuo123.com/favicon-32x32.png><link rel=apple-touch-icon href=https://kingtuo123.com/apple-touch-icon.png><link rel=mask-icon href=https://kingtuo123.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="STM32 I2C"><meta property="og:description" content="Note"><meta property="og:type" content="article"><meta property="og:url" content="https://kingtuo123.com/posts/stm32-i2c/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-24T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-24T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="STM32 I2C"><meta name=twitter:description content="Note"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kingtuo123.com/posts/"},{"@type":"ListItem","position":2,"name":"STM32 I2C","item":"https://kingtuo123.com/posts/stm32-i2c/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"STM32 I2C","name":"STM32 I2C","description":"Note","keywords":["stm32"],"articleBody":"参考文章\nI2C I2C 时钟延展 基本结构 起始和停止信号 当 SCL 是高电平时 SDA 线从高电平向低电平切换，表示通讯的起始。（下降沿触发）\n当 SCL 是高电平时 SDA 线由低电平向高电平切换，表示通讯的停止。（上升沿触发）\n数据有效性 SCL 为高电平的时候 SDA 表示的数据有效\n7 位地址 如上图所示，通常地址高 4 位 A6-A3 表示器件类型，存储类芯片一般是 1010b ，这是由半导体厂家固定的。\n低 3 位 A2-A0 表示器件地址，一般由器件的引脚电路决定。\nR/W 位指示这是读取 (1) 还是写入 (0) 操作的 。\n10 位地址 10 位的地址分为两帧发送。\n第一帧，0b 11110 表示使用 10 位的地址。A9、A8 是地址的高 2 位。 第二帧，A7-A0 是地址的后 8 位。 第三帧，普通的数据帧。 响应 响应包括 “应答 (ACK)” 和 “非应答 (NACK)” 两种信号。\nACK：继续发送 NACK：结束发送 重复起始信号 I2C 通讯更常用的是复合格式，例如：第一次通讯是告诉从机读写地址，第二次则是读写的实际内容。\n重复起始信号如下：\n时钟延展 在 I2C 的主从通信过程中，总线上的 SCL 时钟总是由主机来产生和控制的，但如果从机跟不上主机的速率，I2C 协议规定从机是可以通过将 SCL 时钟线拉低来暂停一下传输，直到从机释放掉SCL线，传输继续进行。\n总的来说，clock stretching 其实是一种降频的手段，使得更高频率的主机也能适应低频率从机的通信。\nSTM32 I2C 收发事件 主机发送序列 主机接收序列 寄存器 控制寄存器 1（I2C CR1） 控制寄存器 2（I2C_CR2） 自身地址寄存器 1（I2C_OAR1） 自身地址寄存器 2（I2C_OAR2） 数据寄存器（I2C_DR） 状态寄存器 1（I2C_SR1） 状态寄存器 2 （I2C_SR2） 时钟控制寄存器（I2C_CCR） TRISE寄存器（I2C_TRISE） EEPROM I2C 驱动（标准库） 单片机：STM32F103ZET6 EEPROM：AT24C02 使用硬件 I2C 驱动 bsp_eeprom.h #ifndef __BSP_EEPROM_H #define __BSP_EEPROM_H #include \"stm32f10x.h\" #define EEPROM_I2Cx I2C1 #define EEPROM_I2C_APBxClock_FUN RCC_APB1PeriphClockCmd #define EEPROM_I2C_CLK RCC_APB1Periph_I2C1 #define EEPROM_I2C_GPIO_APBxClock_FUN RCC_APB2PeriphClockCmd #define EEPROM_I2C_GPIO_CLK RCC_APB2Periph_GPIOB #define EEPROM_I2C_SCL_PORT GPIOB #define EEPROM_I2C_SCL_PIN GPIO_Pin_6 #define EEPROM_I2C_SDA_PORT GPIOB #define EEPROM_I2C_SDA_PIN GPIO_Pin_7 // 地址 #define EEPROM_ADDRESS 0xA0 // 存储容量（字节） #define EEPROM_SIZE_BYTE 256 // 页面大小（字节） #define EEPROM_PAGE_SIZE_BYTE 8 // 页数 #define EEPROM_PAGE_NUM 32 // I2C应答等待超时时间 #define I2CT_FLAG_TIMEOUT ((uint32_t)0x1000) #define I2CT_LONG_TIMEOUT ((uint32_t)(10 * I2CT_FLAG_TIMEOUT)) // 本机地址 #define I2Cx_OWN_ADDRESS7 0x01 // I2C总线速度(Hz) 快速模式 #define I2C_SPEED 400000 // I2C总线速度(Hz) 标准模式 // #define I2C_SPEED 100000 void EEPROM_Init(void); uint8_t EepromWriteByte(uint8_t WriteAddr, uint8_t Byte); uint8_t EepromWriteHalfWord(uint8_t WriteAddr, uint16_t HalfWord); uint8_t EepromWriteWord(uint8_t WriteAddr, uint32_t Word); uint8_t EepromWrite(uint8_t WriteAddr, uint8_t* pBuffer, uint16_t NumByteToWrite); static uint8_t EepromWritePage(uint8_t WriteAddr, uint8_t* pBuffer, uint16_t NumByteToWrite); static void EepromWaitStandby(void); uint8_t EepromRead(uint8_t ReadAddr, uint8_t* pBuffer, uint16_t NumByteToRead); bsp_eeprom.c #include \"bsp_eeprom.h\" /** * @brief EEPROM初始化 * @param * @retval */ void EEPROM_Init(void){ GPIO_InitTypeDef GPIO_InitStructure; I2C_InitTypeDef I2C_InitStructure; // 使能与 I2C 有关的时钟 EEPROM_I2C_APBxClock_FUN(EEPROM_I2C_CLK, ENABLE); EEPROM_I2C_GPIO_APBxClock_FUN(EEPROM_I2C_GPIO_CLK, ENABLE); // I2C_SCL 开漏输出 GPIO_InitStructure.GPIO_Pin = EEPROM_I2C_SCL_PIN; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_OD; GPIO_Init(EEPROM_I2C_SCL_PORT, \u0026GPIO_InitStructure); // I2C_SDA 开漏输出 GPIO_InitStructure.GPIO_Pin = EEPROM_I2C_SDA_PIN; GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_OD; GPIO_Init(EEPROM_I2C_SDA_PORT, \u0026GPIO_InitStructure); // I2C 配置 I2C_InitStructure.I2C_Mode = I2C_Mode_I2C; // SCL占空比2:1，低电平/高电平，SCL为高电平的时读SDA数据 I2C_InitStructure.I2C_DutyCycle = I2C_DutyCycle_2; // 本机地址 I2C_InitStructure.I2C_OwnAddress1 =I2Cx_OWN_ADDRESS7; // ACK应答使能 I2C_InitStructure.I2C_Ack = I2C_Ack_Enable ; // 7位寻址模式 I2C_InitStructure.I2C_AcknowledgedAddress = I2C_AcknowledgedAddress_7bit; // 通信速率，不能大于400KHz I2C_InitStructure.I2C_ClockSpeed = I2C_SPEED; // I2C初始化 I2C_Init(EEPROM_I2Cx, \u0026I2C_InitStructure); // 使能I2C I2C_Cmd(EEPROM_I2Cx, ENABLE); // 使能应答 I2C_AcknowledgeConfig(EEPROM_I2Cx, ENABLE); } /** * @brief EEPROM 写单个字节 * @param * @arg WriteAddr * @arg Byte * @retval 成功返回0，失败\u003e0 */ uint8_t EepromWriteByte(uint8_t WriteAddr,uint8_t Byte){ return EepromWrite(WriteAddr, \u0026Byte, 1); } /** * @brief EEPROM 写半字，小端存储 * @param * @arg WriteAddr * @arg HalfWord * @retval 成功返回0，失败\u003e0 */ uint8_t EepromWriteHalfWord(uint8_t WriteAddr, uint16_t HalfWord){ return EepromWrite(WriteAddr, (uint8_t*)\u0026HalfWord, 2); } /** * @brief EEPROM 写字，小端存储 * @param * @arg WriteAddr * @arg Word * @retval 成功返回0，失败\u003e0 */ uint8_t EepromWriteWord(uint8_t WriteAddr, uint32_t Word){ return EepromWrite(WriteAddr, (uint8_t*)\u0026Word, 4); } /** * @brief EEPROM 写入指定个数的字节 * @param * @arg WriteAddr: EEPROM内部写地址 * @arg pBuffer:缓冲区指针 * @arg NumByteToWrite:字节数 * @retval 成功返回0，失败\u003e0 */ uint8_t EepromWrite(uint8_t WriteAddr, uint8_t* pBuffer, uint16_t NumByteToWrite){ uint8_t WriteLen, PageOffset, errno; while(NumByteToWrite \u003e 0){ // 计算当前页能写入的字节数, 24C02不能跨页写(页面大小8字节) PageOffset = EEPROM_PAGE_SIZE_BYTE - (WriteAddr % EEPROM_PAGE_SIZE_BYTE); WriteLen = NumByteToWrite \u003e PageOffset ? PageOffset : NumByteToWrite; // 写入一页 errno = EepromWritePage(WriteAddr, pBuffer, WriteLen); if(errno != 0){ return errno; } NumByteToWrite = NumByteToWrite - WriteLen; // 剩余要写入的字节数大于0 if(NumByteToWrite \u003e 0){ pBuffer += WriteLen; WriteAddr += WriteLen; } } return 0; } /** * @brief 等待 EEPROM 芯片就绪 * @param * @retval */ static void EepromWaitStandby(void){ __IO uint16_t SR1_Tmp = 0; do{ // 发送起始信号 I2C_GenerateSTART(EEPROM_I2Cx, ENABLE); // 读 I2C1 SR1 寄存器 SR1_Tmp = I2C_ReadRegister(EEPROM_I2Cx, I2C_Register_SR1); // 发送EEPROM地址+写方向 I2C_Send7bitAddress(EEPROM_I2Cx, EEPROM_ADDRESS, I2C_Direction_Transmitter); // 当I2C设备响应了地址的时候，ADDR会置1 }while(!(I2C_ReadRegister(EEPROM_I2Cx, I2C_Register_SR1) \u0026 0x0002)); // 清除AF标志 I2C_ClearFlag(EEPROM_I2Cx, I2C_FLAG_AF); // 发送停止信号 I2C_GenerateSTOP(EEPROM_I2Cx, ENABLE); } /** * @brief 页写 * @brief AT24C02每页有8个字节, 且不能跨页写入 * @param * @arg WriteAddr:写地址 * @arg pBuffer:缓冲区指针 * @arg NumByteToWrite:字节数 * @retval 正常返回0，异常返回\u003e0 */ static uint8_t EepromWritePage(uint8_t WriteAddr, uint8_t* pBuffer, uint16_t NumByteToWrite){ __IO uint32_t I2CTimeout = I2CT_LONG_TIMEOUT; // 等待总线空闲 while(I2C_GetFlagStatus(EEPROM_I2Cx, I2C_FLAG_BUSY)){ if((I2CTimeout--) == 0) return 1; } // 发送起始信号 I2C_GenerateSTART(EEPROM_I2Cx, ENABLE); I2CTimeout = I2CT_FLAG_TIMEOUT; while(!I2C_CheckEvent(EEPROM_I2Cx, I2C_EVENT_MASTER_MODE_SELECT)){ if((I2CTimeout--) == 0) return 2; } // 发送EEPROM地址+写方向 I2C_Send7bitAddress(EEPROM_I2Cx, EEPROM_ADDRESS, I2C_Direction_Transmitter); I2CTimeout = I2CT_FLAG_TIMEOUT; while(!I2C_CheckEvent(EEPROM_I2Cx, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED)){ if((I2CTimeout--) == 0) return 3; } // 发送EEPROM内部要写入的起始地址 I2C_SendData(EEPROM_I2Cx, WriteAddr); I2CTimeout = I2CT_FLAG_TIMEOUT; while(!I2C_CheckEvent(EEPROM_I2Cx, I2C_EVENT_MASTER_BYTE_TRANSMITTED)){ if((I2CTimeout--) == 0) return 4; } // 发送数据 while(NumByteToWrite--) { // 发送一个字节 I2C_SendData(EEPROM_I2Cx, *pBuffer++); I2CTimeout = I2CT_FLAG_TIMEOUT; while (!I2C_CheckEvent(EEPROM_I2Cx, I2C_EVENT_MASTER_BYTE_TRANSMITTED)){ if((I2CTimeout--) == 0) return 5; } } // 发送停止信号 I2C_GenerateSTOP(EEPROM_I2Cx, ENABLE); // 等待芯片页写完成 EepromWaitStandby(); return 0; } /** * @brief 读取指定个数的字节到pBuffer * @param * @arg ReadAddr:接收数据的EEPROM的地址 * @arg pBuffer:存放从EEPROM读取的数据的缓冲区指针 * @arg NumByteToRead:要从EEPROM读取的字节数 * @retval 正常返回0，异常返回\u003e0 */ uint8_t EepromRead(uint8_t ReadAddr, uint8_t* pBuffer, uint16_t NumByteToRead){ __IO uint32_t I2CTimeout = I2CT_LONG_TIMEOUT; // 等待总线空闲 while(I2C_GetFlagStatus(EEPROM_I2Cx, I2C_FLAG_BUSY)){ if((I2CTimeout--) == 0) return 6; } // 产生I2C起始信号 I2C_GenerateSTART(EEPROM_I2Cx, ENABLE); I2CTimeout = I2CT_FLAG_TIMEOUT; while(!I2C_CheckEvent(EEPROM_I2Cx, I2C_EVENT_MASTER_MODE_SELECT)){ if ((I2CTimeout--) == 0) return 7; } // 发送EEPROM地址+写方向 I2C_Send7bitAddress(EEPROM_I2Cx, EEPROM_ADDRESS,I2C_Direction_Transmitter); I2CTimeout = I2CT_FLAG_TIMEOUT; while (!I2C_CheckEvent(EEPROM_I2Cx, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED)){ if ((I2CTimeout--) == 0) return 8; } // 通过重新设置PE位清除EV6事件 I2C_Cmd(EEPROM_I2Cx, ENABLE); // 发送要读取的EEPROM内部地址 I2C_SendData(EEPROM_I2Cx, ReadAddr); I2CTimeout = I2CT_FLAG_TIMEOUT; while (!I2C_CheckEvent(EEPROM_I2Cx,I2C_EVENT_MASTER_BYTE_TRANSMITTED)){ if ((I2CTimeout--) == 0) return 9; } // 产生第二次I2C起始信号 I2C_GenerateSTART(EEPROM_I2Cx, ENABLE); I2CTimeout = I2CT_FLAG_TIMEOUT; while(!I2C_CheckEvent(EEPROM_I2Cx, I2C_EVENT_MASTER_MODE_SELECT)){ if ((I2CTimeout--) == 0) return 10; } // 发送EEPROM设备地址+读方向 I2C_Send7bitAddress(EEPROM_I2Cx, EEPROM_ADDRESS, I2C_Direction_Receiver); I2CTimeout = I2CT_FLAG_TIMEOUT; while(!I2C_CheckEvent(EEPROM_I2Cx, I2C_EVENT_MASTER_RECEIVER_MODE_SELECTED)){ if ((I2CTimeout--) == 0) return 11; } do{ // 若是最后一个数据，发送非应答信号，结束传输 if (NumByteToRead-- == 1){ // 发送非应答信号 I2C_AcknowledgeConfig(EEPROM_I2Cx, DISABLE); // 发送停止信号 I2C_GenerateSTOP(EEPROM_I2Cx, ENABLE); } I2CTimeout = I2CT_LONG_TIMEOUT; while(!I2C_CheckEvent(EEPROM_I2Cx, I2C_EVENT_MASTER_BYTE_RECEIVED)){ if((I2CTimeout--) == 0) return 12; } // 读取一个字节 *pBuffer++ = I2C_ReceiveData(EEPROM_I2Cx); }while(NumByteToRead); // 使能应答，方便下一次I2C传输 I2C_AcknowledgeConfig(EEPROM_I2Cx, ENABLE); return 0; } ","wordCount":"849","inLanguage":"en","datePublished":"2022-08-24T00:00:00Z","dateModified":"2022-08-24T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://kingtuo123.com/posts/stm32-i2c/"},"publisher":{"@type":"Organization","name":"Notes","logo":{"@type":"ImageObject","url":"https://kingtuo123.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kingtuo123.com/ accesskey=h title="Notes (Alt + H)">Notes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kingtuo123.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://kingtuo123.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://kingtuo123.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://kingtuo123.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>STM32 I2C</h1><div class=post-meta><span title='2022-08-24 00:00:00 +0000 UTC'>August 24, 2022</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e7%bb%93%e6%9e%84 aria-label=基本结构>基本结构</a><ul><li><a href=#%e8%b5%b7%e5%a7%8b%e5%92%8c%e5%81%9c%e6%ad%a2%e4%bf%a1%e5%8f%b7 aria-label=起始和停止信号>起始和停止信号</a></li><li><a href=#%e6%95%b0%e6%8d%ae%e6%9c%89%e6%95%88%e6%80%a7 aria-label=数据有效性>数据有效性</a></li><li><a href=#7-%e4%bd%8d%e5%9c%b0%e5%9d%80 aria-label="7 位地址">7 位地址</a></li><li><a href=#10-%e4%bd%8d%e5%9c%b0%e5%9d%80 aria-label="10 位地址">10 位地址</a></li><li><a href=#%e5%93%8d%e5%ba%94 aria-label=响应>响应</a></li><li><a href=#%e9%87%8d%e5%a4%8d%e8%b5%b7%e5%a7%8b%e4%bf%a1%e5%8f%b7 aria-label=重复起始信号>重复起始信号</a></li><li><a href=#%e6%97%b6%e9%92%9f%e5%bb%b6%e5%b1%95 aria-label=时钟延展>时钟延展</a></li></ul></li><li><a href=#stm32-i2c-%e6%94%b6%e5%8f%91%e4%ba%8b%e4%bb%b6 aria-label="STM32 I2C 收发事件">STM32 I2C 收发事件</a><ul><li><a href=#%e4%b8%bb%e6%9c%ba%e5%8f%91%e9%80%81%e5%ba%8f%e5%88%97 aria-label=主机发送序列>主机发送序列</a></li><li><a href=#%e4%b8%bb%e6%9c%ba%e6%8e%a5%e6%94%b6%e5%ba%8f%e5%88%97 aria-label=主机接收序列>主机接收序列</a></li></ul></li><li><a href=#%e5%af%84%e5%ad%98%e5%99%a8 aria-label=寄存器>寄存器</a></li><li><a href=#eeprom-i2c-%e9%a9%b1%e5%8a%a8%e6%a0%87%e5%87%86%e5%ba%93 aria-label="EEPROM I2C 驱动（标准库）">EEPROM I2C 驱动（标准库）</a><ul><li><a href=#bsp_eepromh aria-label=bsp_eeprom.h>bsp_eeprom.h</a></li><li><a href=#bsp_eepromc aria-label=bsp_eeprom.c>bsp_eeprom.c</a></li></ul></li></ul></div></details></div><div class=post-content><p>参考文章</p><ul><li><a href=https://learn.sparkfun.com/tutorials/i2c/all>I2C</a></li><li><a href=https://blog.csdn.net/u011471873/article/details/85014124>I2C 时钟延展</a></li></ul><div align=left><img src=i2c.png style=max-height:850px></img></div><h2 id=基本结构>基本结构<a hidden class=anchor aria-hidden=true href=#基本结构>#</a></h2><div align=center><img src=1.jpg style=max-height:500px></img></div><h3 id=起始和停止信号>起始和停止信号<a hidden class=anchor aria-hidden=true href=#起始和停止信号>#</a></h3><p>当 SCL 是高电平时 SDA 线从高电平向低电平切换，表示通讯的起始。（下降沿触发）</p><p>当 SCL 是高电平时 SDA 线由低电平向高电平切换，表示通讯的停止。（上升沿触发）</p><h3 id=数据有效性>数据有效性<a hidden class=anchor aria-hidden=true href=#数据有效性>#</a></h3><p>SCL 为高电平的时候 SDA 表示的数据有效</p><h3 id=7-位地址>7 位地址<a hidden class=anchor aria-hidden=true href=#7-位地址>#</a></h3><p>如<a href=#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84>上图</a>所示，通常地址高 4 位 <code>A6-A3</code> 表示器件类型，存储类芯片一般是 <code>1010b</code> ，这是由半导体厂家固定的。</p><p>低 3 位 <code>A2-A0</code> 表示器件地址，一般由器件的引脚电路决定。</p><p><code>R/W</code> 位指示这是读取 (1) 还是写入 (0) 操作的 。</p><h3 id=10-位地址>10 位地址<a hidden class=anchor aria-hidden=true href=#10-位地址>#</a></h3><div align=center><img src=2.jpg style=max-height:500px></img></div><p>10 位的地址分为两帧发送。</p><ul><li>第一帧，<code>0b 11110</code> 表示使用 10 位的地址。A9、A8 是地址的高 2 位。</li><li>第二帧，A7-A0 是地址的后 8 位。</li><li>第三帧，普通的数据帧。</li></ul><h3 id=响应>响应<a hidden class=anchor aria-hidden=true href=#响应>#</a></h3><p>响应包括 <strong>“应答 (ACK)”</strong> 和 <strong>“非应答 (NACK)”</strong> 两种信号。</p><ul><li>ACK：继续发送</li><li>NACK：结束发送</li></ul><h3 id=重复起始信号>重复起始信号<a hidden class=anchor aria-hidden=true href=#重复起始信号>#</a></h3><p>I2C 通讯更常用的是复合格式，例如：第一次通讯是告诉从机读写地址，第二次则是读写的实际内容。</p><p>重复起始信号如下：</p><div align=left><img src=3.jpg style=max-height:400px></img></div><h3 id=时钟延展>时钟延展<a hidden class=anchor aria-hidden=true href=#时钟延展>#</a></h3><p>在 I2C 的主从通信过程中，总线上的 SCL 时钟总是由主机来产生和控制的，但如果从机跟不上主机的速率，I2C 协议规定从机是可以通过将 SCL 时钟线拉低来暂停一下传输，直到从机释放掉SCL线，传输继续进行。</p><div align=left><img src=4.jpg style=max-height:400px></img></div><p>总的来说，clock stretching 其实是一种降频的手段，使得更高频率的主机也能适应低频率从机的通信。</p><h2 id=stm32-i2c-收发事件>STM32 I2C 收发事件<a hidden class=anchor aria-hidden=true href=#stm32-i2c-收发事件>#</a></h2><h3 id=主机发送序列>主机发送序列<a hidden class=anchor aria-hidden=true href=#主机发送序列>#</a></h3><div align=center><img src=5.png style=max-height:1000px></img></div><h3 id=主机接收序列>主机接收序列<a hidden class=anchor aria-hidden=true href=#主机接收序列>#</a></h3><div align=center><img src=6.png style=max-height:1000px></img></div><h2 id=寄存器>寄存器<a hidden class=anchor aria-hidden=true href=#寄存器>#</a></h2><ul><li>控制寄存器 1（I2C CR1）</li><li>控制寄存器 2（I2C_CR2）</li><li>自身地址寄存器 1（I2C_OAR1）</li><li>自身地址寄存器 2（I2C_OAR2）</li><li>数据寄存器（I2C_DR）</li><li>状态寄存器 1（I2C_SR1）</li><li>状态寄存器 2 （I2C_SR2）</li><li>时钟控制寄存器（I2C_CCR）</li><li>TRISE寄存器（I2C_TRISE）</li></ul><div align=center><img src=1.png style=max-height:1000px></img></div><h2 id=eeprom-i2c-驱动标准库>EEPROM I2C 驱动（标准库）<a hidden class=anchor aria-hidden=true href=#eeprom-i2c-驱动标准库>#</a></h2><ul><li>单片机：STM32F103ZET6</li><li>EEPROM：AT24C02</li><li>使用硬件 I2C 驱动</li></ul><h3 id=bsp_eepromh>bsp_eeprom.h<a hidden class=anchor aria-hidden=true href=#bsp_eepromh>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#ifndef __BSP_EEPROM_H
</span></span></span><span class=line><span class=cl><span class=cp>#define __BSP_EEPROM_H
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;stm32f10x.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define EEPROM_I2Cx                      I2C1
</span></span></span><span class=line><span class=cl><span class=cp>#define EEPROM_I2C_APBxClock_FUN         RCC_APB1PeriphClockCmd
</span></span></span><span class=line><span class=cl><span class=cp>#define EEPROM_I2C_CLK                   RCC_APB1Periph_I2C1
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define EEPROM_I2C_GPIO_APBxClock_FUN    RCC_APB2PeriphClockCmd
</span></span></span><span class=line><span class=cl><span class=cp>#define EEPROM_I2C_GPIO_CLK              RCC_APB2Periph_GPIOB
</span></span></span><span class=line><span class=cl><span class=cp>#define EEPROM_I2C_SCL_PORT              GPIOB
</span></span></span><span class=line><span class=cl><span class=cp>#define EEPROM_I2C_SCL_PIN               GPIO_Pin_6
</span></span></span><span class=line><span class=cl><span class=cp>#define EEPROM_I2C_SDA_PORT              GPIOB
</span></span></span><span class=line><span class=cl><span class=cp>#define EEPROM_I2C_SDA_PIN               GPIO_Pin_7
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 地址
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define EEPROM_ADDRESS              0xA0
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 存储容量（字节）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define EEPROM_SIZE_BYTE            256
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 页面大小（字节）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define EEPROM_PAGE_SIZE_BYTE       8
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 页数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define EEPROM_PAGE_NUM             32
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// I2C应答等待超时时间
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define I2CT_FLAG_TIMEOUT           ((uint32_t)0x1000)
</span></span></span><span class=line><span class=cl><span class=cp>#define I2CT_LONG_TIMEOUT           ((uint32_t)(10 * I2CT_FLAG_TIMEOUT))
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 本机地址
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define I2Cx_OWN_ADDRESS7           0x01
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// I2C总线速度(Hz) 快速模式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define I2C_SPEED                   400000
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// I2C总线速度(Hz) 标准模式
</span></span></span><span class=line><span class=cl><span class=c1>// #define I2C_SPEED                100000
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>EEPROM_Init</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span> <span class=nf>EepromWriteByte</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>WriteAddr</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=n>Byte</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span> <span class=nf>EepromWriteHalfWord</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>WriteAddr</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>HalfWord</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span> <span class=nf>EepromWriteWord</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>WriteAddr</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>Word</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span> <span class=nf>EepromWrite</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>WriteAddr</span><span class=p>,</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>pBuffer</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>NumByteToWrite</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>uint8_t</span> <span class=nf>EepromWritePage</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>WriteAddr</span><span class=p>,</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>pBuffer</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>NumByteToWrite</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>EepromWaitStandby</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span> <span class=nf>EepromRead</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>ReadAddr</span><span class=p>,</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>pBuffer</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>NumByteToRead</span><span class=p>);</span>
</span></span></code></pre></div><h3 id=bsp_eepromc>bsp_eeprom.c<a hidden class=anchor aria-hidden=true href=#bsp_eepromc>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;bsp_eeprom.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief  EEPROM初始化
</span></span></span><span class=line><span class=cl><span class=cm> * @param
</span></span></span><span class=line><span class=cl><span class=cm> * @retval
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>EEPROM_Init</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitTypeDef</span> <span class=n>GPIO_InitStructure</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>I2C_InitTypeDef</span> <span class=n>I2C_InitStructure</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使能与 I2C 有关的时钟
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>EEPROM_I2C_APBxClock_FUN</span><span class=p>(</span><span class=n>EEPROM_I2C_CLK</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>EEPROM_I2C_GPIO_APBxClock_FUN</span><span class=p>(</span><span class=n>EEPROM_I2C_GPIO_CLK</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// I2C_SCL 开漏输出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Pin</span>   <span class=o>=</span> <span class=n>EEPROM_I2C_SCL_PIN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Speed</span> <span class=o>=</span> <span class=n>GPIO_Speed_50MHz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Mode</span>  <span class=o>=</span> <span class=n>GPIO_Mode_AF_OD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>GPIO_Init</span><span class=p>(</span><span class=n>EEPROM_I2C_SCL_PORT</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>GPIO_InitStructure</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// I2C_SDA 开漏输出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Pin</span>   <span class=o>=</span> <span class=n>EEPROM_I2C_SDA_PIN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Speed</span> <span class=o>=</span> <span class=n>GPIO_Speed_50MHz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Mode</span>  <span class=o>=</span> <span class=n>GPIO_Mode_AF_OD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>GPIO_Init</span><span class=p>(</span><span class=n>EEPROM_I2C_SDA_PORT</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>GPIO_InitStructure</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// I2C 配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>I2C_InitStructure</span><span class=p>.</span><span class=n>I2C_Mode</span> <span class=o>=</span> <span class=n>I2C_Mode_I2C</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// SCL占空比2:1，低电平/高电平，SCL为高电平的时读SDA数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>I2C_InitStructure</span><span class=p>.</span><span class=n>I2C_DutyCycle</span> <span class=o>=</span> <span class=n>I2C_DutyCycle_2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 本机地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>I2C_InitStructure</span><span class=p>.</span><span class=n>I2C_OwnAddress1</span> <span class=o>=</span><span class=n>I2Cx_OWN_ADDRESS7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ACK应答使能
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>I2C_InitStructure</span><span class=p>.</span><span class=n>I2C_Ack</span> <span class=o>=</span> <span class=n>I2C_Ack_Enable</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 7位寻址模式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>I2C_InitStructure</span><span class=p>.</span><span class=n>I2C_AcknowledgedAddress</span> <span class=o>=</span> <span class=n>I2C_AcknowledgedAddress_7bit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通信速率，不能大于400KHz
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>I2C_InitStructure</span><span class=p>.</span><span class=n>I2C_ClockSpeed</span> <span class=o>=</span> <span class=n>I2C_SPEED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// I2C初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_Init</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>I2C_InitStructure</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使能I2C
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_Cmd</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使能应答
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_AcknowledgeConfig</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief  EEPROM 写单个字节
</span></span></span><span class=line><span class=cl><span class=cm> * @param
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  WriteAddr
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  Byte
</span></span></span><span class=line><span class=cl><span class=cm> * @retval 成功返回0，失败&gt;0
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span>
</span></span><span class=line><span class=cl><span class=nf>EepromWriteByte</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>WriteAddr</span><span class=p>,</span><span class=kt>uint8_t</span> <span class=n>Byte</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>EepromWrite</span><span class=p>(</span><span class=n>WriteAddr</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>Byte</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief  EEPROM 写半字，小端存储
</span></span></span><span class=line><span class=cl><span class=cm> * @param
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  WriteAddr
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  HalfWord
</span></span></span><span class=line><span class=cl><span class=cm> * @retval 成功返回0，失败&gt;0
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span>
</span></span><span class=line><span class=cl><span class=nf>EepromWriteHalfWord</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>WriteAddr</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>HalfWord</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>EepromWrite</span><span class=p>(</span><span class=n>WriteAddr</span><span class=p>,</span> <span class=p>(</span><span class=kt>uint8_t</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>HalfWord</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief  EEPROM 写字，小端存储
</span></span></span><span class=line><span class=cl><span class=cm> * @param
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  WriteAddr
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  Word
</span></span></span><span class=line><span class=cl><span class=cm> * @retval 成功返回0，失败&gt;0
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span>
</span></span><span class=line><span class=cl><span class=nf>EepromWriteWord</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>WriteAddr</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>Word</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>EepromWrite</span><span class=p>(</span><span class=n>WriteAddr</span><span class=p>,</span> <span class=p>(</span><span class=kt>uint8_t</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>Word</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief  EEPROM 写入指定个数的字节
</span></span></span><span class=line><span class=cl><span class=cm> * @param
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  WriteAddr: EEPROM内部写地址
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  pBuffer:缓冲区指针
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  NumByteToWrite:字节数
</span></span></span><span class=line><span class=cl><span class=cm> * @retval 成功返回0，失败&gt;0
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span>
</span></span><span class=line><span class=cl><span class=nf>EepromWrite</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>WriteAddr</span><span class=p>,</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>pBuffer</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>NumByteToWrite</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>WriteLen</span><span class=p>,</span> <span class=n>PageOffset</span><span class=p>,</span> <span class=n>errno</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=n>NumByteToWrite</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 计算当前页能写入的字节数, 24C02不能跨页写(页面大小8字节)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>PageOffset</span> <span class=o>=</span> <span class=n>EEPROM_PAGE_SIZE_BYTE</span> <span class=o>-</span> <span class=p>(</span><span class=n>WriteAddr</span> <span class=o>%</span> <span class=n>EEPROM_PAGE_SIZE_BYTE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>WriteLen</span>   <span class=o>=</span> <span class=n>NumByteToWrite</span> <span class=o>&gt;</span> <span class=n>PageOffset</span> <span class=o>?</span> <span class=nl>PageOffset</span> <span class=p>:</span> <span class=n>NumByteToWrite</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 写入一页
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>errno</span> <span class=o>=</span> <span class=nf>EepromWritePage</span><span class=p>(</span><span class=n>WriteAddr</span><span class=p>,</span> <span class=n>pBuffer</span><span class=p>,</span> <span class=n>WriteLen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>errno</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>errno</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>NumByteToWrite</span> <span class=o>=</span> <span class=n>NumByteToWrite</span> <span class=o>-</span> <span class=n>WriteLen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 剩余要写入的字节数大于0
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span><span class=p>(</span><span class=n>NumByteToWrite</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=n>pBuffer</span>   <span class=o>+=</span> <span class=n>WriteLen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>WriteAddr</span> <span class=o>+=</span> <span class=n>WriteLen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief  等待 EEPROM 芯片就绪
</span></span></span><span class=line><span class=cl><span class=cm> * @param
</span></span></span><span class=line><span class=cl><span class=cm> * @retval
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>EepromWaitStandby</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>__IO</span> <span class=kt>uint16_t</span> <span class=n>SR1_Tmp</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 发送起始信号
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>I2C_GenerateSTART</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 读 I2C1 SR1 寄存器
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SR1_Tmp</span> <span class=o>=</span> <span class=nf>I2C_ReadRegister</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_Register_SR1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 发送EEPROM地址+写方向
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>I2C_Send7bitAddress</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>EEPROM_ADDRESS</span><span class=p>,</span> <span class=n>I2C_Direction_Transmitter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 当I2C设备响应了地址的时候，ADDR会置1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span><span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nf>I2C_ReadRegister</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_Register_SR1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x0002</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 清除AF标志
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_ClearFlag</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_FLAG_AF</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送停止信号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_GenerateSTOP</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief   页写
</span></span></span><span class=line><span class=cl><span class=cm> * @brief   AT24C02每页有8个字节, 且不能跨页写入
</span></span></span><span class=line><span class=cl><span class=cm> * @param
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg   WriteAddr:写地址
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg   pBuffer:缓冲区指针
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg   NumByteToWrite:字节数
</span></span></span><span class=line><span class=cl><span class=cm> * @retval  正常返回0，异常返回&gt;0
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>uint8_t</span>
</span></span><span class=line><span class=cl><span class=nf>EepromWritePage</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>WriteAddr</span><span class=p>,</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>pBuffer</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>NumByteToWrite</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>__IO</span> <span class=kt>uint32_t</span> <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_LONG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 等待总线空闲
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span><span class=p>(</span><span class=nf>I2C_GetFlagStatus</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_FLAG_BUSY</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送起始信号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_GenerateSTART</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_FLAG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=nf>I2C_CheckEvent</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_EVENT_MASTER_MODE_SELECT</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送EEPROM地址+写方向
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_Send7bitAddress</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>EEPROM_ADDRESS</span><span class=p>,</span> <span class=n>I2C_Direction_Transmitter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_FLAG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=nf>I2C_CheckEvent</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送EEPROM内部要写入的起始地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_SendData</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>WriteAddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_FLAG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=nf>I2C_CheckEvent</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_EVENT_MASTER_BYTE_TRANSMITTED</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span><span class=p>(</span><span class=n>NumByteToWrite</span><span class=o>--</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 发送一个字节
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>I2C_SendData</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=o>*</span><span class=n>pBuffer</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_FLAG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=nf>I2C_CheckEvent</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_EVENT_MASTER_BYTE_TRANSMITTED</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送停止信号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_GenerateSTOP</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 等待芯片页写完成
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>EepromWaitStandby</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief  读取指定个数的字节到pBuffer
</span></span></span><span class=line><span class=cl><span class=cm> * @param
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  ReadAddr:接收数据的EEPROM的地址
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  pBuffer:存放从EEPROM读取的数据的缓冲区指针
</span></span></span><span class=line><span class=cl><span class=cm> *   @arg  NumByteToRead:要从EEPROM读取的字节数
</span></span></span><span class=line><span class=cl><span class=cm> * @retval 正常返回0，异常返回&gt;0
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span> <span class=nf>EepromRead</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=n>ReadAddr</span><span class=p>,</span> <span class=kt>uint8_t</span><span class=o>*</span> <span class=n>pBuffer</span><span class=p>,</span> <span class=kt>uint16_t</span> <span class=n>NumByteToRead</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=n>__IO</span> <span class=kt>uint32_t</span> <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_LONG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 等待总线空闲
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span><span class=p>(</span><span class=nf>I2C_GetFlagStatus</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_FLAG_BUSY</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 产生I2C起始信号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_GenerateSTART</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_FLAG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=nf>I2C_CheckEvent</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_EVENT_MASTER_MODE_SELECT</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送EEPROM地址+写方向
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_Send7bitAddress</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>EEPROM_ADDRESS</span><span class=p>,</span><span class=n>I2C_Direction_Transmitter</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_FLAG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=nf>I2C_CheckEvent</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过重新设置PE位清除EV6事件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_Cmd</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送要读取的EEPROM内部地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_SendData</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ReadAddr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_FLAG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=nf>I2C_CheckEvent</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span><span class=n>I2C_EVENT_MASTER_BYTE_TRANSMITTED</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 产生第二次I2C起始信号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_GenerateSTART</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_FLAG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=nf>I2C_CheckEvent</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_EVENT_MASTER_MODE_SELECT</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发送EEPROM设备地址+读方向
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_Send7bitAddress</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>EEPROM_ADDRESS</span><span class=p>,</span> <span class=n>I2C_Direction_Receiver</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_FLAG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=nf>I2C_CheckEvent</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_EVENT_MASTER_RECEIVER_MODE_SELECTED</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>11</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 若是最后一个数据，发送非应答信号，结束传输
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>NumByteToRead</span><span class=o>--</span> <span class=o>==</span> <span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 发送非应答信号
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>I2C_AcknowledgeConfig</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>DISABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 发送停止信号
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>I2C_GenerateSTOP</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>I2CTimeout</span> <span class=o>=</span> <span class=n>I2CT_LONG_TIMEOUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=nf>I2C_CheckEvent</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>I2C_EVENT_MASTER_BYTE_RECEIVED</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>((</span><span class=n>I2CTimeout</span><span class=o>--</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=mi>12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 读取一个字节
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>*</span><span class=n>pBuffer</span><span class=o>++</span> <span class=o>=</span> <span class=nf>I2C_ReceiveData</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=k>while</span><span class=p>(</span><span class=n>NumByteToRead</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使能应答，方便下一次I2C传输
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>I2C_AcknowledgeConfig</span><span class=p>(</span><span class=n>EEPROM_I2Cx</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://kingtuo123.com/tags/stm32/>stm32</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://kingtuo123.com/>Notes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><div class=footer align=center style=margin-top:-30px><a href=https://beian.miit.gov.cn/ target=_blank>浙ICP备19041170号</a></div><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>