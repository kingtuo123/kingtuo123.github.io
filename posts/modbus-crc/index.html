<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Modbus 协议 CRC 校验 | Notes</title>
<meta name=keywords content="Modbus,CRC"><meta name=description content="CRC 校验原理"><meta name=author content><link rel=canonical href=https://kingtuo123.com/posts/modbus-crc/><link crossorigin=anonymous href=/assets/css/stylesheet.1266783bb343294b3a3127b8780bf5316f6140994fb515814e78f4d77423929e.css integrity="sha256-EmZ4O7NDKUs6MSe4eAv1MW9hQJlPtRWBTnj013Qjkp4=" rel="preload stylesheet" as=style><link rel=icon href=https://kingtuo123.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kingtuo123.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kingtuo123.com/favicon-32x32.png><link rel=apple-touch-icon href=https://kingtuo123.com/apple-touch-icon.png><link rel=mask-icon href=https://kingtuo123.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Modbus 协议 CRC 校验"><meta property="og:description" content="CRC 校验原理"><meta property="og:type" content="article"><meta property="og:url" content="https://kingtuo123.com/posts/modbus-crc/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-24T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-24T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Modbus 协议 CRC 校验"><meta name=twitter:description content="CRC 校验原理"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kingtuo123.com/posts/"},{"@type":"ListItem","position":2,"name":"Modbus 协议 CRC 校验","item":"https://kingtuo123.com/posts/modbus-crc/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Modbus 协议 CRC 校验","name":"Modbus 协议 CRC 校验","description":"CRC 校验原理","keywords":["Modbus","CRC"],"articleBody":"什么是CRC 循环冗余校验码 ( cyclie redundancy check ) 简称CRC（循环码）。\nCRC算法原理 假如有数据A：1011 1001\n以 CRC-4 为例计算该数据的 CRC 码，它的多项式公式 g(x) = x⁴ + x + 1 , 用二进制表示为 10011\n计算它的 CRC 码（冗余位）： CRC-4 表示所得 CRC 码为 4 位，在数据 A 右侧补上 4 个 0，数据 A：1011 1001 0000 数据A做被除数，用除数 10011 做模2除法，如下图 关于模2除法： 本质是异或运算 舍去最左侧 0，以 1 对齐 最后结果 1001 就是 CRC 冗余位，将它附加在原数据帧末尾，构建成一个新的数据帧进行发送；最后接收方将整个数据帧以模2除法除相同的除数，如果没有余数，则说明数据帧在传输的过程中没有出错。\nCRC算法参数模型 为了方便机器更好的计算CRC所以制定了一些规则，添加了一些参数参与计算，称为CRC参数模型。如 CRC-8、CRC-16/MODBUS、CRC-32。\n以CRC-16/MODBUS 为例，它的参数模型如下： CRC算法名称 多项式公式 宽度 多项式 初始值 结果异或值 输入反转 输出反转 CRC-4/ITU x⁴ + x + 1 4 03 00 00 true true CRC-16/MODBUS x¹⁶ + x¹⁵ + x² + 1 16 8005 FFFF 0000 true true CRC算法参数模型解释：\nCRC算法名称（NAME）：名称后面的数字就表示生成的冗余位的位数。\n宽度（WIDTH）：CRC 校验宽度，即 CRC 比特数。\n多项式（POLY）：生成项的简写，以16进制表示。例如：CRC-16/MODBUS 即是0x8005，忽略最高位的\"1\"，即完整的生成项是0x18005。\n初始值（INIT）：算法开始时计算（crc）的初始化预置值，一般取值FFFF或0000。当数据前几位为0时，因为模2除法会忽略0，先用FFFF异或将0取反为1，再进行模2除法，使数据开头的0也参与运算，以上是个人理解仅供参考。\n结果异或值（REFIN）：计算结果和该值异或运算。\n输入反转（REFOUT）：输入数据高低位互换，类似镜像。\n输出反转（XOROUT）：计算结果高低位互换，类似镜像。\n为什么可以忽略最高位的\"1\" 以 CRC-4 为例，它的多项式公式 g(x) = x⁴ + x + 1 , 用二进制表示为 10011，多项式用十六进制表示应该是13，为什么参数模型里用 03 表示？\n再来观察上面的式子,看下图左侧，模2除法里除数和被除数左侧以 1 对齐后再异或运算，最左侧1在每次运算后都会被丢弃（因为 1 异或 1 为 0，而模 2 除法会舍去 0），并不会对最终结果产生影响\n我们把除数左侧的 1 去掉，如图右侧所示，可以看出，只要将除数与被除数的第 2 位对齐再异或运算 ，最后结果是一样的，所以除数最高位1可以舍去，13 就可以简写为 03。\n直接计算法 - 正/反向 以CRC-16/MODBUS 参考模型为例编程\n第一步，输入数据反转，只反转单个字节不改变字节顺序，例如 0x0903 反转为 0x90C0\n第二步，定义初始值 FFFF，以除数 8005 进行模 2 运算\n最后，输出数据反转,反转整个CRC寄存器，例如 0x0903 反转为 0xC090\n#include /* 字节反转 */ unsigned char Flip(unsigned char data) { data = ((data\u00260x55)\u003c\u003c1)|((data\u00260xaa)\u003e\u003e1); data = ((data\u00260x33)\u003c\u003c2)|((data\u00260xcc)\u003e\u003e2); data = ((data\u00260x0f)\u003c\u003c4)|((data\u00260xf0)\u003e\u003e4); return data; } /* CRC算法正向 */ unsigned short CRC16( unsigned char * data, unsigned short len) { int i,j; unsigned short CRC = 0xFFFF; /* CRC寄存器，初始化预置值 */ for( i = 0;i \u003c len; i++ ) { CRC ^= (unsigned short)Flip(*data++)\u003c\u003c8; /* 单个字节反转 */ for(j = 0; j\u003c 8; j++) { if(CRC \u0026 0x8000) CRC = CRC \u003c\u003c 1 ^ 0x8005; else CRC \u003c\u003c= 1; } } /* 全反转 */ CRC = (unsigned short)Flip((unsigned char)CRC)\u003c\u003c8|Flip((unsigned char)(CRC\u003e\u003e8)); return CRC; } /* CRC算法反向，比正向效率要高，网上找的算法大多是反向的*/ unsigned short CRC16_Rev( unsigned char * data, unsigned short len) { int i,j; unsigned short CRC = 0xFFFF; for( i = 0;i \u003c len; i++ ) { CRC ^= *data++; for(j = 0; j\u003c 8; j++) { if(CRC \u0026 0x0001) CRC = CRC \u003e\u003e 1 ^ 0xA001; /* 8005反转就是A001 */ else CRC \u003e\u003e= 1; } } return CRC; } int main(void) { unsigned char data[6] = {0x01,0x04,0x00,0x00,0x00,0x01}; printf(\"%x\\n\",CRC16(data,6)); /* 正向 */ printf(\"%x\\n\",CRC16_Rev(data,6)); /* 反向 */ getchar(); return 0; } 这里举一个简单的例子。假设从设备地址为 1,要求读取输人寄存器地址 30001 的值，则 RTU 模式下具体的查询消息帧如下： 0x01，0x04，0x00，0x00，0x00，0x01，0x31，0xCA 其中，0xCA31 即为 CRC 值。因为 Modbus 规定发送时 CRC 必须低字节在前，高字节在后，因此实际的消息帧的发送顺序为 0x31,0xCA。\n查表法 异或运算有结合律：(a^b)^c=a^(b^c)\n大概的原理如下图\n8 位一共有 256 种结果，可以先将结果计算好后存入数组中。按 16 位查表太多有 65536 种结果。所以按 8 位查表是最合适的。\n程序如下 ( CRC 反向算法的表 )\n#include unsigned short crc16_table[] = { 0x0000, 0xc0c1, 0xc181, 0x0140, 0xc301, 0x03c0, 0x0280, 0xc241, 0xc601, 0x06c0, 0x0780, 0xc741, 0x0500, 0xc5c1, 0xc481, 0x0440, 0xcc01, 0x0cc0, 0x0d80, 0xcd41, 0x0f00, 0xcfc1, 0xce81, 0x0e40, 0x0a00, 0xcac1, 0xcb81, 0x0b40, 0xc901, 0x09c0, 0x0880, 0xc841, 0xd801, 0x18c0, 0x1980, 0xd941, 0x1b00, 0xdbc1, 0xda81, 0x1a40, 0x1e00, 0xdec1, 0xdf81, 0x1f40, 0xdd01, 0x1dc0, 0x1c80, 0xdc41, 0x1400, 0xd4c1, 0xd581, 0x1540, 0xd701, 0x17c0, 0x1680, 0xd641, 0xd201, 0x12c0, 0x1380, 0xd341, 0x1100, 0xd1c1, 0xd081, 0x1040, 0xf001, 0x30c0, 0x3180, 0xf141, 0x3300, 0xf3c1, 0xf281, 0x3240, 0x3600, 0xf6c1, 0xf781, 0x3740, 0xf501, 0x35c0, 0x3480, 0xf441, 0x3c00, 0xfcc1, 0xfd81, 0x3d40, 0xff01, 0x3fc0, 0x3e80, 0xfe41, 0xfa01, 0x3ac0, 0x3b80, 0xfb41, 0x3900, 0xf9c1, 0xf881, 0x3840, 0x2800, 0xe8c1, 0xe981, 0x2940, 0xeb01, 0x2bc0, 0x2a80, 0xea41, 0xee01, 0x2ec0, 0x2f80, 0xef41, 0x2d00, 0xedc1, 0xec81, 0x2c40, 0xe401, 0x24c0, 0x2580, 0xe541, 0x2700, 0xe7c1, 0xe681, 0x2640, 0x2200, 0xe2c1, 0xe381, 0x2340, 0xe101, 0x21c0, 0x2080, 0xe041, 0xa001, 0x60c0, 0x6180, 0xa141, 0x6300, 0xa3c1, 0xa281, 0x6240, 0x6600, 0xa6c1, 0xa781, 0x6740, 0xa501, 0x65c0, 0x6480, 0xa441, 0x6c00, 0xacc1, 0xad81, 0x6d40, 0xaf01, 0x6fc0, 0x6e80, 0xae41, 0xaa01, 0x6ac0, 0x6b80, 0xab41, 0x6900, 0xa9c1, 0xa881, 0x6840, 0x7800, 0xb8c1, 0xb981, 0x7940, 0xbb01, 0x7bc0, 0x7a80, 0xba41, 0xbe01, 0x7ec0, 0x7f80, 0xbf41, 0x7d00, 0xbdc1, 0xbc81, 0x7c40, 0xb401, 0x74c0, 0x7580, 0xb541, 0x7700, 0xb7c1, 0xb681, 0x7640, 0x7200, 0xb2c1, 0xb381, 0x7340, 0xb101, 0x71c0, 0x7080, 0xb041, 0x5000, 0x90c1, 0x9181, 0x5140, 0x9301, 0x53c0, 0x5280, 0x9241, 0x9601, 0x56c0, 0x5780, 0x9741, 0x5500, 0x95c1, 0x9481, 0x5440, 0x9c01, 0x5cc0, 0x5d80, 0x9d41, 0x5f00, 0x9fc1, 0x9e81, 0x5e40, 0x5a00, 0x9ac1, 0x9b81, 0x5b40, 0x9901, 0x59c0, 0x5880, 0x9841, 0x8801, 0x48c0, 0x4980, 0x8941, 0x4b00, 0x8bc1, 0x8a81, 0x4a40, 0x4e00, 0x8ec1, 0x8f81, 0x4f40, 0x8d01, 0x4dc0, 0x4c80, 0x8c41, 0x4400, 0x84c1, 0x8581, 0x4540, 0x8701, 0x47c0, 0x4680, 0x8641, 0x8201, 0x42c0, 0x4380, 0x8341, 0x4100, 0x81c1, 0x8081, 0x4040 }; unsigned short CRC16(unsigned char * data, unsigned short len){ unsigned short crc = 0xFFFF; unsigned char index = 0; unsigned char *p = data; while(len--){ index = *p++ ^ crc; crc \u003e\u003e= 8; crc ^= crc16_table[index]; } return crc; } int main(void){ unsigned short crc; unsigned char data[6] = {0x01,0x04,0x00,0x00,0x00,0x01}; crc = CRC16(data,6); printf(\"%x \",crc); getchar(); return 0; } 余项表生成算法 #include /*余项表生成函数*/ void generate_table(unsigned short * crc16_table, unsigned short poly){ unsigned int i,j; unsigned short crc; for(i = 0; i \u003c 256; i++){ crc = i; for(j = 0; j \u003c 8; j++){ if(crc \u0026 0x0001){ crc = (crc \u003e\u003e 1) ^ 0xa001;\t}else{ crc \u003e\u003e= 1; } } crc16_table[i] = crc; } } /*打印表*/ void print_table(unsigned short * crc16_table){ unsigned int i; printf(\"unsigned short crc16_table[] = {\\n \"); for(i = 0; i \u003c 256; i++){ printf(\"0x%04x, \",crc16_table[i]); if(i == 255) printf(\"\\b\\b \"); if(!((i+1)%8)) printf(\"\\n \"); } printf(\"\\b\\b\\b\\b};\\n\"); } int main(void) { unsigned short crc16_table[256]; unsigned short poly = 0xA001; generate_table(crc16_table,poly); print_table(crc16_table); getchar(); return 0; } ","wordCount":"803","inLanguage":"en","datePublished":"2022-08-24T00:00:00Z","dateModified":"2022-08-24T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://kingtuo123.com/posts/modbus-crc/"},"publisher":{"@type":"Organization","name":"Notes","logo":{"@type":"ImageObject","url":"https://kingtuo123.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kingtuo123.com/ accesskey=h title="Notes (Alt + H)">Notes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kingtuo123.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://kingtuo123.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://kingtuo123.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://kingtuo123.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Modbus 协议 CRC 校验</h1><div class=post-meta><span title='2022-08-24 00:00:00 +0000 UTC'>August 24, 2022</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%afcrc aria-label=什么是CRC>什么是CRC</a></li><li><a href=#crc%e7%ae%97%e6%b3%95%e5%8e%9f%e7%90%86 aria-label=CRC算法原理>CRC算法原理</a></li><li><a href=#crc%e7%ae%97%e6%b3%95%e5%8f%82%e6%95%b0%e6%a8%a1%e5%9e%8b aria-label=CRC算法参数模型>CRC算法参数模型</a></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%8f%af%e4%bb%a5%e5%bf%bd%e7%95%a5%e6%9c%80%e9%ab%98%e4%bd%8d%e7%9a%841 aria-label=为什么可以忽略最高位的&amp;quot;1&amp;quot;>为什么可以忽略最高位的"1"</a></li><li><a href=#%e7%9b%b4%e6%8e%a5%e8%ae%a1%e7%ae%97%e6%b3%95---%e6%ad%a3%e5%8f%8d%e5%90%91 aria-label="直接计算法 - 正/反向">直接计算法 - 正/反向</a></li><li><a href=#%e6%9f%a5%e8%a1%a8%e6%b3%95 aria-label=查表法>查表法</a></li><li><a href=#%e4%bd%99%e9%a1%b9%e8%a1%a8%e7%94%9f%e6%88%90%e7%ae%97%e6%b3%95 aria-label=余项表生成算法>余项表生成算法</a></li></ul></div></details></div><div class=post-content><h2 id=什么是crc>什么是CRC<a hidden class=anchor aria-hidden=true href=#什么是crc>#</a></h2><p>循环冗余校验码 ( cyclie redundancy check ) 简称CRC（循环码）。</p><h2 id=crc算法原理>CRC算法原理<a hidden class=anchor aria-hidden=true href=#crc算法原理>#</a></h2><p>假如有数据A：<strong>1011 1001</strong></p><p>以 CRC-4 为例计算该数据的 CRC 码，它的多项式公式 <strong>g(x) = x⁴ + x + 1</strong> , 用二进制表示为 <strong>10011</strong></p><ul><li>计算它的 CRC 码（冗余位）：<ul><li>CRC-4 表示所得 CRC 码为 4 位，在数据 A 右侧补上 4 个 0，数据 A：<strong>1011 1001 0000</strong></li><li>数据A做被除数，用除数 <strong>10011</strong> 做<strong>模2除法</strong>，如下图</li></ul></li></ul><div align=left><img src=1.png style=max-height:320px></img></div><ul><li>关于模2除法：<ul><li>本质是<strong>异或运算</strong></li><li>舍去最左侧 0，以 1 对齐</li></ul></li></ul><p>最后结果 <strong>1001</strong> 就是 CRC 冗余位，将它附加在<strong>原数据帧末尾</strong>，构建成一个新的数据帧进行发送；最后接收方将<strong>整个</strong>数据帧以<strong>模2除法</strong>除相同的<strong>除数</strong>，如果没有余数，则说明数据帧在传输的过程中没有出错。</p><h2 id=crc算法参数模型>CRC算法参数模型<a hidden class=anchor aria-hidden=true href=#crc算法参数模型>#</a></h2><p>为了方便机器更好的计算CRC所以制定了一些规则，添加了一些参数参与计算，称为CRC参数模型。如 CRC-8、CRC-16/MODBUS、CRC-32。</p><ul><li>以CRC-16/MODBUS 为例，它的参数模型如下：</li></ul><table><thead><tr><th style=text-align:left>CRC算法名称</th><th style=text-align:left>多项式公式</th><th style=text-align:left>宽度</th><th style=text-align:left>多项式</th><th style=text-align:left>初始值</th><th style=text-align:left>结果异或值</th><th style=text-align:left>输入反转</th><th style=text-align:left>输出反转</th></tr></thead><tbody><tr><td style=text-align:left>CRC-4/ITU</td><td style=text-align:left>x⁴ + x + 1</td><td style=text-align:left>4</td><td style=text-align:left>03</td><td style=text-align:left>00</td><td style=text-align:left>00</td><td style=text-align:left>true</td><td style=text-align:left>true</td></tr><tr><td style=text-align:left>CRC-16/MODBUS</td><td style=text-align:left>x¹⁶ + x¹⁵ + x² + 1</td><td style=text-align:left>16</td><td style=text-align:left>8005</td><td style=text-align:left>FFFF</td><td style=text-align:left>0000</td><td style=text-align:left>true</td><td style=text-align:left>true</td></tr></tbody></table><ul><li><p><strong>CRC算法参数模型解释：</strong></p><ul><li><p><strong>CRC算法名称（NAME）</strong>：名称后面的数字就表示生成的冗余位的位数。</p></li><li><p><strong>宽度（WIDTH）</strong>：CRC 校验宽度，即 CRC 比特数。</p></li><li><p><strong>多项式（POLY）</strong>：生成项的简写，以16进制表示。例如：CRC-16/MODBUS 即是0x8005，<strong>忽略最高位的"1"</strong>，即完整的生成项是0x18005。</p></li><li><p><strong>初始值（INIT）</strong>：算法开始时计算（crc）的<strong>初始化预置值</strong>，一般取值FFFF或0000。当数据前几位为0时，因为模2除法会忽略0，先用FFFF异或将0取反为1，再进行模2除法，使数据开头的0也参与运算，以上是个人理解仅供参考。</p></li><li><p><strong>结果异或值（REFIN）</strong>：计算结果和该值异或运算。</p></li><li><p><strong>输入反转（REFOUT）</strong>：输入数据高低位互换，类似镜像。</p></li><li><p><strong>输出反转（XOROUT）</strong>：计算结果高低位互换，类似镜像。</p></li></ul></li></ul><h2 id=为什么可以忽略最高位的1>为什么可以忽略最高位的"1"<a hidden class=anchor aria-hidden=true href=#为什么可以忽略最高位的1>#</a></h2><p>以 CRC-4 为例，它的多项式公式 <strong>g(x) = x⁴ + x + 1</strong> , 用二进制表示为 <strong>10011</strong>，多项式用十六进制表示应该是13，为什么参数模型里用 03 表示？</p><p>再来观察上面的式子,看下图左侧，模2除法里除数和被除数左侧以 1 对齐后再异或运算，最左侧1在每次运算后都会被丢弃（因为 1 异或 1 为 0，而模 2 除法会舍去 0），并不会对最终结果产生影响</p><div align=left><img src=2.png style=max-height:320px></img></div><p>我们把除数左侧的 1 去掉，如图右侧所示，可以看出，只要将除数与被除数的第 2 位对齐再异或运算 ，最后结果是一样的，所以除数最高位1可以舍去，13 就可以简写为 03。</p><h2 id=直接计算法---正反向>直接计算法 - 正/反向<a hidden class=anchor aria-hidden=true href=#直接计算法---正反向>#</a></h2><ul><li><p>以CRC-16/MODBUS 参考模型为例编程</p><ul><li><p>第一步，输入数据反转，<strong>只反转单个字节不改变字节顺序</strong>，例如 0x0903 反转为 0x90C0</p></li><li><p>第二步，定义初始值 FFFF，以除数 8005 进行模 2 运算</p></li><li><p>最后，输出数据反转,<strong>反转整个CRC寄存器</strong>，例如 0x0903 反转为 0xC090</p></li></ul></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 字节反转 */</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>char</span> <span class=nf>Flip</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>((</span><span class=n>data</span><span class=o>&amp;</span><span class=mh>0x55</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=mi>1</span><span class=p>)</span><span class=o>|</span><span class=p>((</span><span class=n>data</span><span class=o>&amp;</span><span class=mh>0xaa</span><span class=p>)</span><span class=o>&gt;&gt;</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>((</span><span class=n>data</span><span class=o>&amp;</span><span class=mh>0x33</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=mi>2</span><span class=p>)</span><span class=o>|</span><span class=p>((</span><span class=n>data</span><span class=o>&amp;</span><span class=mh>0xcc</span><span class=p>)</span><span class=o>&gt;&gt;</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>((</span><span class=n>data</span><span class=o>&amp;</span><span class=mh>0x0f</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=mi>4</span><span class=p>)</span><span class=o>|</span><span class=p>((</span><span class=n>data</span><span class=o>&amp;</span><span class=mh>0xf0</span><span class=p>)</span><span class=o>&gt;&gt;</span><span class=mi>4</span><span class=p>);</span>   
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/* CRC算法正向 */</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>short</span> <span class=nf>CRC16</span><span class=p>(</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span> <span class=n>data</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>len</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=kt>int</span> <span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>CRC</span> <span class=o>=</span> <span class=mh>0xFFFF</span><span class=p>;</span>  <span class=cm>/* CRC寄存器，初始化预置值 */</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span><span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>CRC</span> <span class=o>^=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>short</span><span class=p>)</span><span class=nf>Flip</span><span class=p>(</span><span class=o>*</span><span class=n>data</span><span class=o>++</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=mi>8</span><span class=p>;</span>  <span class=cm>/* 单个字节反转 */</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span><span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span><span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span><span class=p>(</span><span class=n>CRC</span> <span class=o>&amp;</span> <span class=mh>0x8000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>CRC</span> <span class=o>=</span> <span class=n>CRC</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span> <span class=o>^</span> <span class=mh>0x8005</span><span class=p>;</span>
</span></span><span class=line><span class=cl>         <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>CRC</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* 全反转 */</span>
</span></span><span class=line><span class=cl>    <span class=n>CRC</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>short</span><span class=p>)</span><span class=nf>Flip</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=p>)</span><span class=n>CRC</span><span class=p>)</span><span class=o>&lt;&lt;</span><span class=mi>8</span><span class=o>|</span><span class=nf>Flip</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=p>)(</span><span class=n>CRC</span><span class=o>&gt;&gt;</span><span class=mi>8</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>CRC</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/* CRC算法反向，比正向效率要高，网上找的算法大多是反向的*/</span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>short</span> <span class=nf>CRC16_Rev</span><span class=p>(</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span> <span class=n>data</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>len</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=kt>int</span> <span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>CRC</span> <span class=o>=</span> <span class=mh>0xFFFF</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>   <span class=k>for</span><span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>CRC</span> <span class=o>^=</span> <span class=o>*</span><span class=n>data</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span><span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span><span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span><span class=p>(</span><span class=n>CRC</span> <span class=o>&amp;</span> <span class=mh>0x0001</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>CRC</span> <span class=o>=</span> <span class=n>CRC</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span> <span class=o>^</span> <span class=mh>0xA001</span><span class=p>;</span> <span class=cm>/* 8005反转就是A001 */</span>
</span></span><span class=line><span class=cl>         <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>CRC</span> <span class=o>&gt;&gt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=n>CRC</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>data</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0x01</span><span class=p>,</span><span class=mh>0x04</span><span class=p>,</span><span class=mh>0x00</span><span class=p>,</span><span class=mh>0x00</span><span class=p>,</span><span class=mh>0x00</span><span class=p>,</span><span class=mh>0x01</span><span class=p>};</span>
</span></span><span class=line><span class=cl>   <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=nf>CRC16</span><span class=p>(</span><span class=n>data</span><span class=p>,</span><span class=mi>6</span><span class=p>));</span>     <span class=cm>/* 正向 */</span>
</span></span><span class=line><span class=cl>   <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%x</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=nf>CRC16_Rev</span><span class=p>(</span><span class=n>data</span><span class=p>,</span><span class=mi>6</span><span class=p>));</span> <span class=cm>/* 反向 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nf>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这里举一个简单的例子。假设从设备地址为 1,要求读取输人寄存器地址 30001 的值，则 RTU 模式下具体的查询消息帧如下：
<strong>0x01，0x04，0x00，0x00，0x00，0x01，0x31，0xCA</strong>
其中，<strong>0xCA31</strong> 即为 CRC 值。因为 Modbus 规定发送时 CRC 必须低字节在前，高字节在后，因此实际的消息帧的发送顺序为 <strong>0x31,0xCA</strong>。</p><h2 id=查表法>查表法<a hidden class=anchor aria-hidden=true href=#查表法>#</a></h2><p>异或运算有结合律：<strong>(a^b)^c=a^(b^c)</strong></p><p>大概的原理如下图</p><div align=center><img src=3.png style=max-height:500px></img></div><p>8 位一共有 256 种结果，可以先将结果计算好后存入数组中。按 16 位查表太多有 65536 种结果。所以按 8 位查表是最合适的。</p><p>程序如下 ( CRC 反向算法的表 )</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>crc16_table</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x0000</span><span class=p>,</span> <span class=mh>0xc0c1</span><span class=p>,</span> <span class=mh>0xc181</span><span class=p>,</span> <span class=mh>0x0140</span><span class=p>,</span> <span class=mh>0xc301</span><span class=p>,</span> <span class=mh>0x03c0</span><span class=p>,</span> <span class=mh>0x0280</span><span class=p>,</span> <span class=mh>0xc241</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xc601</span><span class=p>,</span> <span class=mh>0x06c0</span><span class=p>,</span> <span class=mh>0x0780</span><span class=p>,</span> <span class=mh>0xc741</span><span class=p>,</span> <span class=mh>0x0500</span><span class=p>,</span> <span class=mh>0xc5c1</span><span class=p>,</span> <span class=mh>0xc481</span><span class=p>,</span> <span class=mh>0x0440</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xcc01</span><span class=p>,</span> <span class=mh>0x0cc0</span><span class=p>,</span> <span class=mh>0x0d80</span><span class=p>,</span> <span class=mh>0xcd41</span><span class=p>,</span> <span class=mh>0x0f00</span><span class=p>,</span> <span class=mh>0xcfc1</span><span class=p>,</span> <span class=mh>0xce81</span><span class=p>,</span> <span class=mh>0x0e40</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x0a00</span><span class=p>,</span> <span class=mh>0xcac1</span><span class=p>,</span> <span class=mh>0xcb81</span><span class=p>,</span> <span class=mh>0x0b40</span><span class=p>,</span> <span class=mh>0xc901</span><span class=p>,</span> <span class=mh>0x09c0</span><span class=p>,</span> <span class=mh>0x0880</span><span class=p>,</span> <span class=mh>0xc841</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xd801</span><span class=p>,</span> <span class=mh>0x18c0</span><span class=p>,</span> <span class=mh>0x1980</span><span class=p>,</span> <span class=mh>0xd941</span><span class=p>,</span> <span class=mh>0x1b00</span><span class=p>,</span> <span class=mh>0xdbc1</span><span class=p>,</span> <span class=mh>0xda81</span><span class=p>,</span> <span class=mh>0x1a40</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x1e00</span><span class=p>,</span> <span class=mh>0xdec1</span><span class=p>,</span> <span class=mh>0xdf81</span><span class=p>,</span> <span class=mh>0x1f40</span><span class=p>,</span> <span class=mh>0xdd01</span><span class=p>,</span> <span class=mh>0x1dc0</span><span class=p>,</span> <span class=mh>0x1c80</span><span class=p>,</span> <span class=mh>0xdc41</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x1400</span><span class=p>,</span> <span class=mh>0xd4c1</span><span class=p>,</span> <span class=mh>0xd581</span><span class=p>,</span> <span class=mh>0x1540</span><span class=p>,</span> <span class=mh>0xd701</span><span class=p>,</span> <span class=mh>0x17c0</span><span class=p>,</span> <span class=mh>0x1680</span><span class=p>,</span> <span class=mh>0xd641</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xd201</span><span class=p>,</span> <span class=mh>0x12c0</span><span class=p>,</span> <span class=mh>0x1380</span><span class=p>,</span> <span class=mh>0xd341</span><span class=p>,</span> <span class=mh>0x1100</span><span class=p>,</span> <span class=mh>0xd1c1</span><span class=p>,</span> <span class=mh>0xd081</span><span class=p>,</span> <span class=mh>0x1040</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xf001</span><span class=p>,</span> <span class=mh>0x30c0</span><span class=p>,</span> <span class=mh>0x3180</span><span class=p>,</span> <span class=mh>0xf141</span><span class=p>,</span> <span class=mh>0x3300</span><span class=p>,</span> <span class=mh>0xf3c1</span><span class=p>,</span> <span class=mh>0xf281</span><span class=p>,</span> <span class=mh>0x3240</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x3600</span><span class=p>,</span> <span class=mh>0xf6c1</span><span class=p>,</span> <span class=mh>0xf781</span><span class=p>,</span> <span class=mh>0x3740</span><span class=p>,</span> <span class=mh>0xf501</span><span class=p>,</span> <span class=mh>0x35c0</span><span class=p>,</span> <span class=mh>0x3480</span><span class=p>,</span> <span class=mh>0xf441</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x3c00</span><span class=p>,</span> <span class=mh>0xfcc1</span><span class=p>,</span> <span class=mh>0xfd81</span><span class=p>,</span> <span class=mh>0x3d40</span><span class=p>,</span> <span class=mh>0xff01</span><span class=p>,</span> <span class=mh>0x3fc0</span><span class=p>,</span> <span class=mh>0x3e80</span><span class=p>,</span> <span class=mh>0xfe41</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xfa01</span><span class=p>,</span> <span class=mh>0x3ac0</span><span class=p>,</span> <span class=mh>0x3b80</span><span class=p>,</span> <span class=mh>0xfb41</span><span class=p>,</span> <span class=mh>0x3900</span><span class=p>,</span> <span class=mh>0xf9c1</span><span class=p>,</span> <span class=mh>0xf881</span><span class=p>,</span> <span class=mh>0x3840</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x2800</span><span class=p>,</span> <span class=mh>0xe8c1</span><span class=p>,</span> <span class=mh>0xe981</span><span class=p>,</span> <span class=mh>0x2940</span><span class=p>,</span> <span class=mh>0xeb01</span><span class=p>,</span> <span class=mh>0x2bc0</span><span class=p>,</span> <span class=mh>0x2a80</span><span class=p>,</span> <span class=mh>0xea41</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xee01</span><span class=p>,</span> <span class=mh>0x2ec0</span><span class=p>,</span> <span class=mh>0x2f80</span><span class=p>,</span> <span class=mh>0xef41</span><span class=p>,</span> <span class=mh>0x2d00</span><span class=p>,</span> <span class=mh>0xedc1</span><span class=p>,</span> <span class=mh>0xec81</span><span class=p>,</span> <span class=mh>0x2c40</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xe401</span><span class=p>,</span> <span class=mh>0x24c0</span><span class=p>,</span> <span class=mh>0x2580</span><span class=p>,</span> <span class=mh>0xe541</span><span class=p>,</span> <span class=mh>0x2700</span><span class=p>,</span> <span class=mh>0xe7c1</span><span class=p>,</span> <span class=mh>0xe681</span><span class=p>,</span> <span class=mh>0x2640</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x2200</span><span class=p>,</span> <span class=mh>0xe2c1</span><span class=p>,</span> <span class=mh>0xe381</span><span class=p>,</span> <span class=mh>0x2340</span><span class=p>,</span> <span class=mh>0xe101</span><span class=p>,</span> <span class=mh>0x21c0</span><span class=p>,</span> <span class=mh>0x2080</span><span class=p>,</span> <span class=mh>0xe041</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xa001</span><span class=p>,</span> <span class=mh>0x60c0</span><span class=p>,</span> <span class=mh>0x6180</span><span class=p>,</span> <span class=mh>0xa141</span><span class=p>,</span> <span class=mh>0x6300</span><span class=p>,</span> <span class=mh>0xa3c1</span><span class=p>,</span> <span class=mh>0xa281</span><span class=p>,</span> <span class=mh>0x6240</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x6600</span><span class=p>,</span> <span class=mh>0xa6c1</span><span class=p>,</span> <span class=mh>0xa781</span><span class=p>,</span> <span class=mh>0x6740</span><span class=p>,</span> <span class=mh>0xa501</span><span class=p>,</span> <span class=mh>0x65c0</span><span class=p>,</span> <span class=mh>0x6480</span><span class=p>,</span> <span class=mh>0xa441</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x6c00</span><span class=p>,</span> <span class=mh>0xacc1</span><span class=p>,</span> <span class=mh>0xad81</span><span class=p>,</span> <span class=mh>0x6d40</span><span class=p>,</span> <span class=mh>0xaf01</span><span class=p>,</span> <span class=mh>0x6fc0</span><span class=p>,</span> <span class=mh>0x6e80</span><span class=p>,</span> <span class=mh>0xae41</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xaa01</span><span class=p>,</span> <span class=mh>0x6ac0</span><span class=p>,</span> <span class=mh>0x6b80</span><span class=p>,</span> <span class=mh>0xab41</span><span class=p>,</span> <span class=mh>0x6900</span><span class=p>,</span> <span class=mh>0xa9c1</span><span class=p>,</span> <span class=mh>0xa881</span><span class=p>,</span> <span class=mh>0x6840</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x7800</span><span class=p>,</span> <span class=mh>0xb8c1</span><span class=p>,</span> <span class=mh>0xb981</span><span class=p>,</span> <span class=mh>0x7940</span><span class=p>,</span> <span class=mh>0xbb01</span><span class=p>,</span> <span class=mh>0x7bc0</span><span class=p>,</span> <span class=mh>0x7a80</span><span class=p>,</span> <span class=mh>0xba41</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xbe01</span><span class=p>,</span> <span class=mh>0x7ec0</span><span class=p>,</span> <span class=mh>0x7f80</span><span class=p>,</span> <span class=mh>0xbf41</span><span class=p>,</span> <span class=mh>0x7d00</span><span class=p>,</span> <span class=mh>0xbdc1</span><span class=p>,</span> <span class=mh>0xbc81</span><span class=p>,</span> <span class=mh>0x7c40</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0xb401</span><span class=p>,</span> <span class=mh>0x74c0</span><span class=p>,</span> <span class=mh>0x7580</span><span class=p>,</span> <span class=mh>0xb541</span><span class=p>,</span> <span class=mh>0x7700</span><span class=p>,</span> <span class=mh>0xb7c1</span><span class=p>,</span> <span class=mh>0xb681</span><span class=p>,</span> <span class=mh>0x7640</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x7200</span><span class=p>,</span> <span class=mh>0xb2c1</span><span class=p>,</span> <span class=mh>0xb381</span><span class=p>,</span> <span class=mh>0x7340</span><span class=p>,</span> <span class=mh>0xb101</span><span class=p>,</span> <span class=mh>0x71c0</span><span class=p>,</span> <span class=mh>0x7080</span><span class=p>,</span> <span class=mh>0xb041</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x5000</span><span class=p>,</span> <span class=mh>0x90c1</span><span class=p>,</span> <span class=mh>0x9181</span><span class=p>,</span> <span class=mh>0x5140</span><span class=p>,</span> <span class=mh>0x9301</span><span class=p>,</span> <span class=mh>0x53c0</span><span class=p>,</span> <span class=mh>0x5280</span><span class=p>,</span> <span class=mh>0x9241</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x9601</span><span class=p>,</span> <span class=mh>0x56c0</span><span class=p>,</span> <span class=mh>0x5780</span><span class=p>,</span> <span class=mh>0x9741</span><span class=p>,</span> <span class=mh>0x5500</span><span class=p>,</span> <span class=mh>0x95c1</span><span class=p>,</span> <span class=mh>0x9481</span><span class=p>,</span> <span class=mh>0x5440</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x9c01</span><span class=p>,</span> <span class=mh>0x5cc0</span><span class=p>,</span> <span class=mh>0x5d80</span><span class=p>,</span> <span class=mh>0x9d41</span><span class=p>,</span> <span class=mh>0x5f00</span><span class=p>,</span> <span class=mh>0x9fc1</span><span class=p>,</span> <span class=mh>0x9e81</span><span class=p>,</span> <span class=mh>0x5e40</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x5a00</span><span class=p>,</span> <span class=mh>0x9ac1</span><span class=p>,</span> <span class=mh>0x9b81</span><span class=p>,</span> <span class=mh>0x5b40</span><span class=p>,</span> <span class=mh>0x9901</span><span class=p>,</span> <span class=mh>0x59c0</span><span class=p>,</span> <span class=mh>0x5880</span><span class=p>,</span> <span class=mh>0x9841</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x8801</span><span class=p>,</span> <span class=mh>0x48c0</span><span class=p>,</span> <span class=mh>0x4980</span><span class=p>,</span> <span class=mh>0x8941</span><span class=p>,</span> <span class=mh>0x4b00</span><span class=p>,</span> <span class=mh>0x8bc1</span><span class=p>,</span> <span class=mh>0x8a81</span><span class=p>,</span> <span class=mh>0x4a40</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x4e00</span><span class=p>,</span> <span class=mh>0x8ec1</span><span class=p>,</span> <span class=mh>0x8f81</span><span class=p>,</span> <span class=mh>0x4f40</span><span class=p>,</span> <span class=mh>0x8d01</span><span class=p>,</span> <span class=mh>0x4dc0</span><span class=p>,</span> <span class=mh>0x4c80</span><span class=p>,</span> <span class=mh>0x8c41</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x4400</span><span class=p>,</span> <span class=mh>0x84c1</span><span class=p>,</span> <span class=mh>0x8581</span><span class=p>,</span> <span class=mh>0x4540</span><span class=p>,</span> <span class=mh>0x8701</span><span class=p>,</span> <span class=mh>0x47c0</span><span class=p>,</span> <span class=mh>0x4680</span><span class=p>,</span> <span class=mh>0x8641</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=mh>0x8201</span><span class=p>,</span> <span class=mh>0x42c0</span><span class=p>,</span> <span class=mh>0x4380</span><span class=p>,</span> <span class=mh>0x8341</span><span class=p>,</span> <span class=mh>0x4100</span><span class=p>,</span> <span class=mh>0x81c1</span><span class=p>,</span> <span class=mh>0x8081</span><span class=p>,</span> <span class=mh>0x4040</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>short</span> <span class=nf>CRC16</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span> <span class=n>data</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>len</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>crc</span>   <span class=o>=</span> <span class=mh>0xFFFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span>  <span class=n>index</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span>  <span class=o>*</span><span class=n>p</span>    <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=n>len</span><span class=o>--</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    	<span class=n>index</span> <span class=o>=</span> <span class=o>*</span><span class=n>p</span><span class=o>++</span> <span class=o>^</span> <span class=n>crc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    	<span class=n>crc</span> <span class=o>&gt;&gt;=</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    	<span class=n>crc</span>  <span class=o>^=</span> <span class=n>crc16_table</span><span class=p>[</span><span class=n>index</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>crc</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>crc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>char</span>  <span class=n>data</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=mh>0x01</span><span class=p>,</span><span class=mh>0x04</span><span class=p>,</span><span class=mh>0x00</span><span class=p>,</span><span class=mh>0x00</span><span class=p>,</span><span class=mh>0x00</span><span class=p>,</span><span class=mh>0x01</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>crc</span> <span class=o>=</span> <span class=nf>CRC16</span><span class=p>(</span><span class=n>data</span><span class=p>,</span><span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%x &#34;</span><span class=p>,</span><span class=n>crc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=余项表生成算法>余项表生成算法<a hidden class=anchor aria-hidden=true href=#余项表生成算法>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=cm>/*余项表生成函数*/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>generate_table</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>short</span> <span class=o>*</span> <span class=n>crc16_table</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>poly</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>crc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>256</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    	<span class=n>crc</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    	<span class=k>for</span><span class=p>(</span><span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=n>crc</span> <span class=o>&amp;</span> <span class=mh>0x0001</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>crc</span> <span class=o>=</span> <span class=p>(</span><span class=n>crc</span> <span class=o>&gt;&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>^</span> <span class=mh>0xa001</span><span class=p>;</span>	
</span></span><span class=line><span class=cl>            <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>crc</span> <span class=o>&gt;&gt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    	<span class=p>}</span>
</span></span><span class=line><span class=cl>    	<span class=n>crc16_table</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>crc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/*打印表*/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>print_table</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>short</span> <span class=o>*</span> <span class=n>crc16_table</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;unsigned short crc16_table[] = {</span><span class=se>\n</span><span class=s>    &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>256</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    	<span class=nf>printf</span><span class=p>(</span><span class=s>&#34;0x%04x, &#34;</span><span class=p>,</span><span class=n>crc16_table</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    	<span class=k>if</span><span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=mi>255</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    	    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\b\b</span><span class=s> &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=p>((</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>%</span><span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    	    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>    &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\b\b\b\b</span><span class=s>};</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>crc16_table</span><span class=p>[</span><span class=mi>256</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>poly</span> <span class=o>=</span> <span class=mh>0xA001</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>generate_table</span><span class=p>(</span><span class=n>crc16_table</span><span class=p>,</span><span class=n>poly</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>print_table</span><span class=p>(</span><span class=n>crc16_table</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://kingtuo123.com/tags/modbus/>Modbus</a></li><li><a href=https://kingtuo123.com/tags/crc/>CRC</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://kingtuo123.com/>Notes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><div class=footer align=center style=margin-top:-30px><a href=https://beian.miit.gov.cn/ target=_blank>浙ICP备19041170号</a></div><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>